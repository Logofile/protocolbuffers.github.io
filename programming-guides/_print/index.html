<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.107.0"><link rel=canonical type=text/html href=/programming-guides/><link rel=alternate type=application/rss+xml href=/programming-guides/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Programming Guides | Protocol Buffers Documentation</title><meta name=description content="Learn how to use Protocol Buffers in your projects."><meta property="og:title" content="Programming Guides"><meta property="og:description" content="Learn how to use Protocol Buffers in your projects."><meta property="og:type" content="website"><meta property="og:url" content="/programming-guides/"><meta property="og:site_name" content="Protocol Buffers Documentation"><meta itemprop=name content="Programming Guides"><meta itemprop=description content="Learn how to use Protocol Buffers in your projects."><meta name=twitter:card content="summary"><meta name=twitter:title content="Programming Guides"><meta name=twitter:description content="Learn how to use Protocol Buffers in your projects."><link rel=preload href=/scss/main.min.def2cdda5cfcd95d9660c969a68946395435ad5fc75402be473d9995c7e926b3.css as=style><link href=/scss/main.min.def2cdda5cfcd95d9660c969a68946395435ad5fc75402be473d9995c7e926b3.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5L8P8GRN4Y"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5L8P8GRN4Y")}</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=navbar-brand__name>Protocol Buffers Documentation</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"></ul></div><div class="navbar-nav d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/programming-guides/>Return to the regular view of this page</a>.</p></div><h1 class=title>Programming Guides</h1><div class=lead>Learn how to use Protocol Buffers in your projects.</div><ul><li>1: <a href=#pg-49c97596ddab1474e02fb0914eef092e>Language Guide (proto 2)</a></li><li>2: <a href=#pg-903088f4024e6a3ca0c66491de0e198b>Language Guide (proto 3)</a></li><li>3: <a href=#pg-366470fab6e216998242d3b41ea134ab>Style Guide</a></li><li>4: <a href=#pg-9b592df4dc43102283594f5f70fe2cf7>Encoding</a></li><li>5: <a href=#pg-fa336b657b9e453f981ed82e9bb9c74d>Techniques</a></li><li>6: <a href=#pg-38218c06f0c50d02df79bc8a0d2f405c>Third-party Add-ons</a></li><li>7: <a href=#pg-43407619ac03371a42554d0fa219232f>Application Note: Field Presence</a></li><li>8: <a href=#pg-87a56dbd37aef4111f82cb234bba8f3f>Proto Best Practices</a></li><li>9: <a href=#pg-391f33cde0acfde6f33069ed48988f1d>API Best Practices</a></li></ul><div class=content><ul><li><a href=/programming-guides/proto>Language Guide (proto2)</a></li><li><a href=/programming-guides/proto3>Language Guide (proto3)</a></li><li><a href=/programming-guides/style>Style Guide</a></li><li><a href=/programming-guides/encoding>Encoding</a></li><li><a href=/programming-guides/techniques>Techniques</a></li><li><a href=/programming-guides/addons>Add-ons</a></li></ul></div></div><div class=td-content><h1 id=pg-49c97596ddab1474e02fb0914eef092e>1 - Language Guide (proto 2)</h1><div class=lead>This topic covers how to use the version 2 of Protocol Buffers in your project. It contains language-agnostic content. For information specific to the language you&rsquo;re using, see the corresponding documentation for your language.</div><p>This guide describes how to use the protocol buffer language to structure your
protocol buffer data, including <code>.proto</code> file syntax and how to generate data
access classes from your <code>.proto</code> files. It covers the <strong>proto2</strong> version of the
protocol buffers language: for information on <strong>proto3</strong> syntax, see the
<a href=/programming-guides/proto3>Proto3 Language Guide</a>.</p><p>This is a reference guide – for a step by step example that uses many of the
features described in this document, see the
<a href=/getting-started>tutorial</a> for your chosen language.</p><h2 id=simple>Defining A Message Type</h2><p>First let&rsquo;s look at a very simple example. Let&rsquo;s say you want to define a search
request message format, where each search request has a query string, the
particular page of results you are interested in, and a number of results per
page. Here&rsquo;s the <code>.proto</code> file you use to define the message type.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>required</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>query</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_number</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>result_per_page</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>The <code>SearchRequest</code> message definition specifies three fields (name/value
pairs), one for each piece of data that you want to include in this type of
message. Each field has a name and a type.</p><h3 id=specifying-types>Specifying Field Types</h3><p>In the above example, all the fields are <a href=#scalar>scalar types</a>: two integers
(<code>page_number</code> and <code>result_per_page</code>) and a string (<code>query</code>). You can also
specify <a href=#enum>enumerations</a> and composite types like other message types for
your field.</p><h3 id=assigning>Assigning Field Numbers</h3><p>As you can see, each field in the message definition has a <strong>unique number</strong>.
These numbers are used to identify your fields in the
<a href=/programming-guides/encoding>message binary format</a>,
and should not be changed once your message type is in use. Field numbers in the
range 1 through 15 take one byte to encode, including the field number and the
field&rsquo;s type (you can find out more about this in
<a href=/programming-guides/encoding#structure>Protocol Buffer Encoding</a>).
Field numbers in the range 16 through 2047 take two bytes. So you should reserve
the field numbers 1 through 15 for message elements that occur very frequently.
Remember to leave some room for frequently occurring elements that might be
added in the future.</p><p>The smallest field number you can specify is 1, and the largest is
2<sup>29</sup> - 1, or 536,870,911. You also cannot use the numbers 19000
through 19999 (<code>FieldDescriptor::kFirstReservedNumber</code> through
<code>FieldDescriptor::kLastReservedNumber</code>), as they are reserved for the Protocol
Buffers implementation - the protocol buffer compiler will complain if you use
one of these reserved numbers in your <code>.proto</code>. Similarly, you cannot use any
previously <a href=#reserved>reserved</a> field numbers.</p><h3 id=specifying-rules>Specifying Field Rules</h3><p>You specify that message fields are one of the following:</p><ul><li><code>required</code>: a well-formed message must have exactly one of this field.</li><li><code>optional</code>: a well-formed message can have zero or one of this field (but
not more than one).</li><li><code>repeated</code>: this field can be repeated any number of times (including zero)
in a well-formed message. The order of the repeated values will be
preserved.</li></ul><p>For historical reasons, <code>repeated</code> fields of scalar numeric types (for example,
<code>int32</code>, <code>int64</code>, <code>enum</code>) aren&rsquo;t encoded as efficiently as they could be. New
code should use the special option <code>[packed = true]</code> to get a more efficient
encoding. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>samples</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>packed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>ProtoEnum</span> <span style=color:#000>results</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>packed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>You can find out more about <code>packed</code> encoding in
<a href=/programming-guides/encoding#packed>Protocol Buffer Encoding</a>.</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Important</h4><strong>Required Is Forever</strong>
You should be very careful about marking fields as <code>required</code>. If at some point
you wish to stop writing or sending a required field, it will be problematic to
change the field to an optional field – old readers will consider messages
without this field to be incomplete and may reject or drop them unintentionally.
You should consider writing application-specific custom validation routines for
your buffers instead.</div><p>A second issue with required fields appears when someone adds a value to an
enum. In this case, the unrecognized enum value is treated as if it were
missing, which also causes the required value check to fail.</p><h3 id=adding-types>Adding More Message Types</h3><p>Multiple message types can be defined in a single <code>.proto</code> file. This is useful
if you are defining multiple related messages – so, for example, if you wanted
to define the reply message format that corresponds to your <code>SearchResponse</code>
message type, you could add it to the same <code>.proto</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>required</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>query</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_number</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>result_per_page</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span> <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p><strong>Combining Messages leads to bloat</strong> While multiple message types (such as
message, enum, and service) can be defined in a single <code>.proto</code> file, it can
also lead to dependency bloat when large numbers of messages with varying
dependencies are defined in a single file. It&rsquo;s recommended to include as few
message types per <code>.proto</code> file as possible.</p><h3 id=adding-comments>Adding Comments</h3><p>To add comments to your <code>.proto</code> files, use C/C++-style <code>//</code> and <code>/* ... */</code>
syntax.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>/* SearchRequest represents a search query, with pagination options to
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * indicate which results to include in the response. */</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>required</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>query</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_number</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// Which page number do we want?
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>result_per_page</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// Number of results to return per page.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h3 id=reserved>Reserved Fields</h3><p>If you <a href=#updating>update</a> a message type by entirely removing a field, or
commenting it out, future users can reuse the field number when making their own
updates to the type. This can cause severe issues if they later load old
versions of the same <code>.proto</code>, including data corruption, privacy bugs, and so
on. One way to make sure this doesn&rsquo;t happen is to specify that the field
numbers (and/or names, which can also cause issues for JSON serialization) of
your deleted fields are <code>reserved</code>. The protocol buffer compiler will complain
if any future users try to use these field identifiers.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>reserved</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#204a87;font-weight:700>to</span> <span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>reserved</span> <span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Reserved field number ranges are inclusive (<code>9 to 11</code> is the same as <code>9, 10, 11</code>). Note that you can&rsquo;t mix field names and field numbers in the same
<code>reserved</code> statement.</p><h3 id=generated>What&rsquo;s Generated From Your <code>.proto</code>?</h3><p>When you run the <a href=#generating>protocol buffer compiler</a> on a <code>.proto</code>, the
compiler generates the code in your chosen language you&rsquo;ll need to work with the
message types you&rsquo;ve described in the file, including getting and setting field
values, serializing your messages to an output stream, and parsing your messages
from an input stream.</p><ul><li>For <strong>C++</strong>, the compiler generates a <code>.h</code> and <code>.cc</code> file from each
<code>.proto</code>, with a class for each message type described in your file.</li><li>For <strong>Java</strong>, the compiler generates a <code>.java</code> file with a class for each
message type, as well as special <code>Builder</code> classes for creating message
class instances.</li><li><strong>Python</strong> is a little different – the Python compiler generates a module
with a static descriptor of each message type in your <code>.proto</code>, which is
then used with a <em>metaclass</em> to create the necessary Python data access
class at runtime.</li><li>For <strong>Go</strong>, the compiler generates a <code>.pb.go</code> file with a type for each
message type in your file.</li></ul><p>You can find out more about using the APIs for each language by following the
tutorial for your chosen language. For even more API details, see the relevant
<a href=/reference/>API reference</a>.</p><h2 id=scalar>Scalar Value Types</h2><p>A scalar message field can have one of the following types – the table shows the
type specified in the <code>.proto</code> file, and the corresponding type in the
automatically generated class:</p><table border=1><tbody><tr><th>.proto Type</th><th>Notes</th><th>C++ Type</th><th>Java Type</th><th>Python Type<sup>[2]</sup></th><th>Go Type</th></tr><tr><td>double</td><td></td><td>double</td><td>double</td><td>float</td><td>*float64</td></tr><tr><td>float</td><td></td><td>float</td><td>float</td><td>float</td><td>*float32</td></tr><tr><td>int32</td><td>Uses variable-length encoding. Inefficient for encoding negative numbers – if your field is likely to have negative values, use sint32 instead.</td><td>int32</td><td>int</td><td>int</td><td>*int32</td></tr><tr><td>int64</td><td>Uses variable-length encoding. Inefficient for encoding negative numbers – if your field is likely to have negative values, use sint64 instead.</td><td>int64</td><td>long</td><td>int/long<sup>[3]</sup></td><td>*int64</td></tr><tr><td>uint32</td><td>Uses variable-length encoding.</td><td>uint32</td><td>int<sup>[1]</sup></td><td>int/long<sup>[3]</sup></td><td>*uint32</td></tr><tr><td>uint64</td><td>Uses variable-length encoding.</td><td>uint64</td><td>long<sup>[1]</sup></td><td>int/long<sup>[3]</sup></td><td>*uint64</td></tr><tr><td>sint32</td><td>Uses variable-length encoding. Signed int value. These more efficiently encode negative numbers than regular int32s.</td><td>int32</td><td>int</td><td>int</td><td>*int32</td></tr><tr><td>sint64</td><td>Uses variable-length encoding. Signed int value. These more efficiently encode negative numbers than regular int64s.</td><td>int64</td><td>long</td><td>int/long<sup>[3]</sup></td><td>*int64</td></tr><tr><td>fixed32</td><td>Always four bytes. More efficient than uint32 if values are often greater than 2<sup>28</sup>.</td><td>uint32</td><td>int<sup>[1]</sup></td><td>int/long<sup>[3]</sup></td><td>*uint32</td></tr><tr><td>fixed64</td><td>Always eight bytes. More efficient than uint64 if values are often greater than 2<sup>56</sup>.</td><td>uint64</td><td>long<sup>[1]</sup></td><td>int/long<sup>[3]</sup></td><td>*uint64</td></tr><tr><td>sfixed32</td><td>Always four bytes.</td><td>int32</td><td>int</td><td>int</td><td>*int32</td></tr><tr><td>sfixed64</td><td>Always eight bytes.</td><td>int64</td><td>long</td><td>int/long<sup>[3]</sup></td><td>*int64</td></tr><tr><td>bool</td><td></td><td>bool</td><td>boolean</td><td>bool</td><td>*bool</td></tr><tr><td>string</td><td>A string must always contain UTF-8 encoded text.</td><td>string</td><td>String</td><td>unicode (Python 2) or str (Python 3)</td><td>*string</td></tr><tr><td>bytes</td><td>May contain any arbitrary sequence of bytes.</td><td>string</td><td>ByteString</td><td>bytes</td><td>[]byte</td></tr></tbody></table><p>You can find out more about how these types are encoded when you serialize your
message in
<a href=/programming-guides/encoding>Protocol Buffer Encoding</a>.</p><p><sup>[1]</sup> In Java, unsigned 32-bit and 64-bit integers are represented
using their signed counterparts, with the top bit simply being stored in the
sign bit.</p><p><sup>[2]</sup> In all cases, setting values to a field will perform type
checking to make sure it is valid.</p><p><sup>[3]</sup> 64-bit or unsigned 32-bit integers are always represented as long
when decoded, but can be an int if an int is given when setting the field. In
all cases, the value must fit in the type represented when set. See [2].</p><h2 id=optional>Optional Fields And Default Values</h2><p>As mentioned above, elements in a message description can be labeled <code>optional</code>.
A well-formed message may or may not contain an optional element. When a message
is parsed, if it does not contain an optional element, accessing the
corresponding field in the parsed object returns the default value for that
field. The default value can be specified as part of the message description.
For example, let&rsquo;s say you want to provide a default value of 10 for a
<code>SearchRequest</code>&rsquo;s <code>result_per_page</code> value.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>result_per_page</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>default</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>If the default value is not specified for an optional element, a type-specific
default value is used instead: for strings, the default value is the empty
string. For bytes, the default value is the empty byte string. For bools, the
default value is false. For numeric types, the default value is zero. For enums,
the default value is the first value listed in the enum&rsquo;s type definition. This
means care must be taken when adding a value to the beginning of an enum value
list. See the <a href=#updating>Updating A Message Type</a> section for guidelines on how
to safely change definitions.</p><h2 id=enum>Enumerations</h2><p>When you&rsquo;re defining a message type, you might want one of its fields to only
have one of a pre-defined list of values. For example, let&rsquo;s say you want to add
a <code>corpus</code> field for each <code>SearchRequest</code>, where the corpus can be <code>UNIVERSAL</code>,
<code>WEB</code>, <code>IMAGES</code>, <code>LOCAL</code>, <code>NEWS</code>, <code>PRODUCTS</code> or <code>VIDEO</code>. You can do this very
simply by adding an <code>enum</code> to your message definition - a field with an <code>enum</code>
type can only have one of a specified set of constants as its value (if you try
to provide a different value, the parser will treat it like an unknown field).
In the following example we&rsquo;ve added an <code>enum</code> called <code>Corpus</code> with all the
possible values, and a field of type <code>Corpus</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>Corpus</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_UNSPECIFIED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_UNIVERSAL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_WEB</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_IMAGES</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_LOCAL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_NEWS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_PRODUCTS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_VIDEO</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>required</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>query</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_number</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>result_per_page</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>default</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>Corpus</span> <span style=color:#000>corpus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>default</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CORPUS_UNIVERSAL</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>You can define aliases by assigning the same value to different enum constants.
To do this you need to set the <code>allow_alias</code> option to <code>true</code>. Otherwise, the
protocol buffer compiler generates a warning message when aliases are
found. Though all alias values are valid during deserialization, the first value
is always used when serializing.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EnumAllowingAlias</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>allow_alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>EAA_UNSPECIFIED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>EAA_UNKNOWN</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>EAA_STARTED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>EAA_RUNNING</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EnumNotAllowingAlias</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>ENAA_UNSPECIFIED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>ENAA_STARTED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// ENAA_RUNNING = 1;  // Uncommenting this line will cause a warning message.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>ENAA_FINISHED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Enumerator constants must be in the range of a 32-bit integer. Since <code>enum</code>
values use
<a href=/programming-guides/encoding>varint encoding</a> on the
wire, negative values are inefficient and thus not recommended. You can define
<code>enum</code>s within a message definition or outside – these <code>enum</code>s can be reused in
any message definition in your <code>.proto</code> file. You can also use an <code>enum</code> type
declared in one message as the type of a field in a different message, using the
syntax <code>_MessageType_._EnumType_</code>.</p><p>When you run the protocol buffer compiler on a <code>.proto</code> that uses an <code>enum</code>, the
generated code will have a corresponding <code>enum</code> for Java or C++, or a special
<code>EnumDescriptor</code> class for Python that&rsquo;s used to create a set of symbolic
constants with integer values in the runtime-generated class.</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Important</h4>The
generated code may be subject to language-specific limitations on the number of
enumerators (low thousands for one language). Review the limitations for the
languages you plan to use.</div><p>For more information about how to work with message <code>enum</code>s in your
applications, see the <a href=/reference/>generated code guide</a>
for your chosen language.</p><h3 id=reserved>Reserved Values</h3><p>If you <a href=#updating>update</a> an enum type by entirely removing an enum entry, or
commenting it out, future users can reuse the numeric value when making their
own updates to the type. This can cause severe issues if they later load old
versions of the same <code>.proto</code>, including data corruption, privacy bugs, and so
on. One way to make sure this doesn&rsquo;t happen is to specify that the numeric
values (and/or names, which can also cause issues for JSON serialization) of
your deleted entries are <code>reserved</code>. The protocol buffer compiler will complain
if any future users try to use these identifiers. You can specify that your
reserved numeric value range goes up to the maximum possible value using the
<code>max</code> keyword.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>reserved</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#204a87;font-weight:700>to</span> <span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>40</span> <span style=color:#204a87;font-weight:700>to</span> <span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>reserved</span> <span style=color:#4e9a06>&#34;FOO&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;BAR&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Note that you can&rsquo;t mix field names and numeric values in the same <code>reserved</code>
statement.</p><h2 id=other>Using Other Message Types</h2><p>You can use other message types as field types. For example, let&rsquo;s say you
wanted to include <code>Result</code> messages in each <code>SearchResponse</code> message – to do
this, you can define a <code>Result</code> message type in the same <code>.proto</code> and then
specify a field of type <code>Result</code> in <code>SearchResponse</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>Result</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Result</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>required</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>title</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>snippets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h3 id=importing>Importing Definitions</h3><p>In the above example, the <code>Result</code> message type is defined in the same file as
<code>SearchResponse</code> – what if the message type you want to use as a field type is
already defined in another <code>.proto</code> file?</p><p>You can use definitions from other <code>.proto</code> files by <em>importing</em> them. To import
another <code>.proto</code>&rsquo;s definitions, you add an import statement to the top of your
file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;myproject/other_protos.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>By default, you can use definitions only from directly imported <code>.proto</code> files.
However, sometimes you may need to move a <code>.proto</code> file to a new location.
Instead of moving the <code>.proto</code> file directly and updating all the call sites in
a single change, you can put a placeholder <code>.proto</code> file in the old location to
forward all the imports to the new location using the <code>import public</code> notion.</p><p><strong>Note that the public import functionality is not available in Java.</strong></p><p><code>import public</code> dependencies can be transitively relied upon by any code
importing the proto containing the <code>import public</code> statement. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// new.proto
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// All definitions are moved here
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// old.proto
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// This is the proto that all clients are importing.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>public</span> <span style=color:#4e9a06>&#34;new.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;other.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// client.proto
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;old.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// You use definitions from old.proto and new.proto, but not other.proto
</span></span></span></code></pre></div><p>The protocol compiler searches for imported files in a set of directories
specified on the protocol compiler command line using the <code>-I</code>/<code>--proto_path</code>
flag. If no flag was given, it looks in the directory in which the compiler was
invoked. In general you should set the <code>--proto_path</code> flag to the root of your
project and use fully qualified names for all imports.</p><h3 id=proto3>Using proto3 Message Types</h3><p>It&rsquo;s possible to import
<a href=/programming-guides/proto3>proto3</a> message types and
use them in your proto2 messages, and vice versa. However, proto2 enums cannot
be used in proto3 syntax.</p><h2 id=nested>Nested Types</h2><p>You can define and use message types inside other message types, as in the
following example – here the <code>Result</code> message is defined inside the
<code>SearchResponse</code> message:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Result</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>required</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>title</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>snippets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>Result</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>If you want to reuse this message type outside its parent message type, you
refer to it as <code>_Parent_._Type_</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SomeOtherMessage</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>SearchResponse.Result</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>You can nest messages as deeply as you like. In the example below, note that the
two nested types named <code>Inner</code> are entirely independent, since they are defined
within different messages:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Outer</span> <span style=color:#000;font-weight:700>{</span>       <span style=color:#8f5902;font-style:italic>// Level 0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>MiddleAA</span> <span style=color:#000;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>// Level 1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Inner</span> <span style=color:#000;font-weight:700>{</span>   <span style=color:#8f5902;font-style:italic>// Level 2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#000>ival</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>      <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span>  <span style=color:#000>booly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>MiddleBB</span> <span style=color:#000;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>// Level 1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Inner</span> <span style=color:#000;font-weight:700>{</span>   <span style=color:#8f5902;font-style:italic>// Level 2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>      <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span>   <span style=color:#000>flag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h3 id=groups>Groups</h3><p><strong>Note that the groups feature is deprecated and should not be used when
creating new message types. Use nested message types instead.</strong></p><p>Groups are another way to nest information in your message definitions. For
example, another way to specify a <code>SearchResponse</code> containing a number of
<code>Result</code>s is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>group</span> <span style=color:#000>Result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>required</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>title</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>snippets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>A group simply combines a nested message type and a field into a single
declaration. In your code, you can treat this message just as if it had a
<code>Result</code> type field called <code>result</code> (the latter name is converted to lower-case
so that it does not conflict with the former). Therefore, this example is
exactly equivalent to the <code>SearchResponse</code> above, except that the message has a
different <a href=/programming-guides/encoding>wire format</a>.</p><h2 id=updating>Updating A Message Type</h2><p>If an existing message type no longer meets all your needs – for example, you&rsquo;d
like the message format to have an extra field – but you&rsquo;d still like to use
code created with the old format, don&rsquo;t worry! It&rsquo;s very simple to update
message types without breaking any of your existing code when you use the binary
wire format.</p><div class="alert alert-note" role=alert><h4 class=alert-heading>Note</h4>If
you use JSON or
<a href=/reference/protobuf/textformat-spec>proto text format</a>
to store your protocol buffer messages, the changes that you can make in your
proto definition are different.</div><p>If your use case isn&rsquo;t covered in the safe-or-not tool, check
<a href=/programming-guides/dos-donts>Proto Best Practices</a> and
the following rules:</p><ul><li>Don&rsquo;t change the field numbers for any existing fields.</li><li>Any new fields that you add should be <code>optional</code> or <code>repeated</code>. This means
that any messages serialized by code using your &ldquo;old&rdquo; message format can be
parsed by your new generated code, as they won&rsquo;t be missing any <code>required</code>
elements. You should set up sensible <a href=#optional>default values</a> for these
elements so that new code can properly interact with messages generated by
old code. Similarly, messages created by your new code can be parsed by your
old code: old binaries simply ignore the new field when parsing. However,
the unknown fields are not discarded, and if the message is later
serialized, the unknown fields are serialized along with it – so if the
message is passed on to new code, the new fields are still available.</li><li>Non-required fields can be removed, as long as the field number is not used
again in your updated message type. You may want to rename the field
instead, perhaps adding the prefix &ldquo;OBSOLETE_&rdquo;, or make the field number
<a href=#reserved>reserved</a>, so that future users of your <code>.proto</code> can&rsquo;t
accidentally reuse the number.</li><li>A non-required field can be converted to an <a href=#extensions>extension</a> and
vice versa, as long as the type and number stay the same.</li><li><code>int32</code>, <code>uint32</code>, <code>int64</code>, <code>uint64</code>, and <code>bool</code> are all compatible – this
means you can change a field from one of these types to another without
breaking forwards- or backwards-compatibility. If a number is parsed from
the wire which doesn&rsquo;t fit in the corresponding type, you will get the same
effect as if you had cast the number to that type in C++ (for example, if a
64-bit number is read as an int32, it will be truncated to 32 bits).</li><li><code>sint32</code> and <code>sint64</code> are compatible with each other but are <em>not</em>
compatible with the other integer types.</li><li><code>string</code> and <code>bytes</code> are compatible as long as the bytes are valid UTF-8.</li><li>Embedded messages are compatible with <code>bytes</code> if the bytes contain an
encoded version of the message.</li><li><code>fixed32</code> is compatible with <code>sfixed32</code>, and <code>fixed64</code> with <code>sfixed64</code>.</li><li>For <code>string</code>, <code>bytes</code>, and message fields, <code>optional</code> is compatible with
<code>repeated</code>. Given serialized data of a repeated field as input, clients that
expect this field to be <code>optional</code> will take the last input value if it&rsquo;s a
primitive type field or merge all input elements if it&rsquo;s a message type
field. Note that this is <strong>not</strong> generally safe for numeric types, including
bools and enums. Repeated fields of numeric types can be serialized in the
<a href=/programming-guides/encoding#packed>packed</a> format,
which will not be parsed correctly when an <code>optional</code> field is expected.</li><li>Changing a default value is generally OK, as long as you remember that
default values are never sent over the wire. Thus, if a program receives a
message in which a particular field isn&rsquo;t set, the program will see the
default value as it was defined in that program&rsquo;s version of the protocol.
It will NOT see the default value that was defined in the sender&rsquo;s code.</li><li><code>enum</code> is compatible with <code>int32</code>, <code>uint32</code>, <code>int64</code>, and <code>uint64</code> in terms
of wire format (note that values will be truncated if they don&rsquo;t fit), but
be aware that client code may treat them differently when the message is
deserialized. Notably, unrecognized <code>enum</code> values are discarded when the
message is deserialized, which makes the field&rsquo;s <code>has..</code> accessor return
false and its getter return the first value listed in the <code>enum</code> definition,
or the default value if one is specified. In the case of repeated enum
fields, any unrecognized values are stripped out of the list. However, an
integer field will always preserve its value. Because of this, you need to
be very careful when upgrading an integer to an <code>enum</code> in terms of receiving
out of bounds enum values on the wire.</li><li>In the current Java and C++ implementations, when unrecognized <code>enum</code> values
are stripped out, they are stored along with other unknown fields. Note that
this can result in strange behavior if this data is serialized and then
reparsed by a client that recognizes these values. In the case of optional
fields, even if a new value was written after the original message was
deserialized, the old value will be still read by clients that recognize it.
In the case of repeated fields, the old values will appear after any
recognized and newly-added values, which means that order will not be
preserved.</li><li>Changing a single <code>optional</code> field or extension into a member of a <strong>new</strong>
<code>oneof</code> is safe and binary compatible. Moving multiple <code>optional</code> fields
into a new <code>oneof</code> may be safe if you are sure that no code sets more than
one at a time. Moving any fields into an existing <code>oneof</code> is not safe.
Likewise, changing a single field <code>oneof</code> to an <code>optional</code> field or
extension is safe.</li><li>Changing a field between a <code>map&lt;K, V></code> and the corresponding <code>repeated</code>
message field is binary compatible (see <a href=#maps>Maps</a>, below, for the
message layout and other restrictions). However, the safety of the change is
application-dependent: when deserializing and reserializing a message,
clients using the <code>repeated</code> field definition will produce a semantically
identical result; however, clients using the <code>map</code> field definition may
reorder entries and drop entries with duplicate keys.</li></ul><h2 id=extensions>Extensions</h2><p>Extensions let you declare that a range of field numbers in a message are
available for third-party extensions. An extension is a placeholder for a field
whose type is not defined by the original <code>.proto</code> file. This allows other
<code>.proto</code> files to add to your message definition by defining the types of some
or all of the fields with those field numbers. Let&rsquo;s look at an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>extensions</span> <span style=color:#0000cf;font-weight:700>100</span> <span style=color:#204a87;font-weight:700>to</span> <span style=color:#0000cf;font-weight:700>199</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>This says that the range of field numbers [100, 199] in <code>Foo</code> is reserved for
extensions. Other users can now add new fields to <code>Foo</code> in their own <code>.proto</code>
files that import your <code>.proto</code>, using field numbers within your specified range
– for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>bar</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>126</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>This adds a field named <code>bar</code> with the field number 126 to the original
definition of <code>Foo</code>.</p><p>When your user&rsquo;s <code>Foo</code> messages are encoded, the wire format is exactly the same
as if the user defined the new field inside <code>Foo</code>. However, the way you access
extension fields in your application code is slightly different to accessing
regular fields – your generated data access code has special accessors for
working with extensions. So, for example, here&rsquo;s how you set the value of <code>bar</code>
in C++:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>Foo</span> <span style=color:#000>foo</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>foo</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetExtension</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bar</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>Similarly, the <code>Foo</code> class defines templated accessors <code>HasExtension()</code>,
<code>ClearExtension()</code>, <code>GetExtension()</code>, <code>MutableExtension()</code>, and
<code>AddExtension()</code>. All have semantics matching the corresponding generated
accessors for a normal field. For more information about working with
extensions, see the generated code reference for your chosen language.</p><p>Note that extensions can be of any field type, including message types, but
cannot be oneofs or maps.</p><h3 id=nested-exts>Nested Extensions</h3><p>You can declare extensions in the scope of another type:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Baz</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>bar</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>126</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>In this case, the C++ code to access this extension is:</p><pre lang=cpp>
Foo foo;
foo.SetExtension(Baz::bar, 15);</pre><p>In other words, the only effect is that <code>bar</code> is defined within the scope of
<code>Baz</code>.</p><p>This is a common source of confusion: Declaring an <code>extend</code> block nested inside
a message type <em>does not</em> imply any relationship between the outer type and the
extended type. In particular, the above example <em>does not</em> mean that <code>Baz</code> is
any sort of subclass of <code>Foo</code>. All it means is that the symbol <code>bar</code> is declared
inside the scope of <code>Baz</code>; it&rsquo;s simply a static member.</p><p>A common pattern is to define extensions inside the scope of the extension&rsquo;s
field type – for example, here&rsquo;s an extension to <code>Foo</code> of type <code>Baz</code>, where the
extension is defined as part of <code>Baz</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Baz</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>Baz</span> <span style=color:#000>foo_ext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>127</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>However, there is no requirement that an extension with a message type be
defined inside that type. You can also do this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Baz</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// This can even be in a different file.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>Baz</span> <span style=color:#000>foo_baz_ext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>127</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>In fact, this syntax may be preferred to avoid confusion. As mentioned above,
the nested syntax is often mistaken for subclassing by users who are not already
familiar with extensions.</p><h3 id=choosing>Choosing Extension Numbers</h3><p>It&rsquo;s very important to make sure that two users don&rsquo;t add extensions to the same
message type using the same field number – data corruption can result if an
extension is accidentally interpreted as the wrong type. You may want to
consider defining an extension numbering convention for your project to prevent
this happening.</p><p>If your numbering convention might involve extensions having very large field
numbers, you can specify that your extension range goes up to the maximum
possible field number using the <code>max</code> keyword:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>extensions</span> <span style=color:#0000cf;font-weight:700>1000</span> <span style=color:#204a87;font-weight:700>to</span> <span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p><code>max</code> is 2<sup>29</sup> - 1, or 536,870,911.</p><p>As when choosing field numbers in general, your numbering convention also needs
to avoid field numbers 19000 though 19999
(<code>FieldDescriptor::kFirstReservedNumber</code> through
<code>FieldDescriptor::kLastReservedNumber</code>), as they are reserved for the Protocol
Buffers implementation. You can define an extension range that includes this
range, but the protocol compiler will not allow you to define actual extensions
with these numbers.</p><h2 id=oneof>Oneof</h2><p>If you have a message with many optional fields and where at most one field will
be set at the same time, you can enforce this behavior and save memory by using
the oneof feature.</p><p>Oneof fields are like optional fields except all the fields in a oneof share
memory, and at most one field can be set at the same time. Setting any member of
the oneof automatically clears all the other members. You can check which value
in a oneof is set (if any) using a special <code>case()</code> or <code>WhichOneof()</code> method,
depending on your chosen language.</p><h3 id=using-oneof>Using Oneof</h3><p>To define a oneof in your <code>.proto</code> you use the <code>oneof</code> keyword followed by your
oneof name, in this case <code>test_oneof</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SampleMessage</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>oneof</span> <span style=color:#000>test_oneof</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>     <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>     <span style=color:#000>SubMessage</span> <span style=color:#000>sub_message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>9</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>You then add your oneof fields to the oneof definition. You can add fields of
any type, but cannot use the <code>required</code>, <code>optional</code>, or <code>repeated</code> keywords. If
you need to add a repeated field to a oneof, you can use a message containing
the repeated field.</p><p>In your generated code, oneof fields have the same getters and setters as
regular <code>optional</code> methods. You also get a special method for checking which
value (if any) in the oneof is set. You can find out more about the oneof API
for your chosen language in the relevant
<a href=/reference/>API reference</a>.</p><h3 id=oneof-features>Oneof Features</h3><ul><li><p>Setting a oneof field will automatically clear all other members of the
oneof. So if you set several oneof fields, only the <em>last</em> field you set
will still have a value.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>SampleMessage</span> <span style=color:#000>message</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_name</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>CHECK</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>has_name</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mutable_sub_message</span><span style=color:#000;font-weight:700>();</span>   <span style=color:#8f5902;font-style:italic>// Will clear name field.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>CHECK</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>has_name</span><span style=color:#000;font-weight:700>());</span>
</span></span></code></pre></div></li><li><p>If the parser encounters multiple members of the same oneof on the wire,
only the last member seen is used in the parsed message.</p></li><li><p>Extensions are not supported for oneof.</p></li><li><p>A oneof cannot be <code>repeated</code>.</p></li><li><p>Reflection APIs work for oneof fields.</p></li><li><p>If you set a oneof field to the default value (such as setting an int32
oneof field to 0), the &ldquo;case&rdquo; of that oneof field will be set, and the value
will be serialized on the wire.</p></li><li><p>If you&rsquo;re using C++, make sure your code doesn&rsquo;t cause memory crashes. The
following sample code will crash because <code>sub_message</code> was already deleted
by calling the <code>set_name()</code> method.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>SampleMessage</span> <span style=color:#000>message</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>SubMessage</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>sub_message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mutable_sub_message</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_name</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>);</span>      <span style=color:#8f5902;font-style:italic>// Will delete sub_message
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>sub_message</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>set_</span><span style=color:#000;font-weight:700>...</span>            <span style=color:#8f5902;font-style:italic>// Crashes here
</span></span></span></code></pre></div></li><li><p>Again in C++, if you <code>Swap()</code> two messages with oneofs, each message will
end up with the other’s oneof case: in the example below, <code>msg1</code> will have a
<code>sub_message</code> and <code>msg2</code> will have a <code>name</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>SampleMessage</span> <span style=color:#000>msg1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>msg1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_name</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>SampleMessage</span> <span style=color:#000>msg2</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>msg2</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mutable_sub_message</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000>msg1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>swap</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>msg2</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>CHECK</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>msg1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>has_sub_message</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span><span style=color:#000>CHECK</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>msg2</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>has_name</span><span style=color:#000;font-weight:700>());</span>
</span></span></code></pre></div></li></ul><h3 id=backward>Backwards-compatibility issues</h3><p>Be careful when adding or removing oneof fields. If checking the value of a
oneof returns <code>None</code>/<code>NOT_SET</code>, it could mean that the oneof has not been set or
it has been set to a field in a different version of the oneof. There is no way
to tell the difference, since there&rsquo;s no way to know if an unknown field on the
wire is a member of the oneof.</p><h4 id=reuse>Tag Reuse Issues</h4><ul><li><strong>Move optional fields into or out of a oneof</strong>: You may lose some of your
information (some fields will be cleared) after the message is serialized
and parsed. However, you can safely move a single field into a <strong>new</strong> oneof
and may be able to move multiple fields if it is known that only one is ever
set.</li><li><strong>Delete a oneof field and add it back</strong>: This may clear your currently set
oneof field after the message is serialized and parsed.</li><li><strong>Split or merge oneof</strong>: This has similar issues to moving regular
<code>optional</code> fields.</li></ul><h2 id=maps>Maps</h2><p>If you want to create an associative map as part of your data definition,
protocol buffers provides a handy shortcut syntax:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#000>map</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>key_type</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>value_type</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000>map_field</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>N</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>&mldr;where the <code>key_type</code> can be any integral or string type (so, any
<a href=#scalar>scalar</a> type except for floating point types and <code>bytes</code>). Note that
enum is not a valid <code>key_type</code>. The <code>value_type</code> can be any type except another
map.</p><p>So, for example, if you wanted to create a map of projects where each <code>Project</code>
message is associated with a string key, you could define it like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#000>map</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>Project</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000>projects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>The generated map API is currently available for all proto2 supported languages.
You can find out more about the map API for your chosen language in the relevant
<a href=/reference/>API reference</a>.</p><h3 id=maps-features>Maps Features</h3><ul><li>Extensions are not supported for maps.</li><li>Maps cannot be <code>repeated</code>, <code>optional</code>, or <code>required</code>.</li><li>Wire format ordering and map iteration ordering of map values is undefined,
so you cannot rely on your map items being in a particular order.</li><li>When generating text format for a <code>.proto</code>, maps are sorted by key. Numeric
keys are sorted numerically.</li><li>When parsing from the wire or when merging, if there are duplicate map keys
the last key seen is used. When parsing a map from text format, parsing may
fail if there are duplicate keys.</li></ul><h3 id=backwards>Backwards compatibility</h3><p>The map syntax is equivalent to the following on the wire, so protocol buffers
implementations that do not support maps can still handle your data:</p><pre class=prettyprint lang=proto>message MapFieldEntry {
  optional key_type key = 1;
  optional value_type value = 2;
}

repeated MapFieldEntry map_field = N;
</pre><p>Any protocol buffers implementation that supports maps must both produce and
accept data that can be accepted by the above definition.</p><h2 id=packages>Packages</h2><p>You can add an optional <code>package</code> specifier to a <code>.proto</code> file to prevent name
clashes between protocol message types.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>bar</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Open</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>You can then use the package specifier when defining fields of your message
type:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>required</span> <span style=color:#000>foo.bar.Open</span> <span style=color:#000>open</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>The way a package specifier affects the generated code depends on your chosen
language:</p><ul><li>In <strong>C++</strong> the generated classes are wrapped inside a C++ namespace. For
example, <code>Open</code> would be in the namespace <code>foo::bar</code>.</li><li>In <strong>Java</strong>, the package is used as the Java package, unless you explicitly
provide a <code>option java_package</code> in your <code>.proto</code> file.</li><li>In <strong>Python</strong>, the <code>package</code> directive is ignored, since Python modules are
organized according to their location in the file system.</li><li>In <strong>Go</strong>, the <code>package</code> directive is ignored, and the generated <code>.pb.go</code>
file is in the package named after the corresponding <code>go_proto_library</code>
rule.</li></ul><p>Note that even when the <code>package</code> directive does not directly affect the
generated code, for example in Python, it is still strongly recommended to
specify the package for the <code>.proto</code> file, as otherwise it may lead to naming
conflicts in descriptors and make the proto not portable for other languages.</p><h3 id=name-resolution>Packages and Name Resolution</h3><p>Type name resolution in the protocol buffer language works like C++: first the
innermost scope is searched, then the next-innermost, and so on, with each
package considered to be &ldquo;inner&rdquo; to its parent package. A leading &lsquo;.&rsquo; (for
example, <code>.foo.bar.Baz</code>) means to start from the outermost scope instead.</p><p>The protocol buffer compiler resolves all type names by parsing the imported
<code>.proto</code> files. The code generator for each language knows how to refer to each
type in that language, even if it has different scoping rules.</p><h2 id=services>Defining Services</h2><p>If you want to use your message types with an RPC (Remote Procedure Call)
system, you can define an RPC service interface in a <code>.proto</code> file and the
protocol buffer compiler will generate service interface code and stubs in your
chosen language. So, for example, if you want to define an RPC service with a
method that takes your <code>SearchRequest</code> and returns a <code>SearchResponse</code>, you can
define it in your <code>.proto</code> file as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>service</span> <span style=color:#000>SearchService</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>Search</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>SearchRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>SearchResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>By default, the protocol compiler will then generate an abstract interface
called <code>SearchService</code> and a corresponding &ldquo;stub&rdquo; implementation. The stub
forwards all calls to an <code>RpcChannel</code>, which in turn is an abstract interface
that you must define yourself in terms of your own RPC system. For example, you
might implement an <code>RpcChannel</code> which serializes the message and sends it to a
server via HTTP. In other words, the generated stub provides a type-safe
interface for making protocol-buffer-based RPC calls, without locking you into
any particular RPC implementation. So, in C++, you might end up with code like
this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcChannel</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>channel</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>controller</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>SearchService</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>service</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>SearchRequest</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>SearchResponse</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>DoSearch</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// You provide classes MyRpcChannel and MyRpcController, which implement
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// the abstract interfaces protobuf::RpcChannel and protobuf::RpcController.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>channel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyRpcChannel</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;somehost.example.com:1234&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>controller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyRpcController</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// The protocol compiler generates the SearchService class based on the
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// definition given above.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SearchService</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Stub</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>channel</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Set up the request.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>request</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_query</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;protocol buffers&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Execute the RPC.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>Search</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>controller</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>NewCallback</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>Done</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>delete</span> <span style=color:#000>service</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>delete</span> <span style=color:#000>channel</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>delete</span> <span style=color:#000>controller</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>All service classes also implement the <code>Service</code> interface, which provides a way
to call specific methods without knowing the method name or its input and output
types at compile time. On the server side, this can be used to implement an RPC
server with which you could register services.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ExampleSearchService</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SearchService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>Search</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>controller</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>SearchRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>SearchResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>query</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;google&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>add_result</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>set_url</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;http://www.google.com&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>query</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;protocol buffers&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>add_result</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>set_url</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;http://protobuf.googlecode.com&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>done</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>Run</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// You provide class MyRpcServer.  It does not have to implement any
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// particular interface; this is just an example.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>MyRpcServer</span> <span style=color:#000>server</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Service</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExampleSearchService</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ExportOnPort</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1234</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>service</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Run</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>delete</span> <span style=color:#000>service</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If you don&rsquo;t want to plug in your own existing RPC system, you can now use
<a href=https://github.com/grpc/grpc-common>gRPC</a>: a language- and platform-neutral
open source RPC system developed at Google. gRPC works particularly well with
protocol buffers and lets you generate the relevant RPC code directly from your
<code>.proto</code> files using a special protocol buffer compiler plugin. However, as
there are potential compatibility issues between clients and servers generated
with proto2 and proto3, we recommend that you use proto3 for defining gRPC
services. You can find out more about proto3 syntax in the
<a href=/programming-guides/proto3>Proto3 Language Guide</a>. If
you do want to use proto2 with gRPC, you need to use version 3.0.0 or higher of
the protocol buffers compiler and libraries.</p><p>In addition to gRPC, there are also a number of ongoing third-party projects to
develop RPC implementations for Protocol Buffers. For a list of links to
projects we know about, see the
<a href=https://github.com/protocolbuffers/protobuf/blob/master/docs/third_party.md>third-party add-ons wiki page</a>.</p><h2 id=options>Options</h2><p>Individual declarations in a <code>.proto</code> file can be annotated with a number of
<em>options</em>. Options do not change the overall meaning of a declaration, but may
affect the way it is handled in a particular context. The complete list of
available options is defined in <code>google/protobuf/descriptor.proto</code>.</p><p>Some options are file-level options, meaning they should be written at the
top-level scope, not inside any message, enum, or service definition. Some
options are message-level options, meaning they should be written inside message
definitions. Some options are field-level options, meaning they should be
written inside field definitions. Options can also be written on enum types,
enum values, oneof fields, service types, and service methods; however, no
useful options currently exist for any of these.</p><p>Here are a few of the most commonly used options:</p><ul><li><p><code>java_package</code> (file option): The package you want to use for your generated
Java classes. If no explicit <code>java_package</code> option is given in the <code>.proto</code>
file, then by default the proto package (specified using the &ldquo;package&rdquo;
keyword in the <code>.proto</code> file) will be used. However, proto packages
generally do not make good Java packages since proto packages are not
expected to start with reverse domain names. If not generating Java code,
this option has no effect.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>java_package</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.example.foo&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div></li><li><p><code>java_outer_classname</code> (file option): The class name (and hence the file
name) for the wrapper Java class you want to generate. If no explicit
<code>java_outer_classname</code> is specified in the <code>.proto</code> file, the class name
will be constructed by converting the <code>.proto</code> file name to camel-case (so
<code>foo_bar.proto</code> becomes <code>FooBar.java</code>). If the <code>java_multiple_files</code> option
is disabled, then all other classes/enums/etc. generated for the <code>.proto</code>
file will be generated <em>within</em> this outer wrapper Java class as nested
classes/enums/etc. If not generating Java code, this option has no effect.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>java_outer_classname</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Ponycopter&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div></li><li><p><code>java_multiple_files</code> (file option): If false, only a single <code>.java</code> file
will be generated for this <code>.proto</code> file, and all the Java
classes/enums/etc. generated for the top-level messages, services, and
enumerations will be nested inside of an outer class (see
<code>java_outer_classname</code>). If true, separate <code>.java</code> files will be generated
for each of the Java classes/enums/etc. generated for the top-level
messages, services, and enumerations, and the wrapper Java class generated
for this <code>.proto</code> file won&rsquo;t contain any nested classes/enums/etc. This is a
Boolean option which defaults to <code>false</code>. If not generating Java code, this
option has no effect.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>java_multiple_files</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div></li><li><p><code>optimize_for</code> (file option): Can be set to <code>SPEED</code>, <code>CODE_SIZE</code>, or
<code>LITE_RUNTIME</code>. This affects the C++ and Java code generators (and possibly
third-party generators) in the following ways:</p><ul><li><code>SPEED</code> (default): The protocol buffer compiler will generate code for
serializing, parsing, and performing other common operations on your
message types. This code is highly optimized.</li><li><code>CODE_SIZE</code>: The protocol buffer compiler will generate minimal classes
and will rely on shared, reflection-based code to implement
serialialization, parsing, and various other operations. The generated
code will thus be much smaller than with <code>SPEED</code>, but operations will be
slower. Classes will still implement exactly the same public API as they
do in <code>SPEED</code> mode. This mode is most useful in apps that contain a very
large number of <code>.proto</code> files and do not need all of them to be
blindingly fast.</li><li><code>LITE_RUNTIME</code>: The protocol buffer compiler will generate classes that
depend only on the &ldquo;lite&rdquo; runtime library (<code>libprotobuf-lite</code> instead of
<code>libprotobuf</code>). The lite runtime is much smaller than the full library
(around an order of magnitude smaller) but omits certain features like
descriptors and reflection. This is particularly useful for apps running
on constrained platforms like mobile phones. The compiler will still
generate fast implementations of all methods as it does in <code>SPEED</code> mode.
Generated classes will only implement the <code>MessageLite</code> interface in
each language, which provides only a subset of the methods of the full
<code>Message</code> interface.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>optimize_for</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CODE_SIZE</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div></li><li><p><code>cc_generic_services</code>, <code>java_generic_services</code>, <code>py_generic_services</code> (file
options): Whether or not the protocol buffer compiler should generate
abstract service code based on <a href=#services>services definitions</a> in C++,
Java, and Python, respectively. For legacy reasons, these default to <code>true</code>.
However, as of version 2.3.0 (January 2010), it is considered preferrable
for RPC implementations to provide
<a href=/reference/cpp/api-docs/google.protobuf.compiler.plugin.pb>code generator plugins</a>
to generate code more specific to each system, rather than rely on the
&ldquo;abstract&rdquo; services.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// This file relies on plugins to generate service code.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>cc_generic_services</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>java_generic_services</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>py_generic_services</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div></li><li><p><code>cc_enable_arenas</code> (file option): Enables
<a href=/reference/cpp/arenas>arena allocation</a> for C++
generated code.</p></li><li><p><code>message_set_wire_format</code> (message option): If set to <code>true</code>, the message
uses a different binary format intended to be compatible with an old format
used inside Google called <code>MessageSet</code>. Users outside Google will probably
never need to use this option. The message must be declared exactly as
follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>message_set_wire_format</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>extensions</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#204a87;font-weight:700>to</span> <span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div></li><li><p><code>packed</code> (field option): If set to <code>true</code> on a repeated field of a basic
numeric type, a more compact
<a href=/programming-guides/encoding#packed>encoding</a> is
used. There is no downside to using this option. However, note that prior to
version 2.3.0, parsers that received packed data when not expected would
ignore it. Therefore, it was not possible to change an existing field to
packed format without breaking wire compatibility. In 2.3.0 and later, this
change is safe, as parsers for packable fields will always accept both
formats, but be careful if you have to deal with old programs using old
protobuf versions.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>samples</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>packed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span></code></pre></div></li><li><p><code>deprecated</code> (field option): If set to <code>true</code>, indicates that the field is
deprecated and should not be used by new code. In most languages this has no
actual effect. In Java, this becomes a <code>@Deprecated</code> annotation. In the
future, other language-specific code generators may generate deprecation
annotations on the field&rsquo;s accessors, which will in turn cause a warning to
be emitted when compiling code which attempts to use the field. If the field
is not used by anyone and you want to prevent new users from using it,
consider replacing the field declaration with a <a href=#reserved>reserved</a>
statement.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>old_field</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>deprecated</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span></code></pre></div></li></ul><h3 id=customoptions>Custom Options</h3><p>Protocol Buffers even allow you to define and use your own options. Note that
this is an <strong>advanced feature</strong> which most people don&rsquo;t need. Since options are
defined by the messages defined in <code>google/protobuf/descriptor.proto</code> (like
<code>FileOptions</code> or <code>FieldOptions</code>), defining your own options is simply a matter
of <a href=#extensions>extending</a> those messages. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;google/protobuf/descriptor.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protobuf.MessageOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>my_option</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>51234</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>MyMessage</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>option</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>my_option</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello world!&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Here we have defined a new message-level option by extending <code>MessageOptions</code>.
When we then use the option, the option name must be enclosed in parentheses to
indicate that it is an extension. We can now read the value of <code>my_option</code> in
C++ like so:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MyMessage</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>descriptor</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:#000>options</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>GetExtension</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>my_option</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Here, <code>MyMessage::descriptor()->options()</code> returns the <code>MessageOptions</code> protocol
message for <code>MyMessage</code>. Reading custom options from it is just like reading any
other <a href=#extensions>extension</a>.</p><p>Similarly, in Java we would write:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MyProtoFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MyMessage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDescriptor</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getOptions</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MyProtoFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>myOption</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p>In Python it would be:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>my_proto_file_pb2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MyMessage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>DESCRIPTOR</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>GetOptions</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Extensions</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>my_proto_file_pb2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>my_option</span><span style=color:#000;font-weight:700>]</span>
</span></span></code></pre></div><p>Custom options can be defined for every kind of construct in the Protocol
Buffers language. Here is an example that uses every kind of option:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;google/protobuf/descriptor.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protobuf.FileOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>my_file_option</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50000</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protobuf.MessageOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>my_message_option</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50001</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protobuf.FieldOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>my_field_option</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50002</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protobuf.OneofOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#000>my_oneof_option</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50003</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protobuf.EnumOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>my_enum_option</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50004</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protobuf.EnumValueOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>uint32</span> <span style=color:#000>my_enum_value_option</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50005</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protobuf.ServiceOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>MyEnum</span> <span style=color:#000>my_service_option</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50006</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protobuf.MethodOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>MyMessage</span> <span style=color:#000>my_method_option</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50007</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>my_file_option</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello world!&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>MyMessage</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>option</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>my_message_option</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1234</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>[(</span><span style=color:#000>my_field_option</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4.5</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>bar</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>oneof</span> <span style=color:#000>qux</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>option</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>my_oneof_option</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>quux</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>MyEnum</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>option</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>my_enum_option</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>FOO</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>[(</span><span style=color:#000>my_enum_value_option</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>321</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>BAR</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>RequestType</span> <span style=color:#000;font-weight:700>{}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>ResponseType</span> <span style=color:#000;font-weight:700>{}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>service</span> <span style=color:#000>MyService</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>option</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>my_service_option</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>FOO</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>MyMethod</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>RequestType</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ResponseType</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#8f5902;font-style:italic>// Note:  my_method_option has type MyMessage.  We can set each field
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//   within it using a separate &#34;option&#34; line.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>option</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>my_method_option</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>567</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>option</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>my_method_option</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>bar</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Some string&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Note that if you want to use a custom option in a package other than the one in
which it was defined, you must prefix the option name with the package name,
just as you would for type names. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// foo.proto
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;google/protobuf/descriptor.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>foo</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protobuf.MessageOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>my_option</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>51234</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// bar.proto
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;foo.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>bar</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>MyMessage</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>option</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>foo.my_option</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello world!&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>One last thing: Since custom options are extensions, they must be assigned field
numbers like any other field or extension. In the examples above, we have used
field numbers in the range 50000-99999. This range is reserved for internal use
within individual organizations, so you can use numbers in this range freely for
in-house applications. If you intend to use custom options in public
applications, however, then it is important that you make sure that your field
numbers are globally unique. To obtain globally unique field numbers, send a
request to add an entry to
<a href=https://github.com/protocolbuffers/protobuf/blob/master/docs/options.md>protobuf global extension registry</a>.
Usually you only need one extension number. You can declare multiple options
with only one extension number by putting them in a sub-message:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>opt1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>opt2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>extend</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protobuf.FieldOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FooOptions</span> <span style=color:#000>foo_options</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1234</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// usage:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Bar</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>[(</span><span style=color:#000>foo_options</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>opt1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>123</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>foo_options</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>opt2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;baz&#34;</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// alternative aggregate syntax (uses TextFormat):
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>[(</span><span style=color:#000>foo_options</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>opt1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>123</span> <span style=color:#000>opt2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;baz&#34;</span> <span style=color:#000;font-weight:700>}];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Also, note that each option type (file-level, message-level, field-level, etc.)
has its own number space, so, for example, you could declare extensions of
FieldOptions and MessageOptions with the same number.</p><h2 id=generating>Generating Your Classes</h2><p>To generate the Java, Python, or C++ code you need to work with the message
types defined in a <code>.proto</code> file, you need to run the protocol buffer compiler
<code>protoc</code> on the <code>.proto</code>. If you haven&rsquo;t installed the compiler,
<a href=/downloads>download the package</a> and follow the
instructions in the README.</p><p>The Protocol Compiler is invoked as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>protoc --proto_path<span style=color:#ce5c00;font-weight:700>=</span>IMPORT_PATH --cpp_out<span style=color:#ce5c00;font-weight:700>=</span>DST_DIR --java_out<span style=color:#ce5c00;font-weight:700>=</span>DST_DIR --python_out<span style=color:#ce5c00;font-weight:700>=</span>DST_DIR path/to/file.proto
</span></span></code></pre></div><ul><li><p><code>IMPORT_PATH</code> specifies a directory in which to look for <code>.proto</code> files when
resolving <code>import</code> directives. If omitted, the current directory is used.
Multiple import directories can be specified by passing the <code>--proto_path</code>
option multiple times; they will be searched in order. <code>-I=_IMPORT_PATH_</code>
can be used as a short form of <code>--proto_path</code>.</p></li><li><p>You can provide one or more <em>output directives</em>:</p><ul><li><code>--cpp_out</code> generates C++ code in <code>DST_DIR</code>. See the
<a href=/reference/cpp/cpp-generated>C++ generated code reference</a>
for more.</li><li><code>--java_out</code> generates Java code in <code>DST_DIR</code>. See the
<a href=/reference/java/java-generated>Java generated code reference</a>
for more.</li><li><code>--python_out</code> generates Python code in <code>DST_DIR</code>. See the
<a href=/reference/python/python-generated>Python generated code reference</a>
for more.</li></ul><p>As an extra convenience, if the <code>DST_DIR</code> ends in <code>.zip</code> or <code>.jar</code>, the
compiler will write the output to a single ZIP-format archive file with the
given name. <code>.jar</code> outputs will also be given a manifest file as required by
the Java JAR specification. Note that if the output archive already exists,
it will be overwritten; the compiler is not smart enough to add files to an
existing archive.</p></li><li><p>You must provide one or more <code>.proto</code> files as input. Multiple <code>.proto</code>
files can be specified at once. Although the files are named relative to the
current directory, each file must reside in one of the <code>IMPORT_PATH</code>s so
that the compiler can determine its canonical name.</p></li></ul><h2 id=location>File location</h2><p>Prefer not to put <code>.proto</code> files in the same
directory as other language sources. Consider
creating a subpackage <code>proto</code> for <code>.proto</code> files, under the root package for
your project.</p><h3 id=location-language-agnostic>Location Should be Language-agnostic</h3><p>When working with Java code, it&rsquo;s handy to put related <code>.proto</code> files in the
same directory as the Java source. However, if any non-Java code ever uses the
same protos, the path prefix will no longer make sense. So in
general, put the protos in a related language-agnostic directory such as
<code>//myteam/mypackage</code>.</p><p>The exception to this rule is when it&rsquo;s clear that the protos will be used only
in a Java context, such as for testing.</p><h2 id=platforms>Supported Platforms</h2><p>For information about:</p><ul><li>the operating systems, compilers, build systems, and C++ versions that are
supported, see
<a href=https://opensource.google/documentation/policies/cplusplus-support>Foundational C++ Support Policy</a>.</li><li>the PHP versions that are supported, see
<a href=https://cloud.google.com/php/getting-started/supported-php-versions>Supported PHP versions</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-903088f4024e6a3ca0c66491de0e198b>2 - Language Guide (proto 3)</h1><div class=lead>This topic covers how to use the version 3 of Protocol Buffers in your project. It contains language-agnostic content. For information specific to the language you&rsquo;re using, see the corresponding documentation for your language.</div><p>This guide describes how to use the protocol buffer language to structure your
protocol buffer data, including <code>.proto</code> file syntax and how to generate data
access classes from your <code>.proto</code> files. It covers the <strong>proto3</strong> version of the
protocol buffers language: for information on the <strong>proto2</strong> syntax, see the
<a href=/programming-guides/proto>Proto2 Language Guide</a>.</p><p>This is a reference guide – for a step by step example that uses many of the
features described in this document, see the
<a href=/getting-started>tutorial</a> for your chosen language.</p><h2 id=simple>Defining A Message Type</h2><p>First let&rsquo;s look at a very simple example. Let&rsquo;s say you want to define a search
request message format, where each search request has a query string, the
particular page of results you are interested in, and a number of results per
page. Here&rsquo;s the <code>.proto</code> file you use to define the message type.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#000>syntax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;proto3&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>query</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_number</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>result_per_page</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><ul><li>The first line of the file specifies that you&rsquo;re using <code>proto3</code> syntax: if
you don&rsquo;t do this the protocol buffer compiler will assume you are using
<a href=/programming-guides/proto>proto2</a>. This must be the
first non-empty, non-comment line of the file.</li><li>The <code>SearchRequest</code> message definition specifies three fields (name/value
pairs), one for each piece of data that you want to include in this type of
message. Each field has a name and a type.</li></ul><h3 id=specifying-field-types>Specifying Field Types</h3><p>In the above example, all the fields are <a href=#scalar>scalar types</a>: two integers
(<code>page_number</code> and <code>result_per_page</code>) and a string (<code>query</code>). However, you can
also specify composite types for your fields, including <a href=#enum>enumerations</a>
and other message types.</p><h3 id=assigning-field-numbers>Assigning Field Numbers</h3><p>As you can see, each field in the message definition has a <strong>unique number</strong>.
These field numbers are used to identify your fields in the
<a href=/programming-guides/encoding>message binary format</a>,
and should not be changed once your message type is in use. Note that field
numbers in the range 1 through 15 take one byte to encode, including the field
number and the field&rsquo;s type (you can find out more about this in
<a href=/programming-guides/encoding#structure>Protocol Buffer Encoding</a>).
Field numbers in the range 16 through 2047 take two bytes. So you should reserve
the numbers 1 through 15 for very frequently occurring message elements.
Remember to leave some room for frequently occurring elements that might be
added in the future.</p><p>The smallest field number you can specify is 1, and the largest is
2<sup>29</sup> - 1, or 536,870,911. You also cannot use the numbers 19000
through 19999 (<code>FieldDescriptor::kFirstReservedNumber</code> through
<code>FieldDescriptor::kLastReservedNumber</code>), as they are reserved for the Protocol
Buffers implementation—the protocol buffer compiler will complain if you use one
of these reserved numbers in your <code>.proto</code>. Similarly, you cannot use any
previously <a href=#reserved>reserved</a> field numbers.</p><h3 id=specifying-field-rules>Specifying Field Rules</h3><p>Message fields can be one of the following:</p><ul><li><code>singular</code>: a well-formed message can have zero or one of this field (but
not more than one). When using proto3 syntax, this is the default field rule
when no other field rules are specified for a given field. You cannot
determine whether it was parsed from the wire. It will be serialized to the
wire unless it is the default value. For more on this subject, see
<a href=/programming-guides/field_presence>Field Presence</a>.</li><li><code>optional</code>: the same as <code>singular</code>, except that you can check to see if the
value was explicitly set. An <code>optional</code> field is in one of two possible
states:<ul><li>the field is set, and contains a value that was explicitly set or parsed
from the wire. It will be serialized to the wire.</li><li>the field is unset, and will return the default value. It will not be
serialized to the wire.</li></ul></li><li><code>repeated</code>: this field type can be repeated zero or more times in a
well-formed message. The order of the repeated values will be preserved.</li><li><code>map</code>: this is a paired key/value field type. See
<a href=/programming-guides/encoding.md#maps>Maps</a> for more
on this field type.</li></ul><p>In proto3, <code>repeated</code> fields of scalar numeric types use <code>packed</code> encoding by
default. You can find out more about <code>packed</code> encoding in
<a href=/programming-guides/encoding#packed>Protocol Buffer Encoding</a>.</p><h3 id=adding-more-message-types>Adding More Message Types</h3><p>Multiple message types can be defined in a single <code>.proto</code> file. This is useful
if you are defining multiple related messages – so, for example, if you wanted
to define the reply message format that corresponds to your <code>SearchResponse</code>
message type, you could add it to the same <code>.proto</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>query</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_number</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>result_per_page</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span> <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h3 id=adding-comments>Adding Comments</h3><p>To add comments to your <code>.proto</code> files, use C/C++-style <code>//</code> and <code>/* ... */</code>
syntax.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/* SearchRequest represents a search query, with pagination options to
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * indicate which results to include in the response. */</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>query</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_number</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// Which page number do we want?
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>result_per_page</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// Number of results to return per page.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h3 id=reserved>Reserved Fields</h3><p>If you <a href=#updating>update</a> a message type by entirely removing a field, or
commenting it out, future users can reuse the field number when making their own
updates to the type. This can cause severe issues if they later load old
versions of the same <code>.proto</code>, including data corruption, privacy bugs, and so
on. One way to make sure this doesn&rsquo;t happen is to specify that the field
numbers (and/or names, which can also cause issues for JSON serialization) of
your deleted fields are <code>reserved</code>. The protocol buffer compiler will complain
if any future users try to use these field identifiers.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>reserved</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#204a87;font-weight:700>to</span> <span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>reserved</span> <span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Note that you can&rsquo;t mix field names and field numbers in the same <code>reserved</code>
statement.</p><h3 id=whats-generated-from-your-proto>What&rsquo;s Generated From Your <code>.proto</code>?</h3><p>When you run the <a href=#generating>protocol buffer compiler</a> on a <code>.proto</code>, the
compiler generates the code in your chosen language you&rsquo;ll need to work with the
message types you&rsquo;ve described in the file, including getting and setting field
values, serializing your messages to an output stream, and parsing your messages
from an input stream.</p><ul><li>For <strong>C++</strong>, the compiler generates a <code>.h</code> and <code>.cc</code> file from each
<code>.proto</code>, with a class for each message type described in your file.</li><li>For <strong>Java</strong>, the compiler generates a <code>.java</code> file with a class for each
message type, as well as a special <code>Builder</code> class for creating message
class instances.</li><li>For <strong>Kotlin</strong>, in addition to the Java generated code, the compiler
generates a <code>.kt</code> file for each message type, containing a DSL which can be
used to simplify creating message instances.</li><li><strong>Python</strong> is a little different — the Python compiler generates a module
with a static descriptor of each message type in your <code>.proto</code>, which is
then used with a <em>metaclass</em> to create the necessary Python data access
class at runtime.</li><li>For <strong>Go</strong>, the compiler generates a <code>.pb.go</code> file with a type for each
message type in your file.</li><li>For <strong>Ruby</strong>, the compiler generates a <code>.rb</code> file with a Ruby module
containing your message types.</li><li>For <strong>Objective-C</strong>, the compiler generates a <code>pbobjc.h</code> and <code>pbobjc.m</code> file
from each <code>.proto</code>, with a class for each message type described in your
file.</li><li>For <strong>C#</strong>, the compiler generates a <code>.cs</code> file from each <code>.proto</code>, with a
class for each message type described in your file.</li><li>For <strong>Dart</strong>, the compiler generates a <code>.pb.dart</code> file with a class for each
message type in your file.</li></ul><p>You can find out more about using the APIs for each language by following the
tutorial for your chosen language (proto3 versions coming soon). For even more
API details, see the relevant
<a href=/reference/>API reference</a> (proto3 versions also coming
soon).</p><h2 id=scalar>Scalar Value Types</h2><p>A scalar message field can have one of the following types – the table shows the
type specified in the <code>.proto</code> file, and the corresponding type in the
automatically generated class:</p><div style=overflow:auto;width:100%><table style=width:110%><tbody><tr><th>.proto Type</th><th>Notes</th><th>C++ Type</th><th>Java/Kotlin Type<sup>[1]</sup></th><th>Python Type<sup>[3]</sup></th><th>Go Type</th><th>Ruby Type</th><th>C# Type</th><th>PHP Type</th><th>Dart Type</th></tr><tr><td>double</td><td></td><td>double</td><td>double</td><td>float</td><td>float64</td><td>Float</td><td>double</td><td>float</td><td>double</td></tr><tr><td>float</td><td></td><td>float</td><td>float</td><td>float</td><td>float32</td><td>Float</td><td>float</td><td>float</td><td>double</td></tr><tr><td>int32</td><td>Uses variable-length encoding. Inefficient for encoding negative numbers –
if your field is likely to have negative values, use sint32 instead.</td><td>int32</td><td>int</td><td>int</td><td>int32</td><td>Fixnum or Bignum (as required)</td><td>int</td><td>integer</td><td>int</td></tr><tr><td>int64</td><td>Uses variable-length encoding. Inefficient for encoding negative numbers –
if your field is likely to have negative values, use sint64 instead.</td><td>int64</td><td>long</td><td>int/long<sup>[4]</sup></td><td>int64</td><td>Bignum</td><td>long</td><td>integer/string<sup>[6]</sup></td><td>Int64</td></tr><tr><td>uint32</td><td>Uses variable-length encoding.</td><td>uint32</td><td>int<sup>[2]</sup></td><td>int/long<sup>[4]</sup></td><td>uint32</td><td>Fixnum or Bignum (as required)</td><td>uint</td><td>integer</td><td>int</td></tr><tr><td>uint64</td><td>Uses variable-length encoding.</td><td>uint64</td><td>long<sup>[2]</sup></td><td>int/long<sup>[4]</sup></td><td>uint64</td><td>Bignum</td><td>ulong</td><td>integer/string<sup>[6]</sup></td><td>Int64</td></tr><tr><td>sint32</td><td>Uses variable-length encoding. Signed int value. These more efficiently
encode negative numbers than regular int32s.</td><td>int32</td><td>int</td><td>int</td><td>int32</td><td>Fixnum or Bignum (as required)</td><td>int</td><td>integer</td><td>int</td></tr><tr><td>sint64</td><td>Uses variable-length encoding. Signed int value. These more efficiently
encode negative numbers than regular int64s.</td><td>int64</td><td>long</td><td>int/long<sup>[4]</sup></td><td>int64</td><td>Bignum</td><td>long</td><td>integer/string<sup>[6]</sup></td><td>Int64</td></tr><tr><td>fixed32</td><td>Always four bytes. More efficient than uint32 if values are often greater
than 2<sup>28</sup>.</td><td>uint32</td><td>int<sup>[2]</sup></td><td>int/long<sup>[4]</sup></td><td>uint32</td><td>Fixnum or Bignum (as required)</td><td>uint</td><td>integer</td><td>int</td></tr><tr><td>fixed64</td><td>Always eight bytes. More efficient than uint64 if values are often greater
than 2<sup>56</sup>.</td><td>uint64</td><td>long<sup>[2]</sup></td><td>int/long<sup>[4]</sup></td><td>uint64</td><td>Bignum</td><td>ulong</td><td>integer/string<sup>[6]</sup></td><td>Int64</td></tr><tr><td>sfixed32</td><td>Always four bytes.</td><td>int32</td><td>int</td><td>int</td><td>int32</td><td>Fixnum or Bignum (as required)</td><td>int</td><td>integer</td><td>int</td></tr><tr><td>sfixed64</td><td>Always eight bytes.</td><td>int64</td><td>long</td><td>int/long<sup>[4]</sup></td><td>int64</td><td>Bignum</td><td>long</td><td>integer/string<sup>[6]</sup></td><td>Int64</td></tr><tr><td>bool</td><td></td><td>bool</td><td>boolean</td><td>bool</td><td>bool</td><td>TrueClass/FalseClass</td><td>bool</td><td>boolean</td><td>bool</td></tr><tr><td>string</td><td>A string must always contain UTF-8 encoded or 7-bit ASCII text, and cannot
be longer than 2<sup>32</sup>.</td><td>string</td><td>String</td><td>str/unicode<sup>[5]</sup></td><td>string</td><td>String (UTF-8)</td><td>string</td><td>string</td><td>String</td></tr><tr><td>bytes</td><td>May contain any arbitrary sequence of bytes no longer than
2<sup>32</sup>.</td><td>string</td><td>ByteString</td><td>str (Python 2)<br>bytes (Python 3)</td><td>[]byte</td><td>String (ASCII-8BIT)</td><td>ByteString</td><td>string</td><td>List<int></td></tr></tbody></table></div><p>You can find out more about how these types are encoded when you serialize your
message in
<a href=/programming-guides/encoding>Protocol Buffer Encoding</a>.</p><p><sup>[1]</sup> Kotlin uses the corresponding types from Java, even for unsigned
types, to ensure compatibility in mixed Java/Kotlin codebases.</p><p><sup>[2]</sup> In Java, unsigned 32-bit and 64-bit integers are represented
using their signed counterparts, with the top bit simply being stored in the
sign bit.</p><p><sup>[3]</sup> In all cases, setting values to a field will perform type
checking to make sure it is valid.</p><p><sup>[4]</sup> 64-bit or unsigned 32-bit integers are always represented as long
when decoded, but can be an int if an int is given when setting the field. In
all cases, the value must fit in the type represented when set. See [2].</p><p><sup>[5]</sup> Python strings are represented as unicode on decode but can be
str if an ASCII string is given (this is subject to change).</p><p><sup>[6]</sup> Integer is used on 64-bit machines and string is used on 32-bit
machines.</p><h2 id=default>Default Values</h2><p>When a message is parsed, if the encoded message does not contain a particular
singular element, the corresponding field in the parsed object is set to the
default value for that field. These defaults are type-specific:</p><ul><li>For strings, the default value is the empty string.</li><li>For bytes, the default value is empty bytes.</li><li>For bools, the default value is false.</li><li>For numeric types, the default value is zero.</li><li>For <a href=#enum>enums</a>, the default value is the <strong>first defined enum value</strong>,
which must be 0.</li><li>For message fields, the field is not set. Its exact value is
language-dependent. See the
<a href=/reference/>generated code guide</a> for details.</li></ul><p>The default value for repeated fields is empty (generally an empty list in the
appropriate language).</p><p>Note that for scalar message fields, once a message is parsed there&rsquo;s no way of
telling whether a field was explicitly set to the default value (for example
whether a boolean was set to <code>false</code>) or just not set at all: you should bear
this in mind when defining your message types. For example, don&rsquo;t have a boolean
that switches on some behavior when set to <code>false</code> if you don&rsquo;t want that
behavior to also happen by default. Also note that if a scalar message field
<strong>is</strong> set to its default, the value will not be serialized on the wire.</p><p>See the <a href=/reference/>generated code guide</a> for your
chosen language for more details about how defaults work in generated code.</p><h2 id=enum>Enumerations</h2><p>When you&rsquo;re defining a message type, you might want one of its fields to only
have one of a pre-defined list of values. For example, let&rsquo;s say you want to add
a <code>corpus</code> field for each <code>SearchRequest</code>, where the corpus can be <code>UNIVERSAL</code>,
<code>WEB</code>, <code>IMAGES</code>, <code>LOCAL</code>, <code>NEWS</code>, <code>PRODUCTS</code> or <code>VIDEO</code>. You can do this very
simply by adding an <code>enum</code> to your message definition with a constant for each
possible value.</p><p>In the following example we&rsquo;ve added an <code>enum</code> called <code>Corpus</code> with all the
possible values, and a field of type <code>Corpus</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>Corpus</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_UNSPECIFIED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_UNIVERSAL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_WEB</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_IMAGES</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_LOCAL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_NEWS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_PRODUCTS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>CORPUS_VIDEO</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>query</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_number</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>result_per_page</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>Corpus</span> <span style=color:#000>corpus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>As you can see, the <code>Corpus</code> enum&rsquo;s first constant maps to zero: every enum
definition <strong>must</strong> contain a constant that maps to zero as its first element.
This is because:</p><ul><li>There must be a zero value, so that we can use 0 as a numeric
<a href=#default>default value</a>.</li><li>The zero value needs to be the first element, for compatibility with the
<a href=/programming-guides/proto>proto2</a> semantics where
the first enum value is always the default.</li></ul><p>You can define aliases by assigning the same value to different enum constants.
To do this you need to set the <code>allow_alias</code> option to <code>true</code>, otherwise the
protocol compiler generates a warning message when aliases are found.
Though all alias values are valid during deserialization, the first value is
always used when serializing.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EnumAllowingAlias</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>allow_alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>EAA_UNSPECIFIED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>EAA_STARTED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>EAA_RUNNING</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>EAA_FINISHED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EnumNotAllowingAlias</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>ENAA_UNSPECIFIED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>ENAA_STARTED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// ENAA_RUNNING = 1;  // Uncommenting this line will cause a warning message.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>ENAA_FINISHED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Enumerator constants must be in the range of a 32-bit integer. Since <code>enum</code>
values use
<a href=/programming-guides/encoding>varint encoding</a> on the
wire, negative values are inefficient and thus not recommended. You can define
<code>enum</code>s within a message definition, as in the above example, or outside – these
<code>enum</code>s can be reused in any message definition in your <code>.proto</code> file. You can
also use an <code>enum</code> type declared in one message as the type of a field in a
different message, using the syntax <code>_MessageType_._EnumType_</code>.</p><p>When you run the protocol buffer compiler on a <code>.proto</code> that uses an <code>enum</code>, the
generated code will have a corresponding <code>enum</code> for Java, Kotlin, or C++, or a
special <code>EnumDescriptor</code> class for Python that&rsquo;s used to create a set of
symbolic constants with integer values in the runtime-generated class.</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Important</h4>The
generated code may be subject to language-specific limitations on the number of
enumerators (low thousands for one language). Review the limitations for the
languages you plan to use.</div><p>During deserialization, unrecognized enum values will be preserved in the
message, though how this is represented when the message is deserialized is
language-dependent. In languages that support open enum types with values
outside the range of specified symbols, such as C++ and Go, the unknown enum
value is simply stored as its underlying integer representation. In languages
with closed enum types such as Java, a case in the enum is used to represent an
unrecognized value, and the underlying integer can be accessed with special
accessors. In either case, if the message is serialized the unrecognized value
will still be serialized with the message.</p><p>For more information about how to work with message <code>enum</code>s in your
applications, see the <a href=/reference/>generated code guide</a>
for your chosen language.</p><h3 id=reserved-values>Reserved Values</h3><p>If you <a href=#updating>update</a> an enum type by entirely removing an enum entry, or
commenting it out, future users can reuse the numeric value when making their
own updates to the type. This can cause severe issues if they later load old
versions of the same <code>.proto</code>, including data corruption, privacy bugs, and so
on. One way to make sure this doesn&rsquo;t happen is to specify that the numeric
values (and/or names, which can also cause issues for JSON serialization) of
your deleted entries are <code>reserved</code>. The protocol buffer compiler will complain
if any future users try to use these identifiers. You can specify that your
reserved numeric value range goes up to the maximum possible value using the
<code>max</code> keyword.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>reserved</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#204a87;font-weight:700>to</span> <span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>40</span> <span style=color:#204a87;font-weight:700>to</span> <span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>reserved</span> <span style=color:#4e9a06>&#34;FOO&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;BAR&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Note that you can&rsquo;t mix field names and numeric values in the same <code>reserved</code>
statement.</p><h2 id=other>Using Other Message Types</h2><p>You can use other message types as field types. For example, let&rsquo;s say you
wanted to include <code>Result</code> messages in each <code>SearchResponse</code> message – to do
this, you can define a <code>Result</code> message type in the same <code>.proto</code> and then
specify a field of type <code>Result</code> in <code>SearchResponse</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>Result</span> <span style=color:#000>results</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Result</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>title</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>snippets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h3 id=importing-definitions>Importing Definitions</h3><p>In the above example, the <code>Result</code> message type is defined in the same file as
<code>SearchResponse</code> – what if the message type you want to use as a field type is
already defined in another <code>.proto</code> file?</p><p>You can use definitions from other <code>.proto</code> files by <em>importing</em> them. To import
another <code>.proto</code>&rsquo;s definitions, you add an import statement to the top of your
file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;myproject/other_protos.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>By default, you can use definitions only from directly imported <code>.proto</code> files.
However, sometimes you may need to move a <code>.proto</code> file to a new location.
Instead of moving the <code>.proto</code> file directly and updating all the call sites in
a single change, you can put a placeholder <code>.proto</code> file in the old location to
forward all the imports to the new location using the <code>import public</code> notion.</p><p><strong>Note that the public import functionality is not available in Java.</strong></p><p><code>import public</code> dependencies can be transitively relied upon by any code
importing the proto containing the <code>import public</code> statement. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// new.proto
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// All definitions are moved here
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// old.proto
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// This is the proto that all clients are importing.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>public</span> <span style=color:#4e9a06>&#34;new.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;other.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// client.proto
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;old.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// You use definitions from old.proto and new.proto, but not other.proto
</span></span></span></code></pre></div><p>The protocol compiler searches for imported files in a set of directories
specified on the protocol compiler command line using the <code>-I</code>/<code>--proto_path</code>
flag. If no flag was given, it looks in the directory in which the compiler was
invoked. In general you should set the <code>--proto_path</code> flag to the root of your
project and use fully qualified names for all imports.</p><h3 id=using-proto2-message-types>Using proto2 Message Types</h3><p>It&rsquo;s possible to import
<a href=/programming-guides/proto>proto2</a> message types and use
them in your proto3 messages, and vice versa. However, proto2 enums cannot be
used directly in proto3 syntax (it&rsquo;s okay if an imported proto2 message uses
them).</p><h2 id=nested>Nested Types</h2><p>You can define and use message types inside other message types, as in the
following example – here the <code>Result</code> message is defined inside the
<code>SearchResponse</code> message:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SearchResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Result</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>title</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>snippets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>Result</span> <span style=color:#000>results</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>If you want to reuse this message type outside its parent message type, you
refer to it as <code>_Parent_._Type_</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SomeOtherMessage</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>SearchResponse.Result</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>You can nest messages as deeply as you like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Outer</span> <span style=color:#000;font-weight:700>{</span>                  <span style=color:#8f5902;font-style:italic>// Level 0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>MiddleAA</span> <span style=color:#000;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>// Level 1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Inner</span> <span style=color:#000;font-weight:700>{</span>   <span style=color:#8f5902;font-style:italic>// Level 2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#000>ival</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>      <span style=color:#204a87;font-weight:700>bool</span>  <span style=color:#000>booly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>MiddleBB</span> <span style=color:#000;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>// Level 1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Inner</span> <span style=color:#000;font-weight:700>{</span>   <span style=color:#8f5902;font-style:italic>// Level 2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>ival</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>      <span style=color:#204a87;font-weight:700>bool</span>  <span style=color:#000>booly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h2 id=updating>Updating A Message Type</h2><p>If an existing message type no longer meets all your needs – for example, you&rsquo;d
like the message format to have an extra field – but you&rsquo;d still like to use
code created with the old format, don&rsquo;t worry! It&rsquo;s very simple to update
message types without breaking any of your existing code. Just remember the
following rules:</p><ul><li>Don&rsquo;t change the field numbers for any existing fields.</li><li>If you add new fields, any messages serialized by code using your &ldquo;old&rdquo;
message format can still be parsed by your new generated code. You should
keep in mind the <a href=#default>default values</a> for these elements so that new
code can properly interact with messages generated by old code. Similarly,
messages created by your new code can be parsed by your old code: old
binaries simply ignore the new field when parsing. See the
<a href=#unknowns>Unknown Fields</a> section for details.</li><li>Fields can be removed, as long as the field number is not used again in your
updated message type. You may want to rename the field instead, perhaps
adding the prefix &ldquo;OBSOLETE_&rdquo;, or make the field number
<a href=#reserved>reserved</a>, so that future users of your <code>.proto</code> can&rsquo;t
accidentally reuse the number.</li><li><code>int32</code>, <code>uint32</code>, <code>int64</code>, <code>uint64</code>, and <code>bool</code> are all compatible – this
means you can change a field from one of these types to another without
breaking forwards- or backwards-compatibility. If a number is parsed from
the wire which doesn&rsquo;t fit in the corresponding type, you will get the same
effect as if you had cast the number to that type in C++ (for example, if a
64-bit number is read as an int32, it will be truncated to 32 bits).</li><li><code>sint32</code> and <code>sint64</code> are compatible with each other but are <em>not</em>
compatible with the other integer types.</li><li><code>string</code> and <code>bytes</code> are compatible as long as the bytes are valid UTF-8.</li><li>Embedded messages are compatible with <code>bytes</code> if the bytes contain an
encoded version of the message.</li><li><code>fixed32</code> is compatible with <code>sfixed32</code>, and <code>fixed64</code> with <code>sfixed64</code>.</li><li>For <code>string</code>, <code>bytes</code>, and message fields, <code>optional</code> is compatible with
<code>repeated</code>. Given serialized data of a repeated field as input, clients that
expect this field to be <code>optional</code> will take the last input value if it&rsquo;s a
primitive type field or merge all input elements if it&rsquo;s a message type
field. Note that this is <strong>not</strong> generally safe for numeric types, including
bools and enums. Repeated fields of numeric types can be serialized in the
<a href=/programming-guides/encoding#packed>packed</a> format,
which will not be parsed correctly when an <code>optional</code> field is expected.</li><li><code>enum</code> is compatible with <code>int32</code>, <code>uint32</code>, <code>int64</code>, and <code>uint64</code> in terms
of wire format (note that values will be truncated if they don&rsquo;t fit).
However be aware that client code may treat them differently when the
message is deserialized: for example, unrecognized proto3 <code>enum</code> types will
be preserved in the message, but how this is represented when the message is
deserialized is language-dependent. Int fields always just preserve their
value.</li><li>Changing a single <code>optional</code> field or extension into a member of a <strong>new</strong>
<code>oneof</code> is safe and binary compatible. Moving multiple fields into a new
<code>oneof</code> may be safe if you are sure that no code sets more than one at a
time. Moving any fields into an existing <code>oneof</code> is not safe. Likewise,
changing a single field <code>oneof</code> to an <code>optional</code> field or extension is safe.</li></ul><h2 id=unknowns>Unknown Fields</h2><p>Unknown fields are well-formed protocol buffer serialized data representing
fields that the parser does not recognize. For example, when an old binary
parses data sent by a new binary with new fields, those new fields become
unknown fields in the old binary.</p><p>Originally, proto3 messages always discarded unknown fields during parsing, but
in version 3.5 we reintroduced the preservation of unknown fields to match the
proto2 behavior. In versions 3.5 and later, unknown fields are retained during
parsing and included in the serialized output.</p><h2 id=any>Any</h2><p>The <code>Any</code> message type lets you use messages as embedded types without having
their .proto definition. An <code>Any</code> contains an arbitrary serialized message as
<code>bytes</code>, along with a URL that acts as a globally unique identifier for and
resolves to that message&rsquo;s type. To use the <code>Any</code> type, you need to
<a href=#other>import</a> <code>google/protobuf/any.proto</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;google/protobuf/any.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>ErrorStatus</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>string</span> <span style=color:#204a87;font-weight:700>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>google.protobuf.Any</span> <span style=color:#000>details</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>The default type URL for a given message type is
<code>type.googleapis.com/_packagename_._messagename_</code>.</p><p>Different language implementations will support runtime library helpers to pack
and unpack <code>Any</code> values in a typesafe manner – for example, in Java, the <code>Any</code>
type will have special <code>pack()</code> and <code>unpack()</code> accessors, while in C++ there are
<code>PackFrom()</code> and <code>UnpackTo()</code> methods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Storing an arbitrary message type in Any.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>NetworkErrorDetails</span> <span style=color:#000>details</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>...;</span>
</span></span><span style=display:flex><span><span style=color:#000>ErrorStatus</span> <span style=color:#000>status</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>add_details</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>PackFrom</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>details</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Reading an arbitrary message from Any.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ErrorStatus</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>...;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Any</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#f57900>detail</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000>status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>details</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>detail</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Is</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>NetworkErrorDetails</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>NetworkErrorDetails</span> <span style=color:#000>network_error</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>detail</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UnpackTo</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>network_error</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span> <span style=color:#000>processing</span> <span style=color:#000>network_error</span> <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>Currently the runtime libraries for working with <code>Any</code> types are under
development</strong>.</p><p>If you are already familiar with
<a href=/programming-guides/proto>proto2 syntax</a>, the <code>Any</code> can
hold arbitrary proto3 messages, similar to proto2 messages which can allow
<a href=/programming-guides/proto#extensions>extensions</a>.</p><h2 id=oneof>Oneof</h2><p>If you have a message with many fields and where at most one field will be set
at the same time, you can enforce this behavior and save memory by using the
oneof feature.</p><p>Oneof fields are like regular fields except all the fields in a oneof share
memory, and at most one field can be set at the same time. Setting any member of
the oneof automatically clears all the other members. You can check which value
in a oneof is set (if any) using a special <code>case()</code> or <code>WhichOneof()</code> method,
depending on your chosen language.</p><p>Note that if <em>multiple values are set, the last set value as determined by the
order in the proto will overwrite all previous ones</em>.</p><h3 id=using-oneof>Using Oneof</h3><p>To define a oneof in your <code>.proto</code> you use the <code>oneof</code> keyword followed by your
oneof name, in this case <code>test_oneof</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SampleMessage</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>oneof</span> <span style=color:#000>test_oneof</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#000>SubMessage</span> <span style=color:#000>sub_message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>9</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>You then add your oneof fields to the oneof definition. You can add fields of
any type, except <code>map</code> fields and <code>repeated</code> fields.</p><p>In your generated code, oneof fields have the same getters and setters as
regular fields. You also get a special method for checking which value (if any)
in the oneof is set. You can find out more about the oneof API for your chosen
language in the relevant <a href=/reference/>API reference</a>.</p><h3 id=oneof-features>Oneof Features</h3><ul><li><p>Setting a oneof field will automatically clear all other members of the
oneof. So if you set several oneof fields, only the <em>last</em> field you set
will still have a value.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>SampleMessage</span> <span style=color:#000>message</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_name</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>CHECK</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>has_name</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mutable_sub_message</span><span style=color:#000;font-weight:700>();</span>   <span style=color:#8f5902;font-style:italic>// Will clear name field.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>CHECK</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>has_name</span><span style=color:#000;font-weight:700>());</span>
</span></span></code></pre></div></li><li><p>If the parser encounters multiple members of the same oneof on the wire,
only the last member seen is used in the parsed message.</p></li><li><p>A oneof cannot be <code>repeated</code>.</p></li><li><p>Reflection APIs work for oneof fields.</p></li><li><p>If you set a oneof field to the default value (such as setting an int32
oneof field to 0), the &ldquo;case&rdquo; of that oneof field will be set, and the value
will be serialized on the wire.</p></li><li><p>If you&rsquo;re using C++, make sure your code doesn&rsquo;t cause memory crashes. The
following sample code will crash because <code>sub_message</code> was already deleted
by calling the <code>set_name()</code> method.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>SampleMessage</span> <span style=color:#000>message</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>SubMessage</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>sub_message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mutable_sub_message</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_name</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>);</span>      <span style=color:#8f5902;font-style:italic>// Will delete sub_message
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>sub_message</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>set_</span><span style=color:#000;font-weight:700>...</span>            <span style=color:#8f5902;font-style:italic>// Crashes here
</span></span></span></code></pre></div></li><li><p>Again in C++, if you <code>Swap()</code> two messages with oneofs, each message will
end up with the other’s oneof case: in the example below, <code>msg1</code> will have a
<code>sub_message</code> and <code>msg2</code> will have a <code>name</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>SampleMessage</span> <span style=color:#000>msg1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>msg1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_name</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>SampleMessage</span> <span style=color:#000>msg2</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>msg2</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mutable_sub_message</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000>msg1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>swap</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>msg2</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>CHECK</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>msg1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>has_sub_message</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span><span style=color:#000>CHECK</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>msg2</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>has_name</span><span style=color:#000;font-weight:700>());</span>
</span></span></code></pre></div></li></ul><h3 id=backwards-compatibility-issues>Backwards-compatibility issues</h3><p>Be careful when adding or removing oneof fields. If checking the value of a
oneof returns <code>None</code>/<code>NOT_SET</code>, it could mean that the oneof has not been set or
it has been set to a field in a different version of the oneof. There is no way
to tell the difference, since there&rsquo;s no way to know if an unknown field on the
wire is a member of the oneof.</p><h4 id=tag-reuse-issues>Tag Reuse Issues</h4><ul><li><strong>Move fields into or out of a oneof</strong>: You may lose some of your
information (some fields will be cleared) after the message is serialized
and parsed. However, you can safely move a single field into a <strong>new</strong> oneof
and may be able to move multiple fields if it is known that only one is ever
set.</li><li><strong>Delete a oneof field and add it back</strong>: This may clear your currently set
oneof field after the message is serialized and parsed.</li><li><strong>Split or merge oneof</strong>: This has similar issues to moving regular fields.</li></ul><h2 id=maps>Maps</h2><p>If you want to create an associative map as part of your data definition,
protocol buffers provides a handy shortcut syntax:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#000>map</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>key_type</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>value_type</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000>map_field</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>N</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>&mldr;where the <code>key_type</code> can be any integral or string type (so, any
<a href=#scalar>scalar</a> type except for floating point types and <code>bytes</code>). Note that
enum is not a valid <code>key_type</code>. The <code>value_type</code> can be any type except another
map.</p><p>So, for example, if you wanted to create a map of projects where each <code>Project</code>
message is associated with a string key, you could define it like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#000>map</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>Project</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000>projects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><ul><li>Map fields cannot be <code>repeated</code>.</li><li>Wire format ordering and map iteration ordering of map values are undefined,
so you cannot rely on your map items being in a particular order.</li><li>When generating text format for a <code>.proto</code>, maps are sorted by key. Numeric
keys are sorted numerically.</li><li>When parsing from the wire or when merging, if there are duplicate map keys
the last key seen is used. When parsing a map from text format, parsing may
fail if there are duplicate keys.</li><li>If you provide a key but no value for a map field, the behavior when the
field is serialized is language-dependent. In C++, Java, Kotlin, and Python
the default value for the type is serialized, while in other languages
nothing is serialized.</li></ul><p>The generated map API is currently available for all proto3 supported languages.
You can find out more about the map API for your chosen language in the relevant
<a href=/reference/>API reference</a>.</p><h3 id=backwards-compatibility>Backwards Compatibility</h3><p>The map syntax is equivalent to the following on the wire, so protocol buffers
implementations that do not support maps can still handle your data:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>MapFieldEntry</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>key_type</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>value_type</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>MapFieldEntry</span> <span style=color:#000>map_field</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>N</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Any protocol buffers implementation that supports maps must both produce and
accept data that can be accepted by the above definition.</p><h2 id=packages>Packages</h2><p>You can add an optional <code>package</code> specifier to a <code>.proto</code> file to prevent name
clashes between protocol message types.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>bar</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Open</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>You can then use the package specifier when defining fields of your message
type:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>foo.bar.Open</span> <span style=color:#000>open</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>The way a package specifier affects the generated code depends on your chosen
language:</p><ul><li>In <strong>C++</strong> the generated classes are wrapped inside a C++ namespace. For
example, <code>Open</code> would be in the namespace <code>foo::bar</code>.</li><li>In <strong>Java</strong> and <strong>Kotlin</strong>, the package is used as the Java package, unless
you explicitly provide an <code>option java_package</code> in your <code>.proto</code> file.</li><li>In <strong>Python</strong>, the package directive is ignored, since Python modules are
organized according to their location in the file system.</li><li>In <strong>Go</strong>, the package is used as the Go package name, unless you explicitly
provide an <code>option go_package</code> in your <code>.proto</code> file.</li><li>In <strong>Ruby</strong>, the generated classes are wrapped inside nested Ruby
namespaces, converted to the required Ruby capitalization style (first
letter capitalized; if the first character is not a letter, <code>PB_</code> is
prepended). For example, <code>Open</code> would be in the namespace <code>Foo::Bar</code>.</li><li>In <strong>C#</strong> the package is used as the namespace after converting to
PascalCase, unless you explicitly provide an <code>option csharp_namespace</code> in
your <code>.proto</code> file. For example, <code>Open</code> would be in the namespace <code>Foo.Bar</code>.</li></ul><h3 id=packages-and-name-resolution>Packages and Name Resolution</h3><p>Type name resolution in the protocol buffer language works like C++: first the
innermost scope is searched, then the next-innermost, and so on, with each
package considered to be &ldquo;inner&rdquo; to its parent package. A leading &lsquo;.&rsquo; (for
example, <code>.foo.bar.Baz</code>) means to start from the outermost scope instead.</p><p>The protocol buffer compiler resolves all type names by parsing the imported
<code>.proto</code> files. The code generator for each language knows how to refer to each
type in that language, even if it has different scoping rules.</p><h2 id=services>Defining Services</h2><p>If you want to use your message types with an RPC (Remote Procedure Call)
system, you can define an RPC service interface in a <code>.proto</code> file and the
protocol buffer compiler will generate service interface code and stubs in your
chosen language. So, for example, if you want to define an RPC service with a
method that takes your <code>SearchRequest</code> and returns a <code>SearchResponse</code>, you can
define it in your <code>.proto</code> file as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>service</span> <span style=color:#000>SearchService</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>Search</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>SearchRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>SearchResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>The most straightforward RPC system to use with protocol buffers is
<a href=https://grpc.io>gRPC</a>: a language- and platform-neutral open source RPC system
developed at Google. gRPC works particularly well with protocol buffers and lets
you generate the relevant RPC code directly from your <code>.proto</code> files using a
special protocol buffer compiler plugin.</p><p>If you don&rsquo;t want to use gRPC, it&rsquo;s also possible to use protocol buffers with
your own RPC implementation. You can find out more about this in the
<a href=/programming-guides/proto#services>Proto2 Language Guide</a>.</p><p>There are also a number of ongoing third-party projects to develop RPC
implementations for Protocol Buffers. For a list of links to projects we know
about, see the
<a href=https://github.com/protocolbuffers/protobuf/blob/master/docs/third_party.md>third-party add-ons wiki page</a>.</p><h2 id=json>JSON Mapping</h2><p>Proto3 supports a canonical encoding in JSON, making it easier to share data
between systems. The encoding is described on a type-by-type basis in the table
below.</p><p>If a value is missing in the JSON-encoded data or if its value is <code>null</code>, it
will be interpreted as the appropriate <a href=#default>default value</a> when parsed
into a protocol buffer. If a field has the default value in the protocol buffer,
it will be omitted in the JSON-encoded data by default to save space. An
implementation may provide options to emit fields with default values in the
JSON-encoded output.</p><table><tbody><tr><th>proto3</th><th>JSON</th><th>JSON example</th><th>Notes</th></tr><tr><td>message</td><td>object</td><td><code>{"fooBar": v, "g": null, …}</code></td><td>Generates JSON objects. Message field names are mapped to
lowerCamelCase and become JSON object keys. If the
<code>json_name</code> field option is specified, the specified value
will be used as the key instead. Parsers accept both the lowerCamelCase
name (or the one specified by the <code>json_name</code> option) and the
original proto field name. <code>null</code> is an accepted value for
all field types and treated as the default value of the corresponding
field type.</td></tr><tr><td>enum</td><td>string</td><td><code>"FOO_BAR"</code></td><td>The name of the enum value as specified in proto is used. Parsers
accept both enum names and integer values.</td></tr><tr><td>map&lt;K,V></td><td>object</td><td><code>{"k": v, …}</code></td><td>All keys are converted to strings.</td></tr><tr><td>repeated V</td><td>array</td><td><code>[v, …]</code></td><td><code>null</code> is accepted as the empty list <code>[]</code>.</td></tr><tr><td>bool</td><td>true, false</td><td><code>true, false</code></td><td></td></tr><tr><td>string</td><td>string</td><td><code>"Hello World!"</code></td><td></td></tr><tr><td>bytes</td><td>base64 string</td><td><code>"YWJjMTIzIT8kKiYoKSctPUB+"</code></td><td>JSON value will be the data encoded as a string using standard base64
encoding with paddings. Either standard or URL-safe base64 encoding
with/without paddings are accepted.</td></tr><tr><td>int32, fixed32, uint32</td><td>number</td><td><code>1, -10, 0</code></td><td>JSON value will be a decimal number. Either numbers or strings are
accepted.</td></tr><tr><td>int64, fixed64, uint64</td><td>string</td><td><code>"1", "-10"</code></td><td>JSON value will be a decimal string. Either numbers or strings are
accepted.</td></tr><tr><td>float, double</td><td>number</td><td><code>1.1, -10.0, 0, "NaN", "Infinity"</code></td><td>JSON value will be a number or one of the special string values "NaN",
"Infinity", and "-Infinity". Either numbers or strings are accepted.
Exponent notation is also accepted. -0 is considered equivalent to 0.</td></tr><tr><td>Any</td><td><code>object</code></td><td><code>{"@type": "url", "f": v, … }</code></td><td>If the <code>Any</code> contains a value that has a special JSON
mapping, it will be converted as follows: <code>{"@type": xxx, "value":
yyy}</code>. Otherwise, the value will be converted into a JSON object,
and the <code>"@type"</code> field will be inserted to indicate the
actual data type.</td></tr><tr><td>Timestamp</td><td>string</td><td><code>"1972-01-01T10:00:20.021Z"</code></td><td>Uses RFC 3339, where generated output will always be Z-normalized
and uses 0, 3, 6 or 9 fractional digits. Offsets other than "Z" are
also accepted.</td></tr><tr><td>Duration</td><td>string</td><td><code>"1.000340012s", "1s"</code></td><td>Generated output always contains 0, 3, 6, or 9 fractional digits,
depending on required precision, followed by the suffix "s". Accepted
are any fractional digits (also none) as long as they fit into
nano-seconds precision and the suffix "s" is required.</td></tr><tr><td>Struct</td><td><code>object</code></td><td><code>{ … }</code></td><td>Any JSON object. See <code>struct.proto</code>.</td></tr><tr><td>Wrapper types</td><td>various types</td><td><code>2, "2", "foo", true, "true", null, 0, …</code></td><td>Wrappers use the same representation in JSON as the wrapped primitive
type, except that <code>null</code> is allowed and preserved during data
conversion and transfer.</td></tr><tr><td>FieldMask</td><td>string</td><td><code>"f.fooBar,h"</code></td><td>See <code>field_mask.proto</code>.</td></tr><tr><td>ListValue</td><td>array</td><td><code>[foo, bar, …]</code></td><td></td></tr><tr><td>Value</td><td>value</td><td></td><td>Any JSON value. Check
<a href=/reference/protobuf/google.protobuf#value>google.protobuf.Value</a>
for details.</td></tr><tr><td>NullValue</td><td>null</td><td></td><td>JSON null</td></tr><tr><td>Empty</td><td>object</td><td><code>{}</code></td><td>An empty JSON object</td></tr></tbody></table><h3 id=json-options>JSON Options</h3><p>A proto3 JSON implementation may provide the following options:</p><ul><li><strong>Emit fields with default values</strong>: Fields with default values are omitted
by default in proto3 JSON output. An implementation may provide an option to
override this behavior and output fields with their default values.</li><li><strong>Ignore unknown fields</strong>: Proto3 JSON parser should reject unknown fields
by default but may provide an option to ignore unknown fields in parsing.</li><li><strong>Use proto field name instead of lowerCamelCase name</strong>: By default proto3
JSON printer should convert the field name to lowerCamelCase and use that as
the JSON name. An implementation may provide an option to use proto field
name as the JSON name instead. Proto3 JSON parsers are required to accept
both the converted lowerCamelCase name and the proto field name.</li><li><strong>Emit enum values as integers instead of strings</strong>: The name of an enum
value is used by default in JSON output. An option may be provided to use
the numeric value of the enum value instead.</li></ul><h2 id=options>Options</h2><p>Individual declarations in a <code>.proto</code> file can be annotated with a number of
<em>options</em>. Options do not change the overall meaning of a declaration, but may
affect the way it is handled in a particular context. The complete list of
available options is defined in <code>google/protobuf/descriptor.proto</code>.</p><p>Some options are file-level options, meaning they should be written at the
top-level scope, not inside any message, enum, or service definition. Some
options are message-level options, meaning they should be written inside message
definitions. Some options are field-level options, meaning they should be
written inside field definitions. Options can also be written on enum types,
enum values, oneof fields, service types, and service methods; however, no
useful options currently exist for any of these.</p><p>Here are a few of the most commonly used options:</p><ul><li><p><code>java_package</code> (file option): The package you want to use for your generated
Java/Kotlin classes. If no explicit <code>java_package</code> option is given in the
<code>.proto</code> file, then by default the proto package (specified using the
&ldquo;package&rdquo; keyword in the <code>.proto</code> file) will be used. However, proto
packages generally do not make good Java packages since proto packages are
not expected to start with reverse domain names. If not generating Java or
Kotlin code, this option has no effect.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>java_package</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.example.foo&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div></li><li><p><code>java_outer_classname</code> (file option): The class name (and hence the file
name) for the wrapper Java class you want to generate. If no explicit
<code>java_outer_classname</code> is specified in the <code>.proto</code> file, the class name
will be constructed by converting the <code>.proto</code> file name to camel-case (so
<code>foo_bar.proto</code> becomes <code>FooBar.java</code>). If the <code>java_multiple_files</code> option
is disabled, then all other classes/enums/etc. generated for the <code>.proto</code>
file will be generated <em>within</em> this outer wrapper Java class as nested
classes/enums/etc. If not generating Java code, this option has no effect.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>java_outer_classname</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Ponycopter&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div></li><li><p><code>java_multiple_files</code> (file option): If false, only a single <code>.java</code> file
will be generated for this <code>.proto</code> file, and all the Java
classes/enums/etc. generated for the top-level messages, services, and
enumerations will be nested inside of an outer class (see
<code>java_outer_classname</code>). If true, separate <code>.java</code> files will be generated
for each of the Java classes/enums/etc. generated for the top-level
messages, services, and enumerations, and the wrapper Java class generated
for this <code>.proto</code> file won&rsquo;t contain any nested classes/enums/etc. This is a
Boolean option which defaults to <code>false</code>. If not generating Java code, this
option has no effect.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>java_multiple_files</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div></li><li><p><code>optimize_for</code> (file option): Can be set to <code>SPEED</code>, <code>CODE_SIZE</code>, or
<code>LITE_RUNTIME</code>. This affects the C++ and Java code generators (and possibly
third-party generators) in the following ways:</p><ul><li><code>SPEED</code> (default): The protocol buffer compiler will generate code for
serializing, parsing, and performing other common operations on your
message types. This code is highly optimized.</li><li><code>CODE_SIZE</code>: The protocol buffer compiler will generate minimal classes
and will rely on shared, reflection-based code to implement
serialialization, parsing, and various other operations. The generated
code will thus be much smaller than with <code>SPEED</code>, but operations will be
slower. Classes will still implement exactly the same public API as they
do in <code>SPEED</code> mode. This mode is most useful in apps that contain a very
large number of <code>.proto</code> files and do not need all of them to be
blindingly fast.</li><li><code>LITE_RUNTIME</code>: The protocol buffer compiler will generate classes that
depend only on the &ldquo;lite&rdquo; runtime library (<code>libprotobuf-lite</code> instead of
<code>libprotobuf</code>). The lite runtime is much smaller than the full library
(around an order of magnitude smaller) but omits certain features like
descriptors and reflection. This is particularly useful for apps running
on constrained platforms like mobile phones. The compiler will still
generate fast implementations of all methods as it does in <code>SPEED</code> mode.
Generated classes will only implement the <code>MessageLite</code> interface in
each language, which provides only a subset of the methods of the full
<code>Message</code> interface.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>optimize_for</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CODE_SIZE</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div></li><li><p><code>cc_enable_arenas</code> (file option): Enables
<a href=/reference/cpp/arenas>arena allocation</a> for C++
generated code.</p></li><li><p><code>objc_class_prefix</code> (file option): Sets the Objective-C class prefix which
is prepended to all Objective-C generated classes and enums from this
.proto. There is no default. You should use prefixes that are between 3-5
uppercase characters as
<a href=https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/Conventions/Conventions.html#//apple_ref/doc/uid/TP40011210-CH10-SW4>recommended by Apple</a>.
Note that all 2 letter prefixes are reserved by Apple.</p></li><li><p><code>deprecated</code> (field option): If set to <code>true</code>, indicates that the field is
deprecated and should not be used by new code. In most languages this has no
actual effect. In Java, this becomes a <code>@Deprecated</code> annotation. In the
future, other language-specific code generators may generate deprecation
annotations on the field&rsquo;s accessors, which will in turn cause a warning to
be emitted when compiling code which attempts to use the field. If the field
is not used by anyone and you want to prevent new users from using it,
consider replacing the field declaration with a <a href=#reserved>reserved</a>
statement.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>old_field</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>deprecated</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span></code></pre></div></li></ul><h3 id=customoptions>Custom Options</h3><p>Protocol Buffers also allows you to define and use your own options. This is an
<strong>advanced feature</strong> which most people don&rsquo;t need. If you do think you need to
create your own options, see the
<a href=/programming-guides/proto#customoptions>Proto2 Language Guide</a>
for details. Note that creating custom options uses
<a href=/programming-guides/proto#extensions>extensions</a>, which
are permitted only for custom options in proto3.</p><h2 id=generating>Generating Your Classes</h2><p>To generate the Java, Kotlin, Python, C++, Go, Ruby, Objective-C, or C# code you
need to work with the message types defined in a <code>.proto</code> file, you need to run
the protocol buffer compiler <code>protoc</code> on the <code>.proto</code>. If you haven&rsquo;t installed
the compiler, <a href=/downloads>download the package</a> and
follow the instructions in the README. For Go, you also need to install a
special code generator plugin for the compiler: you can find this and
installation instructions in the
<a href=https://github.com/golang/protobuf/>golang/protobuf</a> repository on GitHub.</p><p>The Protocol Compiler is invoked as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>protoc --proto_path<span style=color:#ce5c00;font-weight:700>=</span>IMPORT_PATH --cpp_out<span style=color:#ce5c00;font-weight:700>=</span>DST_DIR --java_out<span style=color:#ce5c00;font-weight:700>=</span>DST_DIR --python_out<span style=color:#ce5c00;font-weight:700>=</span>DST_DIR --go_out<span style=color:#ce5c00;font-weight:700>=</span>DST_DIR --ruby_out<span style=color:#ce5c00;font-weight:700>=</span>DST_DIR --objc_out<span style=color:#ce5c00;font-weight:700>=</span>DST_DIR --csharp_out<span style=color:#ce5c00;font-weight:700>=</span>DST_DIR path/to/file.proto
</span></span></code></pre></div><ul><li><p><code>IMPORT_PATH</code> specifies a directory in which to look for <code>.proto</code> files when
resolving <code>import</code> directives. If omitted, the current directory is used.
Multiple import directories can be specified by passing the <code>--proto_path</code>
option multiple times; they will be searched in order. <code>-I=_IMPORT_PATH_</code>
can be used as a short form of <code>--proto_path</code>.</p></li><li><p>You can provide one or more <em>output directives</em>:</p><ul><li><code>--cpp_out</code> generates C++ code in <code>DST_DIR</code>. See the
<a href=/reference/cpp/cpp-generated>C++ generated code reference</a>
for more.</li><li><code>--java_out</code> generates Java code in <code>DST_DIR</code>. See the
<a href=/reference/java/java-generated>Java generated code reference</a>
for more.</li><li><code>--kotlin_out</code> generates additional Kotlin code in <code>DST_DIR</code>. See the
<a href=/reference/kotlin/kotlin-generated>Kotlin generated code reference</a>
for more.</li><li><code>--python_out</code> generates Python code in <code>DST_DIR</code>. See the
<a href=/reference/python/python-generated>Python generated code reference</a>
for more.</li><li><code>--go_out</code> generates Go code in <code>DST_DIR</code>. See the
<a href=/reference/go/go-generated>Go generated code reference</a>
for more.</li><li><code>--ruby_out</code> generates Ruby code in <code>DST_DIR</code>. See the
<a href=/reference/ruby/ruby-generated>Ruby generated code reference</a>
for more.</li><li><code>--objc_out</code> generates Objective-C code in <code>DST_DIR</code>. See the
<a href=/reference/objective-c/objective-c-generated>Objective-C generated code reference</a>
for more.</li><li><code>--csharp_out</code> generates C# code in <code>DST_DIR</code>. See the
<a href=/reference/csharp/csharp-generated>C# generated code reference</a>
for more.</li><li><code>--php_out</code> generates PHP code in <code>DST_DIR</code>. See the
<a href=/reference/php/php-generated>PHP generated code reference</a>
for more.</li></ul><p>As an extra convenience, if the <code>DST_DIR</code> ends in <code>.zip</code> or <code>.jar</code>, the
compiler will write the output to a single ZIP-format archive file with the
given name. <code>.jar</code> outputs will also be given a manifest file as required by
the Java JAR specification. Note that if the output archive already exists,
it will be overwritten; the compiler is not smart enough to add files to an
existing archive.</p></li><li><p>You must provide one or more <code>.proto</code> files as input. Multiple <code>.proto</code>
files can be specified at once. Although the files are named relative to the
current directory, each file must reside in one of the <code>IMPORT_PATH</code>s so
that the compiler can determine its canonical name.</p></li></ul><h2 id=location>File location</h2><p>Prefer not to put <code>.proto</code> files in the same
directory as other language sources. Consider
creating a subpackage <code>proto</code> for <code>.proto</code> files, under the root package for
your project.</p><h3 id=location-language-agnostic>Location Should be Language-agnostic</h3><p>When working with Java code, it&rsquo;s handy to put related <code>.proto</code> files in the
same directory as the Java source. However, if any non-Java code ever uses the
same protos, the path prefix will no longer make sense. So in
general, put the protos in a related language-agnostic directory such as
<code>//myteam/mypackage</code>.</p><p>The exception to this rule is when it&rsquo;s clear that the protos will be used only
in a Java context, such as for testing.</p><h2 id=platforms>Supported Platforms</h2><p>For information about:</p><ul><li>the operating systems, compilers, build systems, and C++ versions that are
supported, see
<a href=https://opensource.google/documentation/policies/cplusplus-support>Foundational C++ Support Policy</a>.</li><li>the PHP versions that are supported, see
<a href=https://cloud.google.com/php/getting-started/supported-php-versions>Supported PHP versions</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-366470fab6e216998242d3b41ea134ab>3 - Style Guide</h1><div class=lead>This topic provides direction for how best to stucture your proto definitions.</div><p>This document provides a style guide for <code>.proto</code> files. By following these
conventions, you&rsquo;ll make your protocol buffer message definitions and their
corresponding classes consistent and easy to read.</p><p>Note that protocol buffer style has evolved over time, so it is likely that you
will see <code>.proto</code> files written in different conventions or styles. <strong>Respect
the existing style</strong> when you modify these files. <strong>Consistency is key</strong>.
However, it is best to adopt the current best style when you are creating a new
<code>.proto</code> file.</p><h2 id=standard-file-formatting>Standard File Formatting</h2><ul><li>Keep the line length to 80 characters.</li><li>Use an indent of 2 spaces.</li><li>Prefer the use of double quotes for strings.</li></ul><h2 id=file-structure>File Structure</h2><p>Files should be named <code>lower_snake_case.proto</code>.</p><p>All files should be ordered in the following manner:</p><ol><li>License header (if applicable)</li><li>File overview</li><li>Syntax</li><li>Package</li><li>Imports (sorted)</li><li>File options</li><li>Everything else</li></ol><h2 id=packages>Packages</h2><p>Package names should be in lowercase. Package names should have unique names
based on the project name, and possibly based on the path of the file containing
the protocol buffer type definitions.</p><h2 id=message-field-names>Message and Field Names</h2><p>Use CamelCase (with an initial capital) for message names – for example,
<code>SongServerRequest</code>. Use underscore_separated_names for field names (including
oneof field and extension names) – for example, <code>song_name</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SongServerRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>song_name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Using this naming convention for field names gives you accessors like those
shown in the the following two code samples.</p><p>C++:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>song_name</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>set_song_name</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>x</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Java:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getSongName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Builder</span> <span style=color:#000>setSongName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>If your field name contains a number, the number should appear after the letter
instead of after the underscore. For example, use <code>song_name1</code> instead of
<code>song_name_1</code></p><h2 id=repeated-fields>Repeated Fields</h2><p>Use pluralized names for repeated fields.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>keys</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>MyMessage</span> <span style=color:#000>accounts</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>17</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><h2 id=enums>Enums</h2><p>Use CamelCase (with an initial capital) for enum type names and
CAPITALS_WITH_UNDERSCORES for value names:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>FooBar</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>FOO_BAR_UNSPECIFIED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>FOO_BAR_FIRST_VALUE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>FOO_BAR_SECOND_VALUE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Each enum value should end with a semicolon, not a comma. Prefer prefixing enum
values instead of surrounding them in an enclosing message. The zero value enum
should have the suffix <code>UNSPECIFIED</code>.</p><h2 id=services>Services</h2><p>If your <code>.proto</code> defines an RPC service, you should use CamelCase (with an
initial capital) for both the service name and any RPC method names:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>service</span> <span style=color:#000>FooService</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>GetSomething</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>GetSomethingRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>GetSomethingResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>ListSomething</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ListSomethingRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>ListSomethingResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h2 id=avoid>Things to Avoid</h2><ul><li>Required fields (only for proto2)</li><li>Groups (only for proto2)</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-9b592df4dc43102283594f5f70fe2cf7>4 - Encoding</h1><div class=lead>This topic explains how Protocol Buffers encodes data to files or to the wire.</div><p>This document describes the protocol buffer <em>wire format</em>, which defines the
details of how your message is sent on the wire and how much space it consumes
on disk. You probably don&rsquo;t need to understand this to use protocol buffers in
your application, but it&rsquo;s useful information for doing optimizations.</p><p>If you already know the concepts but want a reference, skip to the
<a href=#cheat-sheet>Condensed reference card</a> section.</p><p><a href=https://github.com/protocolbuffers/protoscope>Protoscope</a> is a very simple
language for describing snippets of the low-level wire format, which we&rsquo;ll use
to provide a visual reference for the encoding of various messages. Protoscope&rsquo;s
syntax consists of a sequence of <em>tokens</em> that each encode down to a specific
byte sequence.</p><p>For example, backticks denote a raw hex literal, like <code>`70726f746f6275660a`</code>. This encodes into the exact bytes denoted as hex in the literal. Quotes
denote UTF-8 strings, like <code>"Hello, Protobuf!"</code>. This literal is synonymous with
<code>`48656c6c6f2c2050726f746f62756621`</code> (which, if you observe closely, is
composed of ASCII bytes). We&rsquo;ll introduce more of the Protoscope language as we
discuss aspects of the wire format.</p><p>The Protoscope tool can also dump encoded protocol buffers as text. See
<a href=https://github.com/protocolbuffers/protoscope/tree/main/testdata>https://github.com/protocolbuffers/protoscope/tree/main/testdata</a> for examples.</p><h2 id=simple>A Simple Message</h2><p>Let&rsquo;s say you have the following very simple message definition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Test1</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>In an application, you create a <code>Test1</code> message and set <code>a</code> to 150. You then
serialize the message to an output stream. If you were able to examine the
encoded message, you&rsquo;d see three bytes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#0000cf;font-weight:700>08</span> <span style=color:#0000cf;font-weight:700>96</span> <span style=color:#0000cf;font-weight:700>01</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>So far, so small and numeric &ndash; but what does it mean? If you use the Protoscope
tool to dump those bytes, you&rsquo;d get something like <code>1: 150</code>. How does it know
this is the contents of the message?</p><h2 id=varints>Base 128 Varints</h2><p>Variable-width integers, or <em>varints</em>, are at the core of the wire format. They
allow encoding unsigned 64-bit integers using anywhere between one and ten
bytes, with small values using fewer bytes.</p><p>Each byte in the varint has a <em>continuation bit</em> that indicates if the byte that
follows it is part of the varint. This is the <em>most significant bit</em> (MSB) of
the byte (sometimes also called the <em>sign bit</em>). The lower 7 bits are a payload;
the resulting integer is built by appending together the 7-bit payloads of its
constituent bytes.</p><p>So, for example, here is the number 1, encoded as <code>`01`</code> &ndash; it&rsquo;s a single
byte, so the MSB is not set:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0001</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>^</span> <span style=color:#000>msb</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>And here is 150, encoded as <code>`9601`</code> &ndash; this is a bit more complicated:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#0000cf;font-weight:700>10010110</span> <span style=color:#0000cf;font-weight:700>00000001</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>^</span> <span style=color:#000>msb</span>    <span style=color:#a40000>^</span> <span style=color:#000>msb</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>How do you figure out that this is 150? First you drop the MSB from each byte,
as this is just there to tell us whether we&rsquo;ve reached the end of the number (as
you can see, it&rsquo;s set in the first byte as there is more than one byte in the
varint). Then we concatenate the 7-bit payloads, and interpret it as a
little-endian, 64-bit unsigned integer:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#0000cf;font-weight:700>10010110</span> <span style=color:#0000cf;font-weight:700>00000001</span>        <span style=color:#8f5902;font-style:italic>// Original inputs.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span> <span style=color:#0000cf;font-weight:700>0010110</span>  <span style=color:#0000cf;font-weight:700>0000001</span>        <span style=color:#8f5902;font-style:italic>// Drop continuation bits.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span> <span style=color:#0000cf;font-weight:700>0000001</span>  <span style=color:#0000cf;font-weight:700>0010110</span>        <span style=color:#8f5902;font-style:italic>// Put into little-endian order.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span> <span style=color:#0000cf;font-weight:700>10010110</span>                <span style=color:#8f5902;font-style:italic>// Concatenate.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span> <span style=color:#0000cf;font-weight:700>128</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>16</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>150</span>  <span style=color:#8f5902;font-style:italic>// Interpret as integer.
</span></span></span></code></pre></div><p>Because varints are so crucial to protocol buffers, in protoscope syntax, we
refer to them as plain integers. <code>150</code> is the same as <code>`9601`</code>.</p><h2 id=structure>Message Structure</h2><p>A protocol buffer message is a series of key-value pairs. The binary version of
a message just uses the field&rsquo;s number as the key &ndash; the name and declared type
for each field can only be determined on the decoding end by referencing the
message type&rsquo;s definition (i.e. the <code>.proto</code> file). Protoscope does not have
access to this information, so it can only provide the field numbers.</p><p>When a message is encoded, each key-value pair is turned into a <em>record</em>
consisting of the field number, a wire type and a payload. The wire type tells
the parser how big the payload after it is. This allows old parsers to skip over
new fields they don&rsquo;t understand. This type of scheme is sometimes called
<a href=https://en.wikipedia.org/wiki/Type%E2%80%93length%E2%80%93value>Tag-Length-Value</a>,
or TLV.</p><p>There are six wire types: <code>VARINT</code>, <code>I64</code>, <code>LEN</code>, <code>SGROUP</code>, <code>EGROUP</code>, and <code>I32</code></p><table><thead><tr><th>ID</th><th>Name</th><th>Used For</th></tr></thead><tbody><tr><td>0</td><td>VARINT</td><td>int32, int64, uint32, uint64, sint32, sint64, bool, enum</td></tr><tr><td>1</td><td>I64</td><td>fixed64, sfixed64, double</td></tr><tr><td>2</td><td>LEN</td><td>string, bytes, embedded messages, packed repeated fields</td></tr><tr><td>3</td><td>SGROUP</td><td>group start (deprecated)</td></tr><tr><td>4</td><td>EGROUP</td><td>group end (deprecated)</td></tr><tr><td>5</td><td>I32</td><td>fixed32, sfixed32, float</td></tr></tbody></table><p>The &ldquo;tag&rdquo; of a record is encoded as a varint formed from the field number and
the wire type via the formula <code>(field_number &lt;&lt; 3) | wire_type</code>. In other words,
after decoding the varint representing a field, the low 3 bits tell us the wire
type, and the rest of the integer tells us the field number.</p><p>Now let&rsquo;s look at our simple example again. You now know that the first number
in the stream is always a varint key, and here it&rsquo;s <code>`08`</code>, or (dropping the
MSB):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#0000cf;font-weight:700>000</span> <span style=color:#0000cf;font-weight:700>1000</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>You take the last three bits to get the wire type (0) and then right-shift by
three to get the field number (1). Protoscope represents a tag as an integer
followed by a colon and the wire type, so we can write the above bytes as
<code>1:VARINT</code>.</p><p>Because the wire type is 0, or <code>VARINT</code>, we know that we need to decode a varint
to get the payload. As we saw above, the bytes <code>`9601`</code> varint-decode to
150, giving us our record. We can write it in Protoscope as <code>1:VARINT 150</code>.</p><p>Protoscope can infer the type for a tag if there is whitespace after the <code>:</code>. It
does so by looking ahead at the next token and guessing what you meant (the
rules are documented in detail in
<a href=https://github.com/protocolbuffers/protoscope/blob/main/language.txt>Protoscope&rsquo;s language.txt</a>).
For example, in <code>1: 150</code>, there is a varint immediately after the untyped tag,
so Protoscope infers its type to be <code>VARINT</code>. If you wrote <code>2: {}</code>, it would see
the <code>{</code> and guess <code>LEN</code>; if you wrote <code>3: 5i32</code> it would guess <code>I32</code>, and so on.</p><h2 id=int-types>More Integer Types</h2><h3 id=bools-and-enums>Bools and Enums</h3><p>Bools and enums are both encoded as if they were <code>int32</code>s. Bools, in particular,
always encode as either <code>`00`</code> or <code>`01`</code>. In Protoscope, <code>false</code> and
<code>true</code> are aliases for these byte strings.</p><h3 id=signed-ints>Signed Integers</h3><p>As you saw in the previous section, all the protocol buffer types associated
with wire type 0 are encoded as varints. However, varints are unsigned, so the
different signed types, <code>sint32</code> and <code>sint64</code> vs <code>int32</code> or <code>int64</code>, encode
negative integers differently.</p><p>The <code>intN</code> types encode negative numbers as two&rsquo;s complement, which means that,
as unsigned, 64-bit integers, they have their highest bit set. As a result, this
means that <em>all ten bytes</em> must be used. For example, <code>-2</code> is converted by
protoscope into</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#0000cf;font-weight:700>11111110</span> <span style=color:#0000cf;font-weight:700>11111111</span> <span style=color:#0000cf;font-weight:700>11111111</span> <span style=color:#0000cf;font-weight:700>11111111</span> <span style=color:#0000cf;font-weight:700>11111111</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#0000cf;font-weight:700>11111111</span> <span style=color:#0000cf;font-weight:700>11111111</span> <span style=color:#0000cf;font-weight:700>11111111</span> <span style=color:#0000cf;font-weight:700>11111111</span> <span style=color:#0000cf;font-weight:700>00000001</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>This is the <em>two&rsquo;s complement</em> of 2, defined in unsigned arithmetic as <code>~0 - 2 + 1</code>, where <code>~0</code> is the all-ones 64-bit integer. It is a useful exercise to
understand why this produces so many ones.</p><p>On the other hand, <code>sintN</code> uses the &ldquo;ZigZag&rdquo; encoding instead of two&rsquo;s
complement to encode negative integers. Positive integers <code>n</code> are encoded as `2</p><ul><li>n<code>(the even numbers), while negative integers</code>-n<code>are encoded as</code>2 * n + 1`
(the odd numbers). The encoding thus &ldquo;zig-zags&rdquo; between positive and negative
numbers. For example:</li></ul><table><thead><tr><th>Signed Original</th><th>Encoded As</th></tr></thead><tbody><tr><td>0</td><td>0</td></tr><tr><td>-1</td><td>1</td></tr><tr><td>1</td><td>2</td></tr><tr><td>-2</td><td>3</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr><tr><td>0x7fffffff</td><td>0xfffffffe</td></tr><tr><td>-0x80000000</td><td>0xffffffff</td></tr></tbody></table><p>Using some bit tricks, it&rsquo;s cheap to convert <code>n</code> into its ZigZag representation:</p><pre tabindex=0><code>n + n + (n &lt; 0)
</code></pre><p>Here, we assume that the boolean <code>n &lt; 0</code> is converted into an integer 1 if true
or an integer 0 if false.</p><p>When the <code>sint32</code> or <code>sint64</code> is parsed, its value is decoded back to the
original, signed version.</p><p>In protoscope, suffixing an integer with a <code>z</code> will make it encode as ZigZag.
For example, <code>-500z</code> is the same as the varint <code>1001</code>.</p><h3 id=non-varint-numbers>Non-varint Numbers</h3><p>Non-varint numeric types are simple &ndash; <code>double</code> and <code>fixed64</code> have wire type
<code>I64</code>, which tells the parser to expect a fixed eight-byte lump of data. We can
specify a <code>double</code> record by writing <code>5: 25.4</code>, or a <code>fixed64</code> record with <code>6: 200i64</code>. In both cases, omitting an explicit wire type infers the <code>I64</code> wire
type.</p><p>Similarly <code>float</code> and <code>fixed32</code> have wire type <code>I32</code>, which tells it to expect
four bytes instead. The syntax for these consists of adding an <code>i32</code> prefix.
<code>25.4i32</code> will emit four bytes, as will <code>200i32</code>. Tag types are inferred as
<code>I32</code>.</p><h2 id=length-types>Length-Delimited Records</h2><p><em>Length prefixes</em> are another major concept in the wire format. The <code>LEN</code> wire
type has a dynamic length, specified by a varint immediately after the tag,
which is followed by the payload as usual.</p><p>Consider this message schema:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Test2</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>A record for the field <code>b</code> is a string, and strings are <code>LEN</code>-encoded. If we set
<code>b</code> to <code>"testing"</code>, we encoded as a <code>LEN</code> record with field number 2 containing
the ASCII string <code>"testing"</code>. The result is <code>`120774657374696e67`</code>. Breaking
up the bytes,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#0000cf;font-weight:700>12</span> <span style=color:#0000cf;font-weight:700>07</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>74</span> <span style=color:#0000cf;font-weight:700>65</span> <span style=color:#0000cf;font-weight:700>73</span> <span style=color:#0000cf;font-weight:700>74</span> <span style=color:#0000cf;font-weight:700>69</span> <span style=color:#0000cf;font-weight:700>6</span><span style=color:#000>e</span> <span style=color:#0000cf;font-weight:700>67</span><span style=color:#000;font-weight:700>]</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>we see that the tag, <code>`12`</code>, is <code>00010 010</code>, or <code>2:LEN</code>. The byte that
follows is the varint <code>7</code>, and the next seven bytes are the UTF-8 encoding of
<code>"testing"</code>.</p><p>In Protoscope, this is written as <code>2:LEN 7 "testing"</code>. However, it can be
incovenient to repeat the length of the string (which, in Protoscope text, is
already quote-delimited). Wrapping Protoscope content in braces will generate a
length prefix for it: <code>{"testing"}</code> is a shorthand for <code>7 "testing"</code>. <code>{}</code> is
always inferred by fields to be a <code>LEN</code> record, so we can write this record
simply as <code>2: {"testing"}</code>.</p><p><code>bytes</code> fields are encoded in the same way.</p><h3 id=embedded>Submessages</h3><p>Submessage fields also use the <code>LEN</code> wire type. Here&rsquo;s a message definition with
an embedded message of our original example message, <code>Test1</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Test3</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>Test1</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>If <code>Test1</code>&rsquo;s <code>a</code> field (i.e., <code>Test3</code>&rsquo;s <code>c.a</code> field) is set to 150, we get <code>``1a03089601``</code>. Breaking it up:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>a</span> <span style=color:#0000cf;font-weight:700>03</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>08</span> <span style=color:#0000cf;font-weight:700>96</span> <span style=color:#0000cf;font-weight:700>01</span><span style=color:#000;font-weight:700>]</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>The last three bytes (in <code>[]</code>) are exactly the same ones from our
<a href=#simple>very first example</a>. These bytes are preceded by a <code>LEN</code>-typed tag,
and a length of 3, exactly the same way as strings are encoded.</p><p>In Protoscope, submessages are quite succinct. <code>``1a03089601``</code> can be written
as <code>3: {1: 150}</code>.</p><h2 id=optional>Optional and Repeated Elements</h2><p>Missing <code>optional</code> fields are easy to encode: we just leave out the record if
it&rsquo;s not present. This means that &ldquo;huge&rdquo; protos with only a few fields set are
quite sparse.</p><p><code>repeated</code> fields are a bit more compicated. Ordinary (not <a href=#packed>packed</a>)
repeated fields emit one record for every element of the field. Thus, if we have</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Test4</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>and we construct a <code>Test4</code> message with <code>d</code> set to <code>"hello"</code>, and <code>e</code> set to
<code>1</code>, <code>2</code>, and <code>3</code>, this <em>could</em> be encoded as <code>`220568656c6c6f280128022803`</code>, or written out as Protoscope,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>However, records for <code>e</code> do not need to appear consecutively, and can be
interleaved with other fields; only the order of records for the same field with
respect to each other is preserved. Thus, this could also have been encoded as</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>There is no special treatment for <code>oneof</code>s in the wire format.</p><h3 id=last-one-wins>Last One Wins</h3><p>Normally, an encoded message would never have more than one instance of a
non-<code>repeated</code> field. However, parsers are expected to handle the case in which
they do. For numeric types and strings, if the same field appears multiple
times, the parser accepts the <em>last</em> value it sees. For embedded message fields,
the parser merges multiple instances of the same field, as if with the
<code>Message::MergeFrom</code> method &ndash; that is, all singular scalar fields in the latter
instance replace those in the former, singular embedded messages are merged, and
<code>repeated</code> fields are concatenated. The effect of these rules is that parsing
the concatenation of two encoded messages produces exactly the same result as if
you had parsed the two messages separately and merged the resulting objects.
That is, this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>MyMessage</span> <span style=color:#000>message</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ParseFromString</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>str1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>str2</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>is equivalent to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>MyMessage</span> <span style=color:#000>message</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>message2</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ParseFromString</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>str1</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>message2</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ParseFromString</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>str2</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MergeFrom</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>message2</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>This property is occasionally useful, as it allows you to merge two messages (by
concatenation) even if you do not know their types.</p><h3 id=packed>Packed Repeated Fields</h3><p>Starting in v2.1.0, <code>repeated</code> fields of scalar integer type can be declared as
&ldquo;packed&rdquo;. In proto2 this is done with the <code>[packed=true]</code>, but in proto3 it is
the default.</p><p>Instead of being encoded as one record per entry, they are encoded as a single
<code>LEN</code> record that contains each element concatenated. To decode, elements are
decoded from the <code>LEN</code> record one by one until the payload is exhausted. The
start of the next element is determined by the length of the previous, which
itself depends on the type of the field.</p><p>For example, imagine you have the message type:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Test5</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>packed</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Now let&rsquo;s say you construct a <code>Test5</code>, providing the values 3, 270, and 86942
for the repeated field <code>f</code>. Encoded, this gives us <code>`3206038e029ea705`</code>, or
as Protoscope text,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>3</span> <span style=color:#0000cf;font-weight:700>270</span> <span style=color:#0000cf;font-weight:700>86942</span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Only repeated fields of primitive numeric types (types) can be declared
&ldquo;packed&rdquo;. These are types that would normally use the <code>VARINT</code>, <code>I32</code>, or <code>I64</code>
wire types.</p><p>Note that although there&rsquo;s usually no reason to encode more than one key-value
pair for a packed repeated field, parsers must be prepared to accept multiple
key-value pairs. In this case, the payloads should be concatenated. Each pair
must contain a whole number of elements. The following is a valid encoding of
the same message above that parsers must accept:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>3</span> <span style=color:#0000cf;font-weight:700>270</span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>86942</span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Protocol buffer parsers must be able to parse repeated fields that were compiled
as <code>packed</code> as if they were not packed, and vice versa. This permits adding
<code>[packed=true]</code> to existing fields in a forward- and backward-compatible way.</p><h3 id=maps>Maps</h3><p>Map fields are just a shorthand for a special kind of repeated field. If we have</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Test6</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>map</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int32</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000>g</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>this is actually the same as</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Test6</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>g_Entry</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>g_Entry</span> <span style=color:#000>g</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Thus, maps are encoded exactly like a <code>repeated</code> message field: as a sequence of
<code>LEN</code>-typed records, with two fields each.</p><h2 id=groups>Groups</h2><p>Groups are a deprecated feature that should not be used, but they remain in the
wire format, and deserve a passing mention.</p><p>A group is a bit like a submessage, but it is delimited by special tags rather
than by a <code>LEN</code> prefix. Each group in a message has a field number, which is
used on these special tags.</p><p>A group with field number <code>8</code> begins with an <code>8:SGROUP</code> tag. <code>SGROUP</code> records
have empty payloads, so all this does is denote the start of the group. Once all
the fields in the group are listed, a corresponding <code>8:EGROUP</code> tag denotes its
end. <code>EGROUP</code> records also have no payload, so <code>8:EGROUP</code> is the entire record.
Group field numbers need to match up. If we encounter <code>7:EGROUP</code> where we expect
<code>8:EGROUP</code>, the message is mal-formed.</p><p>Protoscope provides a convenient syntax for writing groups. Instead of writing</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>SGROUP</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>EGROUP</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Protoscope allows</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#a40000>!</span><span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>This will generate the appropriate start and end group markers. The <code>!{}</code> syntax
can only occur immediately after an un-typed tag expression, like <code>8:</code>.</p><h2 id=order>Field Order</h2><p>Field numbers may be declared in any order in a <code>.proto</code> file. The order chosen
has no effect on how the messages are serialized.</p><p>When a message is serialized, there is no guaranteed order for how its known or
<a href=/programming-guides/proto#updating>unknown fields</a> will be written.
Serialization order is an implementation detail, and the details of any
particular implementation may change in the future. Therefore, protocol buffer
parsers must be able to parse fields in any order.</p><h3 id=implications>Implications</h3><ul><li>Do not assume the byte output of a serialized message is stable. This is
especially true for messages with transitive bytes fields representing other
serialized protocol buffer messages.</li><li>By default, repeated invocations of serialization methods on the same
protocol buffer message instance may not produce the same byte output. That
is, the default serialization is not deterministic.<ul><li>Deterministic serialization only guarantees the same byte output for a
particular binary. The byte output may change across different versions
of the binary.</li></ul></li><li>The following checks may fail for a protocol buffer message instance <code>foo</code>:<ul><li><code>foo.SerializeAsString() == foo.SerializeAsString()</code></li><li><code>Hash(foo.SerializeAsString()) == Hash(foo.SerializeAsString())</code></li><li><code>CRC(foo.SerializeAsString()) == CRC(foo.SerializeAsString())</code></li><li><code>FingerPrint(foo.SerializeAsString()) == FingerPrint(foo.SerializeAsString())</code></li></ul></li><li>Here are a few example scenarios where logically equivalent protocol buffer
messages <code>foo</code> and <code>bar</code> may serialize to different byte outputs:<ul><li><code>bar</code> is serialized by an old server that treats some fields as unknown.</li><li><code>bar</code> is serialized by a server that is implemented in a different
programming language and serializes fields in different order.</li><li><code>bar</code> has a field that serializes in a non-deterministic manner.</li><li><code>bar</code> has a field that stores a serialized byte output of a protocol
buffer message which is serialized differently.</li><li><code>bar</code> is serialized by a new server that serializes fields in a
different order due to an implementation change.</li><li><code>foo</code> and <code>bar</code> are concatenations of the same individual messages in a
different order.</li></ul></li></ul><h2 id=cheat-sheet>Condensed Reference Card</h2><p>The following provides the most prominent parts of the wire format in an
easy-to-reference format.</p><pre tabindex=0><code class=language-none data-lang=none>message    := (tag value)*

tag        := (field &lt;&lt; 3) bit-or wire_type;
                encoded as varint
value      := varint      for wire_type == VARINT,
              i32         for wire_type == I32,
              i64         for wire_type == I64,
              len-prefix  for wire_type == LEN,
              &lt;empty&gt;     for wire_type == SGROUP or EGROUP

varint     := int32 | int64 | uint32 | uint64 | bool | enum | sint32 | sint64;
                encoded as varints (sintN are ZigZag-encoded first)
i32        := sfixed32 | fixed32 | float;
                encoded as 4-byte little-endian;
                memcpy of the equivalent C types (u?int32_t, float)
i64        := sfixed64 | fixed64 | double;
                encoded as 8-byte little-endian;
                memcpy of the equivalent C types (u?int32_t, float)

len-prefix := size (message | string | bytes | packed);
                size encoded as varint
string     := valid UTF-8 string (e.g. ASCII);
                max 2GB of bytes
bytes      := any sequence of 8-bit bytes;
                max 2GB of bytes
packed     := varint* | i32* | i64*,
                consecutive values of the type specified in `.proto`
</code></pre><p>See also the
<a href=https://github.com/protocolbuffers/protoscope/blob/main/language.txt>Protoscope Language Reference</a>.</p><h3 id=cheat-sheet-key>Key</h3><dl><dt><code>message := (tag value)*</code></dt><dd>A message is encoded as a sequence of zero or more pairs of tags and values.</dd><dt><code>tag := (field &lt;&lt; 3) bit-or wire_type</code></dt><dd>A tag is a combination of a <code>wire_type</code>, stored in the least significant
three bits, and the field number that is defined in the <code>.proto</code> file.</dd><dt><code>value := varint for wire_type == VARINT, ...</code></dt><dd>A value is stored differently depending on the <code>wire_type</code> specified in the
tag.</dd><dt><code>varint := int32 | int64 | uint32 | uint64 | bool | enum | sint32 | sint64</code></dt><dd>You can use varint to store any of the listed data types.</dd><dt><code>i32 := sfixed32 | fixed32 | float</code></dt><dd>You can use fixed32 to store any of the listed data types.</dd><dt><code>i64 := sfixed64 | fixed64 | double</code></dt><dd>You can use fixed64 to store any of the listed data types.</dd><dt><code>len-prefix := size (message | string | bytes | packed)</code></dt><dd>A length-prefixed value is stored as a length (encoded as a varint), and
then one of the listed data types.</dd><dt><code>string := valid UTF-8 string (e.g. ASCII)</code></dt><dd>As described, a string must use UTF-8 character encoding. A string cannot
exceed 2GB.</dd><dt><code>bytes := any sequence of 8-bit bytes</code></dt><dd>As described, bytes can store custom data types, up to 2GB in size.</dd><dt><code>packed := varint* | i32* | i64*</code></dt><dd>Use the <code>packed</code> data type when you are storing consecutive values of the
type described in the protocol definition. The tag is dropped for values
after the first, which amortizes the costs of tags to one per field, rather
than per element.</dd></dl></div><div class=td-content style=page-break-before:always><h1 id=pg-fa336b657b9e453f981ed82e9bb9c74d>5 - Techniques</h1><div class=lead>This topic describes some commonly-used design patterns for dealing with Protocol Buffers.</div><p>This page describes some commonly-used design patterns for dealing with Protocol
Buffers. You can also send design and usage questions to the
<a href=http://groups.google.com/group/protobuf>Protocol Buffers discussion group</a>.</p><h2 id=streaming>Streaming Multiple Messages</h2><p>If you want to write multiple messages to a single file or stream, it is up to
you to keep track of where one message ends and the next begins. The Protocol
Buffer wire format is not self-delimiting, so protocol buffer parsers cannot
determine where a message ends on their own. The easiest way to solve this
problem is to write the size of each message before you write the message
itself. When you read the messages back in, you read the size, then read the
bytes into a separate buffer, then parse from that buffer. (If you want to avoid
copying bytes to a separate buffer, check out the <code>CodedInputStream</code> class (in
both C++ and Java) which can be told to limit reads to a certain number of
bytes.)</p><h2 id=large-data>Large Data Sets</h2><p>Protocol Buffers are not designed to handle large messages. As a general rule of
thumb, if you are dealing in messages larger than a megabyte each, it may be
time to consider an alternate strategy.</p><p>That said, Protocol Buffers are great for handling individual messages <em>within</em>
a large data set. Usually, large data sets are a collection of small pieces,
where each small piece is structured data. Even though Protocol Buffers cannot
handle the entire set at once, using Protocol Buffers to encode each piece
greatly simplifies your problem: now all you need is to handle a set of byte
strings rather than a set of structures.</p><p>Protocol Buffers do not include any built-in support for large data sets because
different situations call for different solutions. Sometimes a simple list of
records will do while other times you want something more like a database. Each
solution should be developed as a separate library, so that only those who need
it need pay the costs.</p><h2 id=self-description>Self-describing Messages</h2><p>Protocol Buffers do not contain descriptions of their own types. Thus, given
only a raw message without the corresponding <code>.proto</code> file defining its type, it
is difficult to extract any useful data.</p><p>However, the contents of a .proto file can itself be represented using protocol
buffers. The file <code>src/google/protobuf/descriptor.proto</code> in the source code
package defines the message types involved. <code>protoc</code> can output a
<code>FileDescriptorSet</code>—which represents a set of .proto files—using the
<code>--descriptor_set_out</code> option. With this, you can define a self-describing
protocol message like so:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#000>syntax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;proto3&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;google/protobuf/any.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;google/protobuf/descriptor.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>SelfDescribingMessage</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Set of FileDescriptorProtos which describe the type and its dependencies.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>google.protobuf.FileDescriptorSet</span> <span style=color:#000>descriptor_set</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// The message and its type, encoded as an Any message.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>google.protobuf.Any</span> <span style=color:#204a87;font-weight:700>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>By using classes like <code>DynamicMessage</code> (available in C++ and Java), you can then
write tools which can manipulate <code>SelfDescribingMessage</code>s.</p><p>All that said, the reason that this functionality is not included in the
Protocol Buffer library is because we have never had a use for it inside Google.</p><p>This technique requires support for dynamic messages using descriptors. Check
that your platforms support this feature before using self-describing messages.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-38218c06f0c50d02df79bc8a0d2f405c>6 - Third-party Add-ons</h1><div class=lead>This topic links out to many open source projects that seek to add useful functionality on top of Protocol Buffers.</div><p>Many open source projects seek to add useful functionality on top of Protocol
Buffers. For a list of links to projects we know about, see the
<a href=https://github.com/protocolbuffers/protobuf/blob/master/docs/third_party.md>third-party add-ons wiki page</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-43407619ac03371a42554d0fa219232f>7 - Application Note: Field Presence</h1><div class=lead>This topic explains the various presence-tracking disciplines for protobuf fields. It also explains the behavior of explicit presence-tracking for singular proto3 fields with basic types.</div><p>This application note explains the various presence tracking disciplines for
protobuf fields. It also explains the behaviour of explicit presence tracking
for singular proto3 fields with basic types.</p><h2 id=background>Background</h2><p><em>Field presence</em> is the notion of whether a protobuf field has a value. There
are two different manifestations of presence for protobufs: <em>no presence</em>, where
the generated message API stores field values (only), and <em>explicit presence</em>,
where the API also stores whether or not a field has been set.</p><p>Historically, proto2 has mostly followed <em>explicit presence</em>, while proto3
exposes only <em>no presence</em> semantics. Singular proto3 fields of basic types
(numeric, string, bytes, and enums) which are defined with the <code>optional</code> label
have <em>explicit presence</em>, like proto2 (this feature is enabled by default as
release 3.15).</p><h3 id=presence-disciplines>Presence Disciplines</h3><p><em>Presence disciplines</em> define the semantics for translating between the <em>API
representation</em> and the <em>serialized representation</em>. The <em>no presence</em>
discipline relies upon the field value itself to make decisions at
(de)serialization time, while the <em>explicit presence</em> discipline relies upon the
explicit tracking state instead.</p><h3 id=presence-in-tag-value-stream-wire-format-serialization>Presence in <em>Tag-value stream</em> (Wire Format) Serialization</h3><p>The wire format is a stream of tagged, <em>self-delimiting</em> values. By definition,
the wire format represents a sequence of <em>present</em> values. In other words, every
value found within a serialization represents a <em>present</em> field; furthermore,
the serialization contains no information about not-present values.</p><p>The generated API for a proto message includes (de)serialization definitions
which translate between API types and a stream of definitionally <em>present</em> (tag,
value) pairs. This translation is designed to be forward- and
backward-compatibile across changes to the message definition; however, this
compatibility introduces some (perhaps surprising) considerations when
deserializing wire-formatted messages:</p><ul><li>When serializing, fields with <em>no presence</em> are not serialized if they
contain their default value.<ul><li>For numeric types, the default is 0.</li><li>For enums, the default is the zero-valued enumerator.</li><li>For strings, bytes, and repeated fields, the default is the zero-length
value.</li><li>For messages, the default is the language-specific null value.</li></ul></li><li>&ldquo;Empty&rdquo; length-delimited values (such as empty strings) can be validly
represented in serialized values: the field is &ldquo;present,&rdquo; in the sense that
it appears in the wire format. However, if the generated API does not track
presence, then these values may not be re-serialized; i.e., the empty field
may be &ldquo;not present&rdquo; after a serialization round-trip.</li><li>When deserializing, duplicate field values may be handled in different ways
depending on the field definition.<ul><li>Duplicate <code>repeated</code> fields are typically appended to the field&rsquo;s API
representation. (Note that serializing a <em>packed</em> repeated field
produces only one, length-delimited value in the tag stream.)</li><li>Duplicate <code>optional</code> field values follow the rule that &ldquo;the last one
wins.&rdquo;</li></ul></li><li><code>oneof</code> fields expose the API-level invariant that only one field is set at
a time. However, the wire format may include multiple (tag, value) pairs
which notionally belong to the <code>oneof</code>. Similar to <code>optional</code> fields, the
generated API follows the &ldquo;last one wins&rdquo; rule.</li><li>Out-of-range values are not returned for enum fields in generated proto2
APIs. However, out-of-range values may be stored as <em>unknown fields</em> in the
API, even though the wire-format tag was recognized.</li></ul><h3 id=presence-in-named-field-mapping-formats>Presence in <em>Named-field Mapping</em> Formats</h3><p>Protobufs can be represented in human-readable, textual forms. Two notable
formats are TextFormat (the output format produced by generated message
<code>DebugString</code> methods) and JSON.</p><p>These formats have correctness requirements of their own, and are generally
stricter than <em>tagged-value stream</em> formats. However, TextFormat more closely
mimics the semantics of the wire format, and does, in certain cases, provide
similar semantics (for example, appending repeated name-value mappings to a
repeated field). In particular, similar to the wire format, TextFormat only
includes fields which are present.</p><p>JSON is a much stricter format, however, and cannot validly represent some
semantics of the wire format or TextFormat.</p><ul><li>Notably, JSON <em>elements</em> are semantically unordered, and each member must
have a unique name. This is different from TextFormat rules for repeated
fields.</li><li>JSON may include fields that are &ldquo;not present,&rdquo; unlike the <em>no presence</em>
discipline for other formats:<ul><li>JSON defines a <code>null</code> value, which may be used to represent a <em>defined
but not-present field</em>.</li><li>Repeated field values may be included in the formatted output, even if
they are equal to the default (an empty list).</li></ul></li><li>Because JSON elements are unordered, there is no way to unambiguously
interpret the &ldquo;last one wins&rdquo; rule.<ul><li>In most cases, this is fine: JSON elements must have unique names:
repeated field values are not valid JSON, so they do not need to be
resolved as they are for TextFormat.</li><li>However, this means that it may not be possible to interpret <code>oneof</code>
fields unambiguously: if multiple cases are present, they are unordered.</li></ul></li></ul><p>In theory, JSON <em>can</em> represent presence in a semantic-preserving fashion. In
practice, however, presence correctness can vary depending upon implementation
choices, especially if JSON was chosen as a means to interoperate with clients
not using protobufs.</p><h3 id=presence-in-proto2-apis>Presence in Proto2 APIs</h3><p>This table outlines whether presence is tracked for fields in proto2 APIs (both
for generated APIs and using dynamic reflection):</p><table><thead><tr><th>Field type</th><th>Explicit Presence</th></tr></thead><tbody><tr><td>Singular numeric (integer or floating point)</td><td>✔️</td></tr><tr><td>Singular enum</td><td>✔️</td></tr><tr><td>Singular string or bytes</td><td>✔️</td></tr><tr><td>Singular message</td><td>✔️</td></tr><tr><td>Repeated</td><td></td></tr><tr><td>Oneofs</td><td>✔️</td></tr><tr><td>Maps</td><td></td></tr></tbody></table><p>Singular fields (of all types) track presence explicitly in the generated API.
The generated message interface includes methods to query presence of fields.
For example, the field <code>foo</code> has a corresponding <code>has_foo</code> method. (The specific
name follows the same language-specific naming convention as the field
accessors.) These methods are sometimes referred to as &ldquo;hazzers&rdquo; within the
protobuf implementation.</p><p>Similar to singular fields, <code>oneof</code> fields explicitly track which one of the
members, if any, contains a value. For example, consider this example <code>oneof</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#204a87;font-weight:700>oneof</span> <span style=color:#000>foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Depending on the target language, the generated API would generally include
several methods:</p><ul><li>A hazzer for the oneof: <code>has_foo</code></li><li>A <em>oneof case</em> method: <code>foo</code></li><li>Hazzers for the members: <code>has_a</code>, <code>has_b</code></li><li>Getters for the members: <code>a</code>, <code>b</code></li></ul><p>Repeated fields and maps do not track presence: there is no distinction between
an <em>empty</em> and a <em>not-present</em> repeated field.</p><h3 id=presence-in-proto3-apis>Presence in Proto3 APIs</h3><p>This table outlines whether presence is tracked for fields in proto3 APIs (both
for generated APIs and using dynamic reflection):</p><table><thead><tr><th>Field type</th><th><code>optional</code></th><th>Explicit Presence</th></tr></thead><tbody><tr><td>Singular numeric (integer or floating point)</td><td>No</td><td></td></tr><tr><td>Singular enum</td><td>No</td><td></td></tr><tr><td>Singular string or bytes</td><td>No</td><td></td></tr><tr><td>Singular numeric (integer or floating point)</td><td>Yes</td><td>✔️</td></tr><tr><td>Singular enum</td><td>Yes</td><td>✔️</td></tr><tr><td>Singular string or bytes</td><td>Yes</td><td>✔️</td></tr><tr><td>Singular message</td><td>Yes</td><td>✔️</td></tr><tr><td>Singular message</td><td>No</td><td>✔️</td></tr><tr><td>Repeated</td><td>N/A</td><td></td></tr><tr><td>Oneofs</td><td>N/A</td><td>✔️</td></tr><tr><td>Maps</td><td>N/A</td><td></td></tr></tbody></table><p>Similar to proto2 APIs, proto3 does not track presence explicitly for repeated
fields. Without the <code>optional</code> label, proto3 APIs do not track presence for
basic types (numeric, string, bytes, and enums), either. Oneof fields
affirmatively expose presence, although the same set of hazzer methods may not
generated as in proto2 APIs.</p><p>Under the <em>no presence</em> discipline, the default value is synonymous with &ldquo;not
present&rdquo; for purposes of serialization. To notionally &ldquo;clear&rdquo; a field (so it
won&rsquo;t be serialized), an API user would set it to the default value.</p><p>The default value for enum-typed fields under <em>no presence</em> is the corresponding
0-valued enumerator. Under proto3 syntax rules, all enum types are required to
have an enumerator value which maps to 0. By convention, this is an <code>UNKNOWN</code> or
similarly-named enumerator. If the zero value is notionally outside the domain
of valid values for the application, this behavior can be thought of as
tantamount to <em>explicit presence</em>.</p><h2 id=semantic-differences>Semantic Differences</h2><p>The <em>no presence</em> serialization discipline results in visible differences from
the <em>explicit presence</em> tracking discipline, when the default value is set. For
a singular field with numeric, enum, or string type:</p><ul><li><em>No presence</em> discipline:<ul><li>Default values are not serialized.</li><li>Default values are <em>not</em> merged-from.</li><li>To &ldquo;clear&rdquo; a field, it is set to its default value.</li><li>The default value may mean:<ul><li>the field was explicitly set to its default value, which is valid in
the application-specific domain of values;</li><li>the field was notionally &ldquo;cleared&rdquo; by setting its default; or</li><li>the field was never set.</li></ul></li></ul></li><li><em>Explicit presence</em> discipline:<ul><li>Explicitly set values are always serialized, including default values.</li><li>Un-set fields are never merged-from.</li><li>Explicitly set fields &ndash; including default values &ndash; <em>are</em> merged-from.</li><li>A generated <code>has_foo</code> method indicates whether or not the field <code>foo</code>
has been set (and not cleared).</li><li>A generated <code>clear_foo</code> method must be used to clear (i.e., un-set) the
value.</li></ul></li></ul><h3 id=considerations-for-merging>Considerations for Merging</h3><p>Under the <em>no presence</em> rules, it is effectively impossible for a target field
to merge-from its default value (using the protobuf&rsquo;s API merging functions).
This is because default values are skipped, similar to the <em>no presence</em>
serialization discipline. Merging only updates the target (merged-to) message
using the non-skipped values from the update (merged-from) message.</p><p>The difference in merging behavior has further implications for protocols which
rely on partial &ldquo;patch&rdquo; updates. If field presence is not tracked, then an
update patch alone cannot represent an update to the default value, because only
non-default values are merged-from.</p><p>Updating to set a default value in this case requires some external mechanism,
such as <code>FieldMask</code>. However, if presence <em>is</em> tracked, then all explicitly-set
values &ndash; even default values &ndash; will be merged into the target.</p><h3 id=considerations-for-change-compatibility>Considerations for change-compatibility</h3><p>Changing a field between <em>explicit presence</em> and <em>no presence</em> is a
binary-compatible change for serialized values in wire format. However, the
serialized representation of the message may differ, depending on which version
of the message definition was used for serialization. Specifically, when a
&ldquo;sender&rdquo; explicitly sets a field to its default value:</p><ul><li>The serialized value following <em>no presence</em> discipline does not contain the
default value, even though it was explicitly set.</li><li>The serialized value following <em>explicit presence</em> discipline contains every
&ldquo;present&rdquo; field, even if it contains the default value.</li></ul><p>This change may or may not be safe, depending on the application&rsquo;s semantics.
For example, consider two clients with different versions of a message
definition.</p><p>Client A uses this definition of the message, which follows the <em>explicit
presence</em> serialization discipline for field <code>foo</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#000>syntax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;proto3&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Msg</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Client B uses a definition of the same message, except that it follows the <em>no
presence</em> discipline:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#000>syntax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;proto3&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Msg</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Now, consider a scenario where client A observes <code>foo</code>&rsquo;s presence as the clients
repeatedly exchange the &ldquo;same&rdquo; message by deserializing and reserializing:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Client A:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Msg</span> <span style=color:#000>m_a</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000>m_a.set_foo</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>                  <span style=color:#8f5902;font-style:italic>// non-default value
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>assert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>m_a.has_foo</span><span style=color:#000;font-weight:700>());</span>           <span style=color:#8f5902;font-style:italic>// OK
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Send</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>m_a.SerializeAsString</span><span style=color:#000;font-weight:700>());</span>   <span style=color:#8f5902;font-style:italic>// to client B
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Client B:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Msg</span> <span style=color:#000>m_b</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000>m_b.ParseFromString</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Receive</span><span style=color:#000;font-weight:700>());</span>  <span style=color:#8f5902;font-style:italic>// from client A
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>assert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>m_b.foo</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>          <span style=color:#8f5902;font-style:italic>// OK
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Send</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>m_b.SerializeAsString</span><span style=color:#000;font-weight:700>());</span>   <span style=color:#8f5902;font-style:italic>// to client A
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Client A:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>m_a.ParseFromString</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Receive</span><span style=color:#000;font-weight:700>());</span>  <span style=color:#8f5902;font-style:italic>// from client B
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>assert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>m_a.foo</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>          <span style=color:#8f5902;font-style:italic>// OK
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>assert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>m_a.has_foo</span><span style=color:#000;font-weight:700>());</span>           <span style=color:#8f5902;font-style:italic>// OK
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>m_a.set_foo</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>);</span>                  <span style=color:#8f5902;font-style:italic>// default value
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Send</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>m_a.SerializeAsString</span><span style=color:#000;font-weight:700>());</span>   <span style=color:#8f5902;font-style:italic>// to client B
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Client B:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Msg</span> <span style=color:#000>m_b</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000>m_b.ParseFromString</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Receive</span><span style=color:#000;font-weight:700>());</span>  <span style=color:#8f5902;font-style:italic>// from client A
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>assert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>m_b.foo</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>);</span>          <span style=color:#8f5902;font-style:italic>// OK
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Send</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>m_b.SerializeAsString</span><span style=color:#000;font-weight:700>());</span>   <span style=color:#8f5902;font-style:italic>// to client A
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Client A:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>m_a.ParseFromString</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Receive</span><span style=color:#000;font-weight:700>());</span>  <span style=color:#8f5902;font-style:italic>// from client B
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>assert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>m_a.foo</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>);</span>          <span style=color:#8f5902;font-style:italic>// OK
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>assert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>m_a.has_foo</span><span style=color:#000;font-weight:700>());</span>           <span style=color:#8f5902;font-style:italic>// FAIL
</span></span></span></code></pre></div><p>If client A depends on <em>explicit presence</em> for <code>foo</code>, then a &ldquo;round trip&rdquo;
through client B will be lossy from the perspective of client A. In the example,
this is not a safe change: client A requires (by <code>assert</code>) that the field is
present; even without any modifications through the API, that requirement fails
in a value- and peer-dependent case.</p><h2 id=how-to-enable-explicit-presence-in-proto3>How to Enable <em>Explicit Presence</em> in Proto3</h2><p>These are the general steps to use field tracking support for proto3:</p><ol><li>Add an <code>optional</code> field to a <code>.proto</code> file.</li><li>Run <code>protoc</code> (at least v3.15, or v3.12 using
<code>--experimental_allow_proto3_optional</code> flag).</li><li>Use the generated &ldquo;hazzer&rdquo; methods and &ldquo;clear&rdquo; methods in application code,
instead of comparing or setting default values.</li></ol><h3 id=proto-file-changes><code>.proto</code> File Changes</h3><p>This is an example of a proto3 message with fields which follow both <em>no
presence</em> and <em>explicit presence</em> semantics:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#000>syntax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;proto3&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>example</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>MyMessage</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// No presence:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>not_tracked</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Explicit presence:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>tracked</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h3 id=protoc-invocation><code>protoc</code> Invocation</h3><p>Presence tracking for proto3 messages is enabled by default
<a href=https://github.com/protocolbuffers/protobuf/releases/tag/v3.15.0>since v3.15.0</a>
release, formerly up until
<a href=https://github.com/protocolbuffers/protobuf/releases/tag/v3.12.0>v3.12.0</a> the
<code>--experimental_allow_proto3_optional</code> flag was required when using presence
tracking with protoc.</p><h3 id=using-the-generated-code>Using the Generated Code</h3><p>The generated code for proto3 fields with <em>explicit presence</em> (the <code>optional</code>
label) will be the same as it would be in a proto2 file.</p><p>This is the definition used in the &ldquo;no presence&rdquo; examples below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#000>syntax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;proto3&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>example</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Msg</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>This is the definition used in the &ldquo;explicit presence&rdquo; examples below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#000>syntax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;proto3&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>example</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Msg</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>In the examples, a function <code>GetProto</code> constructs and returns a message of type
<code>Msg</code> with unspecified contents.</p><h4 id=c-example>C++ Example</h4><p>No presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>Msg</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetProto</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>foo</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// &#34;Clear&#34; the field:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_foo</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Default value: field may not have been present.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_foo</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Explicit presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>Msg</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetProto</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>has_foo</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Clear the field:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clear_foo</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Field is not present, so set it.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_foo</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=c-example-1>C# Example</h4><p>No presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c# data-lang=c#><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>m</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>GetProto</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// &#34;Clear&#34; the field:</span>
</span></span><span style=display:flex><span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Default value: field may not have been present.</span>
</span></span><span style=display:flex><span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Explicit presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c# data-lang=c#><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>m</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>GetProto</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HasFoo</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Clear the field:</span>
</span></span><span style=display:flex><span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClearFoo</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Field is not present, so set it.</span>
</span></span><span style=display:flex><span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=go-example>Go Example</h4><p>No presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>GetProto</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Foo</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// &#34;Clear&#34; the field:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Default value: field may not have been present.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Explicit presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>GetProto</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Foo</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Clear the field:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Field is not present, so set it.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>proto</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Int32</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=java-example>Java Example</h4><p>These examples use a <code>Builder</code> to demonstrate clearing. Simply checking presence
and getting values from a <code>Builder</code> follows the same API as the message type.</p><p>No presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>Msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetProto</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFoo</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// &#34;Clear&#34; the field:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFoo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Default value: field may not have been present.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFoo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Explicit presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>Msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetProto</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasFoo</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Clear the field:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearFoo</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Field is not present, so set it.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFoo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=python-example>Python Example</h4><p>No presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Msg</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># &#34;Clear&#34; the field:</span>
</span></span><span style=display:flex><span>  <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>else</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Default value: field may not have been present.</span>
</span></span><span style=display:flex><span>  <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span></code></pre></div><p>Explicit presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Msg</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>HasField</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;foo&#39;</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Clear the field:</span>
</span></span><span style=display:flex><span>  <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ClearField</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;foo&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>else</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Field is not present, so set it.</span>
</span></span><span style=display:flex><span>  <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span></code></pre></div><h4 id=ruby-example>Ruby Example</h4><p>No presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>new</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># &#34;Clear&#34; the field:</span>
</span></span><span style=display:flex><span>  <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Default value: field may not have been present.</span>
</span></span><span style=display:flex><span>  <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>end</span>
</span></span></code></pre></div><p>Explicit presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>new</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>has_foo?</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Clear the field:</span>
</span></span><span style=display:flex><span>  <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>clear_foo</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Field is not present, so set it.</span>
</span></span><span style=display:flex><span>  <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>end</span>
</span></span></code></pre></div><h4 id=javascript-example>Javascript Example</h4><p>No presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Msg</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getFoo</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// &#34;Clear&#34; the field:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setFoo</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Default value: field may not have been present.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setFoo</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Explicit presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Msg</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>hasFoo</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Clear the field:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clearFoo</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Field is not present, so set it.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setFoo</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=objective-c-example>Objective C Example</h4><p>No presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objective-c data-lang=objective-c><span style=display:flex><span><span style=color:#000>Msg</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[[</span><span style=color:#000>Msg</span> <span style=color:#000>alloc</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>init</span><span style=color:#000;font-weight:700>];</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// &#34;Clear&#34; the field:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Default value: field may not have been present.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Explicit presence:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objective-c data-lang=objective-c><span style=display:flex><span><span style=color:#000>Msg</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[[</span><span style=color:#000>Msg</span> <span style=color:#000>alloc</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>init</span><span style=color:#000;font-weight:700>];</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>hasFoo</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Clear the field:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000;font-weight:700>[</span><span style=color:#000>m</span> <span style=color:#000>clearFoo</span><span style=color:#000;font-weight:700>];</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Field is not present, so set it.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000;font-weight:700>[</span><span style=color:#000>m</span> <span style=color:#f57900>setFoo</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>];</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-87a56dbd37aef4111f82cb234bba8f3f>8 - Proto Best Practices</h1><div class=lead>This topic contains vetted best practices for authoring Protocol Buffers.</div><p>Clients and servers are never updated at exactly the same time - even when you
try to update them at the same time. One or the
other may get rolled back. Don’t assume that you can make a breaking change and
it&rsquo;ll be okay because the client and server are in sync.</p><h2 id=dont-re-use-a-tag-number><strong>Don&rsquo;t</strong> Re-use a Tag Number</h2><p>Never re-use a tag number. It messes up deserialization. Even if you think no
one is using the field, don’t re-use a tag number. If the change was live ever,
there could be serialized versions of your proto in a log
somewhere. Or there could be old code in another server that will break.</p><h2 id=dont-change-the-type-of-a-field><strong>Don&rsquo;t</strong> Change the Type of a Field</h2><p>Almost never change the type of a field; it&rsquo;ll mess up deserialization, same as
re-using a tag number. The
<a href=/programming-guides/proto#updating>protobuf docs</a>
outline a small number of cases that are okay (for example, going between
<code>int32</code>, <code>uint32</code>, <code>int64</code> and <code>bool</code>). However, you’re guaranteed to break if
you change a field’s message type (for example, going from a <code>Foo</code> message to a
<code>Bar</code> message).</p><h2 id=dont-add-a-required-field><strong>Don&rsquo;t</strong> Add a Required Field</h2><p>Never add a required field, instead add <code>// required</code> to document the API
contract. Required fields are considered harmful by so many they were
removed from proto3 completely. Make all fields
optional or repeated. You never know how long a message type is going to last
and whether someone will be forced to fill in your required field with an empty
string or zero in four years when it’s no longer logically required but the
proto still says it is.</p><h2 id=dont-make-a-message-with-lots-of-fields><strong>Don&rsquo;t</strong> Make a Message with Lots of Fields</h2><p>Don&rsquo;t make a message with “lots” (think: hundreds) of fields. In C++ every field
adds roughly 65 bits to the in-memory object size whether it’s populated or not
(8 bytes for the pointer and, if the field is declared as optional, another bit
in a bitfield that keeps track of whether the field is set). When your proto
grows too large, the generated code may not even compile (for example, in Java
there is a hard limit on the size of a method
).</p><h2 id=do-include-an-unspecified-value-in-an-enum><strong>Do</strong> Include an Unspecified Value in an Enum</h2><p>Enums should include a default <code>FOO_UNSPECIFIED</code> value as the first value in the
declaration . When new values
are added to a proto2 enum, old clients will see the field as unset and the
getter will return the default value or the first-declared value if no default
exists . For consistent behavior with <a href=/programming-guides/proto#enum>proto enums</a>,
the first declared enum value should be a default <code>FOO_UNSPECIFIED</code> value and
should use tag 0. It may be tempting to declare this default as a semantically
meaningful value but as a general rule, do not, to aid in the evolution of your
protocol as new enum values are added over time. All enum values declared under
a container message are in the same C++ namespace, so prefix the unspecified
value with the enum’s name to avoid compilation errors. If you&rsquo;ll never need
cross-language constants, an <code>int32</code> will preserve unknown values and generates
less code. Note that <a href=/programming-guides/proto#enum>proto enums</a> require the first value to be
zero and can round-trip (deserialize, serialize) an unknown enum value.</p><h2 id=do-use-well-known-types-and-common-types><strong>Do</strong> Use Well-Known Types and Common Types</h2><p>Embedding the following common, shared types is strongly encouraged. Do not use
<code>int32 timestamp_seconds_since_epoch</code> or <code>int64 timeout_millis</code> in your code
when a perfectly suitable common type already exists!</p><h3 id=well-known-types>Well-Known Types:</h3><ul><li><a href=https://github.com/protocolbuffers/protobuf/blob/main/src/google/protobuf/duration.proto>duration</a>
is a signed, fixed-length span of time (for example, 42s).</li><li><a href=https://github.com/protocolbuffers/protobuf/blob/main/src/google/protobuf/timestamp.proto>timestamp</a>
is a point in time independent of any time zone or calendar (for example,
2017-01-15T01:30:15.01Z).</li><li><a href=https://github.com/protocolbuffers/protobuf/blob/main/src/google/protobuf/field_mask.proto>field_mask</a>
is a set of symbolic field paths (for example, f.b.d).</li></ul><h3 id=common-types>Common Types:</h3><ul><li><a href=https://github.com/googleapis/googleapis/blob/master/google/type/interval.proto>interval</a>
is a time interval independent of time zone or calendar (for example,
2017-01-15T01:30:15.01Z - 2017-01-16T02:30:15.01Z).</li><li><a href=https://github.com/googleapis/googleapis/blob/master/google/type/date.proto>date</a>
is a whole calendar date (for example, 2005-09-19).</li><li><a href=https://github.com/googleapis/googleapis/blob/master/google/type/dayofweek.proto>dayofweek</a>
is a day of week (for example, Monday).</li><li><a href=https://github.com/googleapis/googleapis/blob/master/google/type/timeofday.proto>timeofday</a>
is a time of day (for example, 10:42:23).</li><li><a href=https://github.com/googleapis/googleapis/blob/master/google/type/latlng.proto>latlng</a>
is a latitude/longitude pair (for example, 37.386051 latitude and
-122.083855 longitude).</li><li><a href=https://github.com/googleapis/googleapis/blob/master/google/type/money.proto>money</a>
is an amount of money with its currency type (for example, 42 USD).</li><li><a href=https://github.com/googleapis/googleapis/blob/master/google/type/postal_address.proto>postal_address</a>
is a postal address (for example, 1600 Amphitheatre Parkway Mountain View,
CA 94043 USA).</li><li><a href=https://github.com/googleapis/googleapis/blob/master/google/type/color.proto>color</a>
is a color in the RGBA color space.</li><li><a href=https://github.com/googleapis/googleapis/blob/master/google/type/month.proto>month</a>
is a month of year (for example, April).</li></ul><h2 id=do-define-widely-used-message-types-in-separate-files><strong>Do</strong> Define Widely-used Message Types in Separate Files</h2><p>If you&rsquo;re defining message types or enums that you hope/fear/expect to be widely
used outside your immediate team, consider putting them in their own file with
no dependencies. Then it&rsquo;s easy for anyone to use those types without
introducing the transitive dependencies in your other proto files.</p><h2 id=do-reserve-tag-numbers-for-deleted-fields><strong>Do</strong> Reserve Tag Numbers for Deleted Fields</h2><p>When you delete a field that&rsquo;s no longer used, reserve its tag number so that no
one accidentally re-uses it in the future. Just <code>reserved 2, 3;</code> is enough. No
type required (lets you trim dependencies!). You can also reserve names to avoid
recycling now-deleted field names: <code>reserved "foo", "bar";</code>.</p><h2 id=do-reserve-numbers-for-deleted-enum-values><strong>Do</strong> Reserve Numbers for Deleted Enum Values</h2><p>When you delete an enum value that&rsquo;s no longer used, reserve its number so that
no one accidentally re-uses it in the future. Just <code>reserved 2, 3;</code> is enough.
You can also reserve names to avoid recycling now-deleted value names: <code>reserved "FOO", "BAR";</code>.</p><h2 id=dont-change-the-default-value-of-a-field><strong>Don&rsquo;t</strong> Change the Default Value of a Field</h2><p>Almost never change the default value of a proto field. This causes version skew
between clients and servers. A client reading an unset value will see a
different result than a server reading the same unset value when their builds
straddle the proto change. Proto3 removed the ability to
set default values.</p><h2 id=dont-go-from-repeated-to-scalar><strong>Don&rsquo;t</strong> Go from Repeated to Scalar</h2><p>Although it won&rsquo;t cause crashes, you&rsquo;ll lose data. For JSON, a mismatch in
repeatedness will lose the whole <em>message</em>. For numeric proto3 fields and proto2
<code>packed</code> fields, going from repeated to scalar will lose all data in that
<em>field</em>. For non-numeric proto3 fields and un-annotated proto2 fields, going
from repeated to scalar will result in the last deserialized value &ldquo;winning.&rdquo;</p><p>Going from scalar to repeated is OK in proto2 and in proto3 with
<code>[packed=false]</code> because for binary serialization the scalar value becomes a
one-element list .</p><h2 id=always-create-a-build-rule-for-your-proto-files><strong>Always</strong> Create a Build Rule for Your Proto Files</h2><p>If your proto is only used by a script that doesn&rsquo;t require a build rule, create
a <code>proto_library</code> rule with an associated
<code>build_test</code> rule.</p><p>With a <code>build_test</code> rule, errors in the file are caught when the test fails.
Otherwise, typos and errors can persist and lead to hard-to-diagnose
problems. Adding this <code>build_test</code> to
your build script is also highly recommended, so you
can be notified of future breakages.</p><h2 id=do-follow-the-style-guide-for-generated-code><strong>Do</strong> Follow the Style Guide for Generated Code</h2><p>Proto generated code is referred to in normal code. Ensure that options in
<code>.proto</code> file do not result in generation of code which violate the style guide.
For example:</p><ul><li><code>java_outer_classname</code> should follow
<a href=https://google.github.io/styleguide/javaguide.html#s5.2.2-class-names>https://google.github.io/styleguide/javaguide.html#s5.2.2-class-names</a></li><li><code>java_package</code> and <code>java_alt_package</code> should follow
<a href=https://google.github.io/styleguide/javaguide.html#s5.2.1-package-names>https://google.github.io/styleguide/javaguide.html#s5.2.1-package-names</a></li></ul><h2 id=never-use-text-format-messages-for-interchange><strong>Never</strong> Use Text-format Messages for Interchange</h2><p>Deserializing of text-format protocol buffers will fail when the binary is
unaware of a field rename, a new field, or a new extension. In general,
text-format is not future proof. Use text-format for human editing and debugging
only.</p><h2 id=never-rely-on-serialization-stability-across-builds><strong>Never</strong> Rely on Serialization Stability Across Builds</h2><p>The stability of proto serialization is not guaranteed across binaries or across
builds of the same binary. Do not rely on it when, for example, building cache
keys.</p><h2 id=dont-generate-java-protos-in-the-same-java-package-as-other-code><strong>Don&rsquo;t</strong> Generate Java Protos in the Same Java Package as Other Code</h2><p>Generate Java proto sources into a separate package from your hand-written Java
sources. The <code>package</code>, <code>java_package</code> and <code>java_alt_api_package</code> options
control
<a href=/reference/java/java-generated#package>where the generated Java sources are emitted</a>.
Make sure hand-written Java source code does not also live in that same package.
A common practice is to generate your protos into a <code>proto</code> subpackage in your
project that <strong>only</strong> contains those protos (that is, no hand-written source
code).</p><h2 id=appendix>Appendix</h2><h3 id=api-best-practices>API Best Practices</h3><p>This document lists only changes that are extremely likely to cause breakage.
For higher-level guidance on how to craft proto API&rsquo;s that grow gracefully see
<a href=/programming-guides/api>API Best Practices</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-391f33cde0acfde6f33069ed48988f1d>9 - API Best Practices</h1><div class=lead>A future-proof API is surprisingly hard to get right. The suggestions in this document make trade-offs to favor long-term, bug-free evolution.</div><p>Updated for proto3. Patches welcome!</p><p>The suggestions in this document make trade-offs to favor
long-term, bug-free evolution. This doc is a complement to
<a href=/programming-guides/dos-donts>Proto Best Practices</a>.
It&rsquo;s not a prescription for Java/C++/Go and other APIs.</p><p>If you see a proto straying from these guidelines in a code review, point the
author to this topic and help spread the word.</p><div class="alert alert-note" role=alert><h4 class=alert-heading>Note</h4>These guidelines are just that and many have documented exceptions. For example,
if you&rsquo;re writing a performance-critical backend, you might want to sacrifice
flexibility or safety for speed. This
topic will help you better understand the trade-offs and make a decision that
works for your situation.</div><h2 id=precisely-concisely>Precisely, Concisely Document Most Fields and Messages</h2><p>Chances are good your proto will be inherited and used by people who don&rsquo;t know
what you were thinking when you wrote or modified it. Document each field in
terms that will be useful to a new team-member or client with little knowledge
of your system.</p><p>Some concrete examples:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Bad: Option to enable Foo
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Good: Configuration controlling the behavior of the Foo feature.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FeatureFooConfig</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: Sets whether the feature is enabled
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Good: Required field indicating whether the Foo feature
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// is enabled for account_id.  Must be false if account_id&#39;s
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// FOO_OPTIN Gaia bit is not set.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>enabled</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Bad: Foo object.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Good: Client-facing representation of a Foo (what/foo) exposed in APIs.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: Title of the foo.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Good: Indicates the user-supplied title of this Foo, with no
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// normalization or escaping.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// An example title: &#34;Picture of my cat in a box &lt;3 &lt;3 !!!&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>title</span> <span style=color:#000;font-weight:700>[(</span><span style=color:#000>max_length</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>512</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Bad: Foo config.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Less-Bad: If the most useful comment is re-stating the name, better to omit
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// the comment.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>FooConfig</span> <span style=color:#000>foo_config</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Document the constraints, expectations and interpretation of each field in as
few words as possible.</p><p>You can use custom proto annotations.
See <a href=/programming-guides/proto#options>Custom Options</a>
to define cross-language constants like <code>max_length</code> in the example above.
Supported in proto2 and proto3.</p><p>Over time, documentation of an interface can get longer and longer. The length
takes away from the clarity. When the documentation is genuinely unclear, fix it, but
look at it holistically and aim for brevity.</p><h2 id=use-different-messages>Use Different Messages for Wire and Storage</h2><p>If a top-level proto you expose to clients is the same one you store on disk,
you&rsquo;re headed for trouble. More and more binaries will depend on your API over
time, making it harder to change. You&rsquo;ll want the freedom to change your storage
format without impacting your clients. Layer your code so that modules deal
either with client protos, storage protos, or translation.</p><p>Why? You might want to swap your underlying storage system. You might want to
normalize—or denormalize—data differently. You might realize that parts of your
client-exposed proto make sense to store in RAM while other parts make sense to
go on disk.</p><p>When it comes to protos nested one or more levels within a top-level request or
response, the case for separating storage and wire protos isn&rsquo;t as strong, and
depends on how closely you&rsquo;re willing to couple your clients to those protos.</p><p>There&rsquo;s a cost in maintaining the translation layer, but it quickly pays off
once you have clients and have to do your first storage changes.</p><p>You might be tempted to share protos and diverge &ldquo;when you need to.&rdquo; With a
perceived high cost to diverge and no clear place to put internal fields, your
API will accrue fields clients either don&rsquo;t understand or begin to depend on
without your knowledge.</p><p>By starting with separate proto files, your team will know where to add internal
fields without polluting your API. In the early days, the wire proto can be
tag-for-tag identical with an automatic translation layer (think: byte copying
or proto reflection). Proto annotations can also power an automatic translation
layer.</p><p>The following are exceptions to the rule:</p><ul><li><p>If the proto field is one of a common type, such as <code>google.type</code> or
<code>google.protobuf</code>, then using that type both as storage and API is
acceptable.</p></li><li><p>If your service is extremely performance-sensitive, it may be worth trading
flexibility for execution speed. If your service
doesn&rsquo;t have millions of QPS with millisecond latency,
you&rsquo;re probably not the exception.</p></li><li><p>If all of the following are true:</p><ul><li>your service <em>is</em> the storage system</li><li>your system doesn&rsquo;t make decisions based on your clients&rsquo; structured
data</li><li>your system simply stores, loads, and perhaps provides queries at your
client&rsquo;s request</li></ul><p>Note that if you are implementing something like a logging system or a
proto-based wrapper around a generic storages system, then you probably want
to aim to have your clients&rsquo; messages transit into your storage backend as
opaquely as possible so that you don&rsquo;t create a dependency nexus. Consider
using extensions or <a href=/programming-guides/api#encode-opaque-data-in-strings>Encode Opaque Data in Strings by Web-safe Encoding
Binary Proto
Serialization</a>.</p></li></ul><h2 id=support-partial-updates>For Mutations, Support Partial Updates or Append-Only Updates, Not Full Replaces</h2><p>Don&rsquo;t make an <code>UpdateFooRequest</code> that only takes a <code>Foo</code>.</p><p>If a client doesn&rsquo;t preserve unknown fields, they will not have the newest
fields of <code>GetFooResponse</code> leading to data loss on a round-trip. Some systems
don&rsquo;t preserve unknown fields. Proto2 and proto3 implementations do preserve
unknown fields unless the application drops the unknown fields explicitly. In
general, public APIs should drop unknown fields on server-side to prevent
security attack via unknown fields. For example, garbage unknown fields may
cause a server to fail when it starts to use them as new fields in the future.</p><p>Absent documentation, handling of optional fields is ambiguous. Will <code>UpdateFoo</code>
clear the field? That leaves you open to data loss when the client doesn&rsquo;t know
about the field. Does it not touch a field? Then how can clients clear the
field? Neither are good.</p><h3 id=use-update-field-mask>Fix #1: Use an Update Field-mask</h3><p>Have your client pass which fields it wants to modify and include only those
fields in the update request. Your server leaves other fields alone and updates
only those specified by the mask.
In general, the structure of your mask should mirror the
structure of the response proto; that is, if <code>Foo</code> contains <code>Bar</code>, <code>FooMask</code>
contains <code>BarMask</code>.</p><h3 id=expose-more-narrow-mutations>Fix #2: Expose More Narrow Mutations That Change Individual Pieces</h3><p>For example, instead of <code>UpdateEmployeeRequest</code>, you might have:
<code>PromoteEmployeeRequest</code>, <code>SetEmployeePayRequest</code>, <code>TransferEmployeeRequest</code>,
etc.</p><p>Custom update methods are easier to monitor, audit, and secure than a very
flexible update method. They&rsquo;re also easier to implement and call. A <em>large</em>
number of them can increase the cognitive load of an API.</p><h2 id=dont-include-primitive-types>Don&rsquo;t Include Primitive Types in a Top-level Request or Response Proto</h2><p>Many of the pitfalls described elsewhere in this doc are solved with this rule.
For example:</p><p>Telling clients that a repeated field is unset in storage versus not-populated
in this particular call can be done by wrapping the repeated field in a message.</p><p>Common request options that are shared between requests naturally fall out of
following this rule. Read and write field masks fall out of this.</p><p>Your top-level proto should almost always be a container for other messages that
can grow independently.</p><p>Even when you only need a single primitive type today, having it wrapped in a
message gives you a clear path to expand that type and share the type among
other methods that return the similar values. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>MultiplicationResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: What if you later want to return complex numbers and have an
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// AdditionResponse that returns the same multi-field type?
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>result</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: Other methods can share this type and it can grow as your
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// service adds new features (units, confidence intervals, etc.).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>NumericResult</span> <span style=color:#000>result</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>NumericResult</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>real_value</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>complex_value</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>UnitType</span> <span style=color:#000>units</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>One exception to top-level primitives: Opaque strings (or bytes) that encode a
proto but are only built and parsed on the server. Continuation tokens, version
info tokens and IDs can all be returned as strings <em>if</em> the string is actually
an encoding of a structured proto.</p><h2 id=never-use-booleans-for-two-states>Never Use Booleans for Something That Has Two States Now, but Might Have More Later</h2><p>If you are using boolean for a field, make sure that the field is indeed
describing just two possible states (for all time, not just now and the near
future). Often, the flexibility of an enum, int, or message turns out to be
worth it.</p><p>For example, in returning a stream of posts a developer may need to indicate
whether a post should be rendered in two-columns or not based on the current
mocks from UX. Even though a boolean is all that&rsquo;s needed today, nothing
prevents UX from introducing two-row posts, three-column posts or four-square
posts in a future version.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>GooglePlusPost</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: Whether to render this post across two columns.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>big_post</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: Rendering hints for clients displaying this post.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Clients should use this to decide how prominently to render this
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// post. If absent, assume a default rendering.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>LayoutConfig</span> <span style=color:#000>layout_config</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Photo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: True if it&#39;s a GIF.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>gif</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: File format of the referenced photo (for example, GIF, WebP, PNG).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>PhotoType</span> <span style=color:#000>type</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Be cautious about adding states to an enum that
conflates concepts.</p><p>If a state introduces a new dimension to the enum or implies multiple
application behaviors, you almost certainly want another field.</p><h2 id=integer-field-for-id>Rarely Use an Integer Field for an ID</h2><p>It&rsquo;s tempting to use an int64 as an identifier for an object. Opt instead for a
string.</p><p>This lets you change your ID space if you need to and reduces the chance of
collisions. 2^64 isn&rsquo;t as big as it used to be.</p><p>You can also encode a structured identifier as a string which encourages clients
to treat it as an opaque blob. You still must have a proto backing the string,
but you can serialize the proto to a string field (encoded as web-safe Base64)
which removes any of the internal details from the client-exposed API. In this
case follow the guidelines <a href=#encode-opaque-data-in-strings>below</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>GetFooRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Which Foo to fetch.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>foo_id</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Serialized and websafe-base64-encoded into the GetFooRequest.foo_id field.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>InternalFooRef</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Only one of these two is set. Foos that have already been
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// migrated use the spanner_foo_id and Foos still living in
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Caribou Storage Server have a classic_foo_id.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bytes</span> <span style=color:#000>spanner_foo_id</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#000>classic_foo_id</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>If you start off with your own serialization scheme to represent your IDs as
strings, things can get weird quickly. That&rsquo;s why it&rsquo;s often best to start
with an internal proto that backs your string field.</p><h2 id=dont-encode-data-in-a-string>Don’t Encode Data in a String That You Expect a Client to Construct or Parse</h2><p>It&rsquo;s less efficient over the wire, more work for the consumer of the proto, and
confusing for someone reading your documentation. Your clients also have to
wonder about the encoding: Are lists comma-separated? Did I escape this
untrusted data correctly? Are numbers base-10? Better to have clients send an
actual message or primitive type. It&rsquo;s more compact over the wire and clearer
for your clients.</p><p>This gets especially bad when your service acquires clients in several
languages. Now each will have to choose the right parser or builder—or
worse—write one.</p><p>More generally, choose the right primitive type. See the Scalar Value Types
table in the
<a href=/programming-guides/proto#scalar>Protocol Buffer Language Guide</a>.</p><h3 id=returning-html>Returning HTML in a Front-End Proto</h3><p>With a JavaScript client, it&rsquo;s tempting to return HTML or
JSON in a field of your API. This is a slippery
slope towards tying your API to a specific UI. Here are three concrete dangers:</p><ul><li>A &ldquo;scrappy&rdquo; non-web client will end up parsing your HTML or JSON to get the
data they want leading to fragility if you change formats and
vulnerabilities if their parsing is bad.</li><li>Your web-client is now vulnerable to an XSS exploit if that HTML is ever
returned unsanitized.</li><li>The tags and classes you&rsquo;re returning expect a particular style-sheet and
DOM structure. From release to release, that structure will change, and you
risk a version-skew problem where the JavaScript client is older than the
server and the HTML the server returns no longer renders properly on old
clients. For projects that release often, this is not an edge case.</li></ul><p>Other than the initial page load, it&rsquo;s usually better to return data and use
client-side templating to construct HTML on the client
.</p><h2 id=encode-opaque-data-in-strings>Encode Opaque Data in Strings by Web-Safe Encoding Binary Proto Serialization</h2><p>If you do encode <em>opaque</em> data in a client-visible field (continuation tokens,
serialized IDs, version infos, and so on), document that clients should treat it
as an opaque blob. <em>Always use binary proto serialization, never text-format or
something of your own devising for these fields.</em> When you need to expand the
data encoded in an opaque field, you&rsquo;ll find yourself reinventing protocol
buffer serialization if you&rsquo;re not already using it.</p><p>Define an internal proto to hold the fields that will go in the opaque field
(even if you only need one field), serialize this internal proto to bytes then
web-safe base-64 encode the result into your string field
.</p><p>One rare exception to using proto serialization: <em>Very</em> occasionally, the
compactness wins from a carefully constructed alternative format are worth it.</p><h2 id=dont-include-fields>Don&rsquo;t Include Fields that Your Clients Can&rsquo;t Possibly Have a Use for</h2><p>The API you expose to clients should only be for describing how to interact with
your system. Including anything else in it adds cognitive overhead to someone
trying to understand it.</p><p>Returning debug data in response protos used to be a common practice, but we
have a better way. RPC response extensions (also called &ldquo;side
channels&rdquo;) let you describe your client interface with one proto and your
debugging surface with another.</p><p>Similarly, returning experiment names in response protos used to be a logging
convenience&ndash;the unwritten contract was the client would send those experiments
back on subsequent actions. The accepted way of accomplishing the same is to do
log joining in the analysis pipeline.</p><p>One exception:</p><p>If you need continuous, real-time analytics <em>and</em> are on a small machine budget,
running log joins might be prohibitive.
In cases where cost is a deciding factor,
denormalizing log data ahead of time can be a win. If you need log data
round-tripped to you, send it to clients as an opaque blob and document the
request and response fields.</p><p><strong>Caution:</strong> If you need to return or round-trip hidden data on <em>every</em> request
, you&rsquo;re hiding the true cost of using your service
and that&rsquo;s not good either.</p><h2 id=define-pagination-api><em>Rarely</em> Define a Pagination API Without a Continuation Token</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooQuery</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: If the data changes between the first query and second, each of
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// these strategies can cause you to miss results. In an eventually
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// consistent world (that is, storage backed by Bigtable), it&#39;s not uncommon
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// to have old data appear after the new data. Also, the offset- and
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// page-based approaches all assume a sort-order, taking away some
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// flexibility.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#000>max_timestamp_ms</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>result_offset</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_number</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_size</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: You&#39;ve got flexibility! Return this in a FooQueryResponse and
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// have clients pass it back on the next query.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>next_page_token</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>The best practice for a pagination API is to use an opaque continuation token
(called next_page_token ) backed by an internal proto that you
serialize and then <code>WebSafeBase64Escape</code> (C++) or <code>BaseEncoding.base64Url().encode</code> (Java). That internal proto could include many fields.
The important thing is it buys you flexibility and&ndash;if you choose&ndash;it can buy
your clients stability in the results.</p><p>Do not forget to validate the fields of this proto as untrustworthy inputs (see
note in <a href=#encode-opaque-data-in-strings>Encode opaque data in strings</a>).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>InternalPaginationToken</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Track which IDs have been seen so far. This gives perfect recall at the
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// expense of a larger continuation token--especially as the user pages
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// back.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>FooRef</span> <span style=color:#000>seen_ids</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Similar to the seen_ids strategy, but puts the seen_ids in a Bloom filter
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// to save bytes and sacrifice some precision.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bytes</span> <span style=color:#000>bloom_filter</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// A reasonable first cut and it may work for longer. Having it embedded in
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// a continuation token lets you change it later without affecting clients.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#000>max_timestamp_ms</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h2 id=group-related-fields>Group Related Fields into a New Message. Nest Only Fields with High Cohesion</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: The price and currency of this Foo.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>int</span> <span style=color:#000>price</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>CurrencyType</span> <span style=color:#000>currency</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Better: Encapsulates the price and currency of this Foo.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>CurrencyAmount</span> <span style=color:#000>price</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Only fields with high <a href=http://what/cohesion>cohesion</a> should be nested. If the
fields are genuinely related, you&rsquo;ll often want to pass them around together
inside a server. That&rsquo;s easier if they&rsquo;re defined together in a message. Think:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>CurrencyAmount</span> <span style=color:#000>calculateLocalTax</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CurrencyAmount</span> <span style=color:#000>price</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Location</span> <span style=color:#000>where</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>If your CL introduces one field, but that field might have related fields later,
preemptively put it in its own message to avoid this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// DEPRECATED! Use currency_amount.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>int</span> <span style=color:#000>price</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>deprecated</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// The price and currency of this Foo.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>google.type.Money</span> <span style=color:#000>currency_amount</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>The problem with a nested message is that while <code>CurrencyAmount</code> might be a
popular candidate for reuse in other places of your API, <code>Foo.CurrencyAmount</code>
might not. In the worst case, <code>Foo.CurrencyAmount</code> <em>is</em> reused, but
<code>Foo</code>-specific fields leak into it.</p><p>While <a href=https://en.wikipedia.org/wiki/Loose_coupling>loose coupling</a>
is generally accepted as a best practice when developing systems, that practice
may not always apply when designing <code>.proto</code> files. There may be cases in which
tightly coupling two units of information (by nesting one unit inside of the
other) may make sense. For example, if you are creating a set of fields that
appear fairly generic right now but which you anticipate adding specialized
fields into at a later time, nesting the message would dissuade others from
referencing that message from elsewhere in this or other <code>.proto</code> files.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Photo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: It&#39;s likely PhotoMetadata will be reused outside the scope of Photo,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// so it&#39;s probably a good idea not to nest it and make it easier to access.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PhotoMetadata</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>width</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>height</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>PhotoMetadata</span> <span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooConfiguration</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: Reusing FooConfiguration.Rule outside the scope of FooConfiguration
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// tightly-couples it with likely unrelated components, nesting it dissuades
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// from doing that.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Rule</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>multiplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>Rule</span> <span style=color:#000>rules</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h2 id=include-field-read-mask>Include a Field Read Mask in Read Requests</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Recommended: use google.protobuf.FieldMask
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Alternative one:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooReadMask</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>return_field1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>return_field2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Alternative two:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>BarReadMask</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Tag numbers of the fields in Bar to return.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>fields_to_return</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>If you use the recommended <code>google.protobuf.FieldMask</code>, you can use the
<code>FieldMaskUtil</code>
(<a href=/reference/java/api-docs/com/google/protobuf/util/FieldMaskUtil.html>Java</a>/<a href=/reference/cpp/api-docs/google.protobuf.util.field_mask_util.md>C++</a>)
libraries to automatically filter a proto.</p><p>Read masks set clear expectations on the client side, give them control of how
much data they want back and allow the backend to only fetch data the client
needs.</p><p>The acceptable alternative is to always populate every field; that is, treat the
request as if there were an implicit read mask with all fields set to true. This
can get costly as your proto grows.</p><p>The worst failure mode is to have an implicit (undeclared) read mask that varies
depending on which method populated the message. This anti-pattern leads to
apparent data loss on clients that build a local cache from response protos.</p><h2 id=include-version-field>Include a Version Field to Allow for Consistent Reads</h2><p>When a client does a write followed by a read of the same object, they expect to
get back what they wrote&ndash;even when the expectation isn&rsquo;t reasonable for the
underlying storage system.</p><p>Your server will read the local value and if the local version_info is less than
the expected version_info, it will read from remote replicas to find the latest
value. Typically version_info is a
<a href=#encode-opaque-data-in-strings>proto encoded as a string</a> that includes the
datacenter the mutation went to and the timestamp at which it was committed.</p><p>Even systems backed by consistent storage often want a token to trigger the more
expensive read-consistent path rather than incurring the cost on every read.</p><h2 id=use-consistent-request-options>Use Consistent Request Options for RPCs that Return the Same Data Type</h2><p>An example failure pattern is the request options for
a service in which each RPC returns the same
data type, but has separate request options for specifying things like maximum
comments, embeds supported types list, and so on.</p><p>The cost of approaching this ad hoc is increased complexity on the client from
figuring out how to fill out each request and increased complexity on the server
transforming the N request options into a common internal one. A
not-small number of real-life bugs are traceable to
this example.</p><p>Instead, create a single, separate message to hold request options and include
that in each of the top-level request messages. Here&rsquo;s a better-practices
example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooRequestOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Field-level read mask of which fields to return. Only fields that
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// were requested will be returned in the response. Clients should only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// ask for fields they need to help the backend optimize requests.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FooReadMask</span> <span style=color:#000>read_mask</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Up to this many comments will be returned on each Foo in the response.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Comments that are marked as spam don&#39;t count towards the maximum
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// comments. By default, no comments are returned.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>int</span> <span style=color:#000>max_comments_to_return</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Foos that include embeds that are not on this supported types list will
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// have the embeds down-converted to an embed specified in this list. If no
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// supported types list is specified, no embeds will be returned. If an embed
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// can&#39;t be down-converted to one of the supplied supported types, no embed
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// will be returned. Clients are strongly encouraged to always include at
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// least the THING_V2 embed type from EmbedTypes.proto.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>EmbedType</span> <span style=color:#000>embed_supported_types_list</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>GetFooRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// What Foo to read. If the viewer doesn&#39;t have access to the Foo or the
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Foo has been deleted, the response will be empty but will succeed.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>foo_id</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Clients are required to include this field. Server returns
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// INVALID_ARGUMENT if FooRequestOptions is left empty.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FooRequestOptions</span> <span style=color:#000>params</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>ListFooRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Which Foos to return. Searches have 100% recall, but more clauses
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// impact performance.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FooQuery</span> <span style=color:#000>query</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Clients are required to include this field. The server returns
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// INVALID_ARGUMENT if FooRequestOptions is left empty.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FooRequestOptions</span> <span style=color:#000>params</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h2 id=batch-multi-phase-requests>Batch/multi-phase Requests</h2><p>Where possible, make mutations atomic. Even more important, make
<a href=#prefer-idempotency>mutations idempotent</a>. A full retry of a partial failure
shouldn&rsquo;t corrupt/duplicate data.</p><p>Occasionally, you&rsquo;ll need a single RPC that encapsulates multiple operations for
performance reasons. What to do on a partial failure? If some succeeded and some
failed, it&rsquo;s best to let clients know.</p><p>Consider setting the RPC as failed and return details of both the successes and failures in an RPC status proto.</p><p>In general, you want clients who are unaware of your handling of partial
failures to still behave correctly and clients who are aware to get extra value.</p><h2 id=create-methods-manipulate-small-bits>Create Methods that Return or Manipulate Small Bits of Data and Expect Clients to Compose UIs from Batching Multiple Such Requests</h2><p>The ability to query many narrowly specified bits of data in a single round-trip
allows a wider range of UX options without server changes by letting the client
compose what they need.</p><p>This is most relevant for front-end and middle-tier servers.</p><p>Many services expose their own batching API.</p><h2 id=make-one-off-rpc>Make a One-off RPC when the Alternative is Serial Round-trips on Mobile or Web</h2><p>In cases where a <em>web or mobile</em> client needs to make two queries with a data
dependency between them, the current best practice is to create a new RPC that
protects the client from the round trip.</p><p>In the case of mobile, it&rsquo;s almost always worth saving your client the cost of
an extra round-trip by bundling the two service methods together in one new one.
For server-to-server calls, the case may not be as clear; it depends on how
performance-sensitive your service is and how much cognitive overhead the new
method introduces.</p><h2 id=repeated-fields-messages-scalar-types>Make Repeated Fields Messages, Not Scalars or Enums</h2><p>A common evolution is that a single repeated field needs to become multiple
related repeated fields. If you start with a repeated primitive your options are
limited&ndash;you either create parallel repeated fields, or define a new repeated
field with a new message that holds the values and migrate clients to it.</p><p>If you start with a repeated message, evolution becomes trivial.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Describes a type of enhancement applied to a photo
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EnhancementType</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>ENHANCEMENT_TYPE_UNSPECIFIED</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>RED_EYE_REDUCTION</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>SKIN_SOFTENING</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PhotoEnhancement</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>EnhancementType</span> <span style=color:#000>type</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PhotoEnhancementReply</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: PhotoEnhancement can grow to describe enhancements that require
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// more fields than just an enum.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>PhotoEnhancement</span> <span style=color:#000>enhancement</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: If we ever want to return parameters associated with the
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// enhancement, we&#39;d have to introduce a parallel array (terrible) or
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// deprecate this field and introduce a repeated message.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>EnhancementType</span> <span style=color:#000>enhancement_type</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Imagine the following feature request: &ldquo;We need to know which enhancements were
performed by the user and which enhancements were automatically applied by the
system.&rdquo;</p><p>If the enhancement field in <code>PhotoEnhancementReply</code> were a scalar or enum, this
would be much harder to support.</p><p>One exception:</p><p>Latency-critical applications will find parallel arrays of primitive types are
faster to construct and delete than a single array of messages; they can also be
smaller over the wire if you use
<a href=/programming-guides/encoding#packed>[packed=true]</a>
(eliding field tags). Allocating a fixed number of arrays is less work than
allocating N messages. Bonus: in
<a href=/programming-guides/proto3>Proto3</a>, packing is
automatic; you don&rsquo;t need to explicitly specify it.</p><h2 id=use-proto-maps>Use Proto Maps</h2><p>Prior to the introduction in
<a href=/programming-guides/proto3>Proto3</a> of
<a href=/programming-guides/proto3#maps>Proto3 maps</a>, services
would sometimes expose data as pairs using an ad-hoc KVPair message with scalar
fields. Eventually clients would need a deeper structure and would end up
devising keys or values that need to be parsed in some way. See
<a href=#dont-encode-data-in-a-string>Don&rsquo;t encode data in a string</a>.</p><p>So, using a (extensible) message type for the value is an immediate improvement
over the naive design.</p><p>Maps were back-ported to proto2 in all languages, so using <code>map&lt;scalar, **message**></code> is better than inventing your own KVPair for the same purpose<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>If you want to represent <em>arbitrary</em> data whose structure you don&rsquo;t know ahead
of time, use
<a href=/reference/protobuf/textformat-spec#any><code>google.protobuf.Any</code></a>.</p><h2 id=prefer-idempotency>Prefer Idempotency</h2><p>Somewhere in the stack above you, a client may have retry logic. If the retry is
a mutation, the user could be in for a surprise. Duplicate comments, build
requests, edits, and so on aren&rsquo;t good for anyone.</p><p>A simple way to avoid duplicate writes is to allow clients to specify a
client-created request ID that your server dedupes on (for example, hash of
content or UUID).</p><h2 id=service-name-globally-unique>Be Mindful of Your Service Name, and Make it Globally Unique</h2><p>A service name (that is, the part after the <code>service</code> keyword in your <code>.proto</code>
file) is used in surprisingly many places, not just to generate the service
class name. This makes this name more
important than one might think.</p><p>What&rsquo;s tricky is that these tools make the implicit assumption that your service
name is unique across a network . Worse, the service name they use is the
<em>unqualified</em> service name (for example, <code>MyService</code>), not the qualified service
name (for example, <code>my_package.MyService</code>).</p><p>For this reason, it makes sense to take steps to prevent naming conflicts on
your service name, even if it is defined inside a specific package. For example,
a service named <code>Watcher</code> is likely to cause problems; something like
<code>MyProjectWatcher</code> would be better.</p><h2 id=every-rpc-deadline>Ensure Every RPC Specifies and Enforces a (Permissive) Deadline</h2><p>By default, an RPC does not have a timeout. Since a request may tie up backend
resources that are only released on completion, setting a default deadline that
allows all well-behaving requests to finish is a good defensive practice. Not
enforcing one has in the past caused
severe problems for major services . RPC clients
should still set a deadline on outgoing RPCs and will typically do so by default
when they use standard frameworks. A deadline may and typically will be
overwritten by a shorter deadline attached to a request.</p><p>Setting the <code>deadline</code> option clearly communicates the RPC
deadline to your clients, and is respected and enforced by standard frameworks:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>Foo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>FooRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>FooResponse</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#000;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// there is no globally good default
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Choosing a deadline value will especially impact how your system acts under
load. For existing services, it is critical to evaluate existing client behavior
before enforcing new deadlines to avoid breaking clients (consult SRE). In some
cases, it may not be possible to enforce a shorter deadline after the fact.</p><h2 id=bound-req-res-sizes>Bound Request and Response Sizes</h2><p>Request and response sizes should be bounded.
We recommend a bound in the ballpark of 8 MiB, and 2
GiB is a hard limit at which many proto implementations break
. Many storage systems have a limit
on message sizes .</p><p>Also, unbounded messages</p><ul><li>bloat both client and server,</li><li>cause high and unpredictable latency,</li><li>decrease resiliency by relying on a long-lived connection between a single
client and a single server.</li></ul><p>Here are a few ways to bound all messages in an API:</p><ul><li>Define RPCs that return bounded messages, where each RPC call is logically
independent from the others.</li><li>Define RPCs that operate on a single object, instead of on an unbounded,
client-specified list of objects.</li><li>Avoid encoding unbounded data in string, byte, or repeated fields.</li><li>Define a long-running operation . Store the result in a
storage system designed for scalable, concurrent reads
.</li><li>Use a pagination API (see
<a href=#define-pagination-api>Rarely define a pagination API without a continuation token</a>).</li><li>Use streaming RPCs.</li></ul><p>If you are working on a UI, see also
<a href=#create-methods-manipulate-small-bits>Create methods that return or manipulate small bits of data</a>.</p><h2 id=propagate-status-codes>Propagate Status Codes Carefully</h2><p>RPC services should take care at RPC boundaries to interrogate errors, and
return meaningful status errors to their callers.</p><p>Let&rsquo;s examine a toy example to illustrate the point:</p><p>Consider a client that calls <code>ProductService.GetProducts</code>, which takes no
arguments. As part of <code>GetProducts</code>, <code>ProductService</code> might get all the
products, and call <code>LocaleService.LocaliseNutritionFacts</code> for each product.</p><pre tabindex=0><code class=language-dot data-lang=dot>digraph toy_example {
  node [style=filled]
  client [label=&#34;Client&#34;];
  product [label=&#34;ProductService&#34;];
  locale [label=&#34;LocaleService&#34;];
  client -&gt; product [label=&#34;GetProducts&#34;]
  product -&gt; locale [label=&#34;LocaliseNutritionFacts&#34;]
}
</code></pre><p>If <code>ProductService</code> is incorrectly implemented, it might send the wrong
arguments to <code>LocaleService</code>, resulting in an <code>INVALID_ARGUMENT</code>.</p><p>If <code>ProductService</code> carelessly returns errors to its callers, the client will
receive <code>INVALID_ARGUMENT</code>, since status codes propagate across RPC boundaries.
But, the client didn&rsquo;t pass any arguments to <code>ProductService.GetProducts</code>. So,
the error is worse than useless: it will cause a great deal of confusion!</p><p>Instead, <code>ProductService</code> should interrogate errors it receives at the RPC
boundary; that is, the <code>ProductService</code> RPC handler it implements. It should
return meaningful errors to users: if <em>it received</em> invalid arguments from the
caller, it should return <code>INVALID_ARGUMENT</code>. If <em>something downstream</em> received
invalid arguments, it should convert the <code>INVALID_ARGUMENT</code> to <code>INTERNAL</code> before
returning the error to the caller.</p><p>Carelessly propagating status errors leads to confusion, which can be very
expensive to debug. Worse, it can lead to an invisible outage where every
service forwards a client error without causing
any alerts to happen .</p><p>The general rule is: at RPC boundaries, take care to interrogate errors, and
return meaningful status errors to callers, with appropriate status codes. To
convey meaning, each RPC method should document what error codes it returns in
which circumstances. The implementation of each method should conform to the
documented API contract.</p><h2 id=appendix>Appendix</h2><h3 id=returning-repeated-fields>Returning Repeated Fields</h3><p>When a repeated field is empty, the client can&rsquo;t tell if the field just wasn&rsquo;t
populated by the server or if the backing data for the field is genuinely empty.
In other words, there&rsquo;s no <code>hasFoo</code> method for repeated fields.</p><p>Wrapping a repeated field in a message is an easy way to get a hasFoo method.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooList</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>Foo</span> <span style=color:#000>foos</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>The more holistic way to solve it is with a field
<a href=#include-field-read-mask>read mask</a>. If the field was requested, an empty list
means there&rsquo;s no data. If the field wasn&rsquo;t requested the client should ignore
the field in the response.</p><h3 id=updating-repeated-fields>Updating Repeated Fields</h3><p>The worst way to update a repeated field is to force the client to supply a
replacement list. The dangers with forcing the client to supply the entire array
are manyfold. Clients that don&rsquo;t preserve unknown fields cause data loss.
Concurrent writes cause data loss. Even if those problems don&rsquo;t apply, your
clients will need to carefully read your documentation to know how the field is
interpreted on the server side. Does an empty field mean the server won&rsquo;t update
it, or that the server will clear it?</p><p><strong>Fix #1</strong>: Use a repeated update mask that permits the client to replace,
delete, or insert elements into the array without supplying the entire array on
a write.</p><p><strong>Fix #2</strong>: Create separate append, replace, delete arrays in the
request proto.</p><p><strong>Fix #3</strong>: Allow only appending or clearing. You can do this by wrapping the
repeated field in a message. A present, but empty, message means clear,
otherwise, any repeated elements mean append.</p><h3 id=order-independence-repeated-fields>Order Independence in Repeated Fields</h3><p><em>Try</em> to avoid order dependence in general. It&rsquo;s an extra layer of fragility. An
especially bad type of order dependence is parallel arrays. Parallel arrays make
it more difficult for clients to interpret the results and make it unnatural to
pass the two related fields around inside your own service.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>BatchEquationSolverResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: Solved values are returned in the order of the equations given in
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// the request.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>solved_value</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// (Usually) Bad: Parallel array for solved_value.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>solved_complex_value</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Good: A separate message that can grow to include more fields and be
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// shared among other methods. No order dependence between request and
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// response, no order dependence between multiple repeated fields.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>BatchEquationSolverResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Deprecated, this will continue to be populated in responses until Q2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// 2014, after which clients must move to using the solutions field below.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>solved_value</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>deprecated</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: Each equation in the request has a unique identifier that&#39;s
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// included in the EquationSolution below so that the solutions can be
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// correlated with the equations themselves. Equations are solved in
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// parallel and as the solutions are made they are added to this array.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>EquationSolution</span> <span style=color:#000>solutions</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h3 id=leaking-features>Leaking Features Because Your Proto is in a Mobile Build</h3><p>Android and iOS runtimes both support reflection. To do that, the unfiltered
names of fields and messages are embedded in the application binary
(APK, IPA) as strings.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// This will leak existence of Google Teleport project on Android and iOS
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FeatureStatus</span> <span style=color:#000>google_teleport_enabled</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Several mitigation strategies:</p><ul><li>ProGuard obfuscation on Android. As of Q3 2014. iOS has no obfuscation
option: once you have the IPA on a desktop, piping it through <code>strings</code> will
reveal field names of included protos.
<a href=https://github.com/Bensge/Chrome-for-iOS-Headers>iOS Chrome tear-down</a></li><li>Curate precisely which fields are sent to mobile clients
.</li><li>If plugging the leak isn&rsquo;t feasible on an acceptable timescale, get buy-in
from the feature owner to risk it.</li></ul><p><em>Never</em> use this as an excuse to obfuscate the meaning of a field with a
code-name. Either plug the leak or get buy-in to risk it.</p><h3 id=performance-optimizations>Performance Optimizations</h3><p>You can trade type safety or clarity for performance wins in some cases. For
example, a proto with hundreds of fields&ndash;particularly message-type fields&ndash;is
going to be slower to parse than one with fewer fields. A very deeply-nested
message can be slow to deserialize just from the memory management. A handful of
techniques teams have used to speed deserialization:</p><ul><li>Create a parallel, trimmed proto that mirrors the larger proto but has only
some of the tags declared. Use this for parsing when you don&rsquo;t need all the
fields. Add tests to enforce that tag numbers continue to match as the
trimmed proto accumulates numbering &ldquo;holes.&rdquo;</li><li>Annotate the fields as &ldquo;lazily parsed&rdquo; with
<a href=https://github.com/protocolbuffers/protobuf/blob/cacb096002994000f8ccc6d9b8e1b5b0783ee561/src/google/protobuf/descriptor.proto#L609>[lazy=true]</a>.</li><li>Declare a field as bytes and document its type. Clients who care to parse
the field can do so manually. The danger with this approach is there&rsquo;s
nothing preventing someone from putting a message of the wrong type in the
bytes field. You should never do this with a proto that&rsquo;s written to any
logs, as it prevents the proto from being vetted for PII or scrubbed for
policy or privacy reasons.</li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>A gotcha with protos that contain <code>map&lt;k,v></code> fields. Don&rsquo;t use them as
reduce keys in a MapReduce. The wire format and iteration order of proto3
map items are <em>unspecified</em> which leads to inconsistent map shards.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel=noopener href=https://stackoverflow.com/questions/tagged/protocol-buffers aria-label="Stack Overflow"><i class="fab fa-stack-overflow"></i></a></li></ul><script type=text/javascript id=cookiebanner src=https://cdn.jsdelivr.net/gh/dobarkod/cookie-banner@1.2.2/dist/cookiebanner.min.js data-height=40px data-message="Protobuf.dev uses cookies from Google to deliver and enhance the quality of its services and to analyze traffic." data-bg=#fff data-fg=#000 data-position=bottom data-padding=16px data-close-text="OK, got it" data-font-size=18px data-moreinfo=https://policies.google.com/technologies/cookies></script></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/protocolbuffers/protobuf aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/protobuf aria-label="Developer mailing list"><i class="fa fa-envelope"></i></a></li></ul><script type=text/javascript id=cookiebanner src=https://cdn.jsdelivr.net/gh/dobarkod/cookie-banner@1.2.2/dist/cookiebanner.min.js data-height=40px data-message="Protobuf.dev uses cookies from Google to deliver and enhance the quality of its services and to analyze traffic." data-bg=#fff data-fg=#000 data-position=bottom data-padding=16px data-close-text="OK, got it" data-font-size=18px data-moreinfo=https://policies.google.com/technologies/cookies></script></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 Google LLC All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></small>
<span class=text-white>Hosted by GitHub Pages.</span> <a href=https://docs.github.com/en/site-policy/privacy-policies/github-privacy-statement target=_blank>GitHub Privacy Statement</a></div></div></div></footer></div><script src=/js/main.min.48a7d138dd257f31c8ab8ac8a2922a6911189eae9f353439163ad3316421ea99.js integrity="sha256-SKfRON0lfzHIq4rIopIqaREYnq6fNTQ5FjrTMWQh6pk=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>